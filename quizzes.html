<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Training Quizzes</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #f4f6f8; margin: 0; padding: 20px; color: #333; }
        .container { max-width: 800px; margin: 0 auto; }

        /* Navigation Menu */
        .nav-bar { position: relative; display: flex; justify-content: center; align-items: center; margin-bottom: 40px; padding: 10px 0; }
        .nav-center { display: flex; gap: 20px; }
        .nav-link { text-decoration: none; color: #4b5563; font-weight: 600; padding: 8px 16px; border-radius: 6px; font-size: 16px; transition: 0.2s; }
        .nav-link:hover { background-color: #e5e7eb; color: #111827; }
        .nav-link.active { background-color: #2ecc71; color: white; }
        .supervisor-link { position: absolute; right: 0; top: 50%; transform: translateY(-50%); text-decoration: none; color: #2c3e50; font-size: 0.9rem; font-weight: 600; border: 1px solid #d1d5db; padding: 6px 12px; border-radius: 4px; background: white; transition: all 0.2s; }
        .supervisor-link:hover { background: #f3f4f6; border-color: #9ca3af; }
        
        @media (max-width: 800px) {
            .nav-bar { flex-direction: column; gap: 15px; }
            .supervisor-link { position: static; transform: none; margin-left: auto; }
            .nav-center { flex-wrap: wrap; justify-content: center; }
        }

        /* --- Page Styles --- */
        .hidden { display: none; }
        .card { background: white; border-radius: 12px; padding: 30px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 20px; text-align: center;}
        
        .btn-primary { background: #2ecc71; color: white; border: none; padding: 12px 24px; border-radius: 6px; font-weight: bold; cursor: pointer; font-size: 1rem; width: 100%; }
        .btn-primary:hover { background: #27ae60; }
        
        .input-field { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 6px; font-size: 1rem; box-sizing: border-box; margin-bottom: 15px; }

        /* Quiz List Items */
        .quiz-list-item { 
            padding: 15px; border: 1px solid #e5e7eb; border-radius: 8px; margin-bottom: 10px; cursor: pointer; transition: 0.2s; 
            display: flex; justify-content: space-between; align-items: center; text-align: left;
        }
        .quiz-list-item:hover { border-color: #2ecc71; background: #f0fdf4; }
        
        .quiz-info { display: flex; flex-direction: column; }
        .quiz-title { font-weight: bold; font-size: 1.1rem; color: #2c3e50; }
        .quiz-meta { font-size: 0.85rem; color: #666; margin-top: 4px; }
        
        .score-badge { font-size: 0.9rem; font-weight: bold; padding: 5px 10px; border-radius: 20px; background: #eee; color: #777; }
        .score-badge.good { background: #dcfce7; color: #166534; }
        
        /* Questions */
        .question-block { margin-bottom: 40px; border-bottom: 1px solid #eee; padding-bottom: 30px; text-align: left; }
        .q-text { font-size: 1.2rem; font-weight: 700; margin-bottom: 15px; }
        
        /* Video */
        .video-wrapper { position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; max-width: 100%; border-radius: 8px; background: #000; margin-bottom: 8px; }
        .video-wrapper iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 0; }
        .backup-link { display: inline-block; font-size: 0.85rem; color: #666; text-decoration: underline; margin-bottom: 15px; }
        
        .option-btn { display: block; width: 100%; text-align: left; padding: 12px 15px; margin-bottom: 8px; background: white; border: 2px solid #e5e7eb; border-radius: 8px; cursor: pointer; font-size: 1rem; }
        .option-btn:hover { background-color: #f9fafb; border-color: #d1d5db; }
        .option-btn.correct { background-color: #dcfce7; border-color: #22c55e; color: #15803d; }
        .option-btn.wrong { background-color: #fee2e2; border-color: #ef4444; color: #b91c1c; opacity: 0.7; }
        .explanation { margin-top: 10px; padding: 10px; background: #eff6ff; border-radius: 6px; color: #1e40af; font-size: 0.9rem; display: none; text-align: left;}
    </style>
</head>
<body>

    <div class="container">
        <div class="nav-bar">
            <div class="nav-center">
                <a href="index.html" class="nav-link">Home</a>
                <a href="report.html" class="nav-link">CMI Form</a>
                <a href="jersey.html" class="nav-link">Kit Search</a>
                <span class="nav-link active">Training Quizzes</span>
            </div>
            <a href="admin.html" class="supervisor-link">ðŸ”’ Supervisors</a>
        </div>

        <div id="login-view" class="card">
            <h2>Referee Login</h2>
            <p style="color:#666; margin-bottom:20px;">Enter your email to view your assigned training modules.</p>
            <input type="email" id="loginEmail" class="input-field" placeholder="yourname@email.com">
            <button class="btn-primary" onclick="handleLogin()">Access Quizzes</button>
            <p id="login-msg" style="color:red; margin-top:10px; display:none;"></p>
        </div>

        <div id="selection-view" class="hidden">
            <h2 id="welcome-header" style="text-align:center;">Available Quizzes</h2>
            <p style="text-align:center; color:#666; margin-bottom:30px;">Select a topic to begin.</p>
            <div id="quiz-list-container"></div>
            <button onclick="location.reload()" style="margin-top:20px; background:none; border:none; color:#999; cursor:pointer;">Logout</button>
        </div>

        <div id="intro-view" class="card hidden">
            <h2 id="intro-title">Quiz Title</h2>
            <p style="color:#666;">Confirm your details to begin.</p>
            <input type="text" id="firstName" class="input-field" readonly style="background:#f9f9f9; color:#666;">
            <input type="text" id="lastName" class="input-field" readonly style="background:#f9f9f9; color:#666;">
            <input type="email" id="userEmail" class="input-field" readonly style="background:#f9f9f9; color:#666;">
            <button class="btn-primary" onclick="startQuiz()">Start Quiz</button>
            <br>
            <button onclick="document.getElementById('intro-view').classList.add('hidden'); document.getElementById('selection-view').classList.remove('hidden');" style="background:none; border:none; color:#666; margin-top:15px; cursor:pointer;">Back</button>
        </div>

        <div id="quiz-view" class="card hidden">
            <h2 id="active-quiz-title" style="border-bottom:2px solid #2ecc71; padding-bottom:10px; margin-bottom:20px;"></h2>
            <div id="questions-container"></div>
            <button id="finishBtn" class="btn-primary" onclick="submitQuiz()">Submit Results</button>
        </div>

        <div id="result-view" class="card hidden">
            <h1>Quiz Complete!</h1>
            <div style="font-size:3rem; font-weight:800; color:#2ecc71; margin:20px 0;" id="score-display">0%</div>
            <p id="score-detail">You got X out of Y correct.</p>
            <button class="btn-primary" onclick="location.reload()">Return to Login</button>
        </div>
    </div>

    <script>
        // Use the CMI/Admin Script URL because we merged the functionality
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzi1gJkccUwLsjwPcepY_g9JY6nkLwcOxAn2dAEIw3YNQdWLuBl2lQYf6sOIM2WsRi3Cg/exec";

        let allQuizzes = {};
        let userScores = {}; 
        let currentQuizData = [];
        let currentQuizName = "";
        let score = 0;
        let currentUser = {};

        function handleLogin() {
            const email = document.getElementById('loginEmail').value.trim();
            if (!email) { alert("Please enter an email."); return; }
            const btn = document.querySelector('#login-view button');
            const msg = document.getElementById('login-msg');
            btn.innerText = "Verifying..."; btn.disabled = true; msg.style.display = 'none';

            fetch(`${SCRIPT_URL}?action=getQuizData&email=${encodeURIComponent(email)}`)
                .then(res => res.json())
                .then(data => {
                    if (data.error) {
                        msg.innerText = data.error; msg.style.display = 'block';
                        btn.innerText = "Access Quizzes"; btn.disabled = false; return;
                    }
                    allQuizzes = data.quizzes;
                    userScores = data.scores || {}; 
                    currentUser = data.user || { firstName: "", lastName: "", email: email }; 
                    document.getElementById('userEmail').value = email;
                    document.getElementById('firstName').value = currentUser.firstName;
                    document.getElementById('lastName').value = currentUser.lastName;
                    if (currentUser.firstName) document.getElementById('welcome-header').innerText = `Welcome, ${currentUser.firstName}`;
                    renderQuizList();
                    document.getElementById('login-view').classList.add('hidden');
                    document.getElementById('selection-view').classList.remove('hidden');
                })
                .catch(err => {
                    console.error(err);
                    msg.innerText = "Connection failed."; msg.style.display = 'block';
                    btn.innerText = "Access Quizzes"; btn.disabled = false;
                });
        }

        function renderQuizList() {
            const container = document.getElementById('quiz-list-container');
            container.innerHTML = '';
            const titles = Object.keys(allQuizzes);
            if (titles.length === 0) { container.innerHTML = "<p style='text-align:center'>No quizzes assigned to your group.</p>"; return; }

            titles.forEach(title => {
                const count = allQuizzes[title].length;
                const highScore = userScores[title]; 
                let badgeHtml = highScore !== undefined ? `<span class="score-badge good">Best: ${highScore}%</span>` : "";
                const div = document.createElement('div');
                div.className = 'quiz-list-item';
                div.innerHTML = `<div class="quiz-info"><span class="quiz-title">${title}</span><span class="quiz-meta">${count} Questions</span></div>${badgeHtml}`;
                div.onclick = () => showIntro(title);
                container.appendChild(div);
            });
        }

        function showIntro(title) {
            currentQuizName = title;
            currentQuizData = allQuizzes[title];
            document.getElementById('selection-view').classList.add('hidden');
            document.getElementById('intro-view').classList.remove('hidden');
            document.getElementById('intro-title').innerText = title;
        }

        function startQuiz() {
            document.getElementById('intro-view').classList.add('hidden');
            document.getElementById('quiz-view').classList.remove('hidden');
            document.getElementById('active-quiz-title').innerText = currentQuizName;
            renderQuestions();
        }

        // --- Video Logic ---
        function getVideoHtml(url) {
            if (!url || url.length < 5) return "";
            url = url.trim();
            let embed = "";
            
            const ytMatch = url.match(/(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/i);
            if (ytMatch && ytMatch[1]) {
                embed = `<div class="video-wrapper"><iframe src="https://www.youtube.com/embed/${ytMatch[1]}" frameborder="0" allowfullscreen></iframe></div>`;
            } else {
                const vimeoMatch = url.match(/(?:vimeo\.com\/|player\.vimeo\.com\/video\/)([0-9]+)/);
                if (vimeoMatch && vimeoMatch[1]) {
                    embed = `<div class="video-wrapper"><iframe src="https://player.vimeo.com/video/${vimeoMatch[1]}" frameborder="0" allowfullscreen></iframe></div>`;
                }
            }
            
            return `${embed}<a href="${url}" target="_blank" class="backup-link">Open Video in New Tab (if player fails)</a>`;
        }

        function renderQuestions() {
            const container = document.getElementById('questions-container');
            container.innerHTML = '';

            currentQuizData.forEach((q, index) => {
                const qDiv = document.createElement('div');
                qDiv.className = 'question-block';
                qDiv.id = `q-block-${index}`;

                // 1. Title
                const title = document.createElement('div');
                title.className = 'q-text';
                title.innerText = `${index + 1}. ${q.question}`;
                qDiv.appendChild(title);

                // 2. Video
                if(q.video) {
                    const vidDiv = document.createElement('div');
                    vidDiv.innerHTML = getVideoHtml(q.video);
                    qDiv.appendChild(vidDiv);
                }

                // 3. Options
                const optsDiv = document.createElement('div');
                optsDiv.className = 'options-group';
                
                q.options.forEach(optText => {
                    const btn = document.createElement('button');
                    btn.className = 'option-btn';
                    btn.innerText = optText;
                    btn.onclick = function() { checkAnswer(index, optText, btn); };
                    optsDiv.appendChild(btn);
                });
                qDiv.appendChild(optsDiv);

                // 4. Explanation
                const expDiv = document.createElement('div');
                expDiv.className = 'explanation';
                expDiv.id = `explain-${index}`;
                expDiv.innerHTML = `<strong>Note:</strong> ${q.explanation || ""}`;
                qDiv.appendChild(expDiv);

                container.appendChild(qDiv);
            });
        }

        function checkAnswer(index, selectedText, btnElement) {
            const questionData = currentQuizData[index];
            const parent = document.getElementById(`q-block-${index}`);
            
            if(parent.getAttribute('data-answered') === 'true') return;
            parent.setAttribute('data-answered', 'true');

            const isCorrect = (selectedText.trim() === questionData.answer.trim());
            
            if(isCorrect) {
                btnElement.classList.add('correct');
                score++;
            } else {
                btnElement.classList.add('wrong');
                const allBtns = parent.querySelectorAll('.option-btn');
                allBtns.forEach(b => {
                    if(b.innerText.trim() === questionData.answer.trim()) b.classList.add('correct');
                });
            }

            if(questionData.explanation) {
                document.getElementById(`explain-${index}`).style.display = 'block';
            }
        }

        function submitQuiz() {
            const total = currentQuizData.length;
            const answered = document.querySelectorAll('[data-answered="true"]').length;
            
            if(answered < total) {
                if(!confirm(`You have only answered ${answered} of ${total} questions. Submit anyway?`)) return;
            }

            const percentage = Math.round((score / total) * 100);
            document.getElementById('quiz-view').classList.add('hidden');
            document.getElementById('result-view').classList.remove('hidden');
            document.getElementById('score-display').innerText = `${percentage}%`;
            document.getElementById('score-detail').innerText = `You got ${score} out of ${total} correct.`;

            const payload = {
                type: 'quiz_result',
                firstName: document.getElementById('firstName').value,
                lastName: document.getElementById('lastName').value,
                email: document.getElementById('userEmail').value,
                quizName: currentQuizName,
                score: `${score}/${total}`,
                percent: `${percentage}%`
            };

            fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) });
        }
    </script>
</body>
</html>
