<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Training Quizzes</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #f4f6f8; margin: 0; padding: 20px; color: #333; }
        .container { max-width: 800px; margin: 0 auto; }

        /* Nav */
        .nav-bar { display: flex; justify-content: center; gap: 20px; margin-bottom: 40px; }
        .nav-link { text-decoration: none; color: #4b5563; font-weight: 600; padding: 8px 16px; border-radius: 6px; font-size: 16px; transition: 0.2s; }
        .nav-link:hover { background-color: #e5e7eb; color: #111827; }
        .nav-link.active { background-color: #2ecc71; color: white; }

        .hidden { display: none; }
        .card { background: white; border-radius: 12px; padding: 30px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 20px; text-align: center;}
        
        .btn-primary { background: #2ecc71; color: white; border: none; padding: 12px 24px; border-radius: 6px; font-weight: bold; cursor: pointer; font-size: 1rem; width: 100%; }
        .btn-primary:hover { background: #27ae60; }
        
        .input-field { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 6px; font-size: 1rem; box-sizing: border-box; margin-bottom: 15px; }

        /* Quiz List */
        .quiz-list-item { 
            padding: 15px; border: 1px solid #e5e7eb; border-radius: 8px; margin-bottom: 10px; cursor: pointer; transition: 0.2s; 
            display: flex; justify-content: space-between; align-items: center; text-align: left;
        }
        .quiz-list-item:hover { border-color: #2ecc71; background: #f0fdf4; }
        .quiz-title { font-weight: bold; font-size: 1.1rem; }
        .quiz-count { font-size: 0.85rem; color: #6b7280; background: #f3f4f6; padding: 4px 8px; border-radius: 12px; }

        /* Questions */
        .question-block { margin-bottom: 40px; border-bottom: 1px solid #eee; padding-bottom: 30px; text-align: left; }
        .q-text { font-size: 1.2rem; font-weight: 700; margin-bottom: 15px; }
        .video-wrapper { position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; max-width: 100%; border-radius: 8px; background: #000; margin-bottom: 15px; }
        .video-wrapper iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 0; }
        .option-btn { display: block; width: 100%; text-align: left; padding: 12px 15px; margin-bottom: 8px; background: white; border: 2px solid #e5e7eb; border-radius: 8px; cursor: pointer; font-size: 1rem; }
        .option-btn:hover { background-color: #f9fafb; border-color: #d1d5db; }
        .option-btn.correct { background-color: #dcfce7; border-color: #22c55e; color: #15803d; }
        .option-btn.wrong { background-color: #fee2e2; border-color: #ef4444; color: #b91c1c; opacity: 0.7; }
        .explanation { margin-top: 10px; padding: 10px; background: #eff6ff; border-radius: 6px; color: #1e40af; font-size: 0.9rem; display: none; text-align: left;}

        @media (max-width: 600px) { .nav-bar { flex-wrap: wrap; gap: 10px; } }
    </style>
</head>
<body>

    <div class="container">
        <div class="nav-bar">
            <a href="index.html" class="nav-link">Home</a>
            <a href="report.html" class="nav-link">CMI Form</a>
            <a href="jersey.html" class="nav-link">Kit Search</a>
            <span class="nav-link active">Training Quizzes</span>
            <a href="admin.html" class="nav-link">Admin Portal</a>
        </div>

        <div id="login-view" class="card">
            <h2>Referee Login</h2>
            <p style="color:#666; margin-bottom:20px;">Enter your email to view your assigned training modules.</p>
            <input type="email" id="loginEmail" class="input-field" placeholder="yourname@email.com">
            <button class="btn-primary" onclick="handleLogin()">Access Quizzes</button>
            <p id="login-msg" style="color:red; margin-top:10px; display:none;"></p>
        </div>

        <div id="selection-view" class="hidden">
            <h2 id="welcome-header" style="text-align:center;">Available Quizzes</h2>
            <p style="text-align:center; color:#666; margin-bottom:30px;">Select a topic to begin.</p>
            <div id="quiz-list-container"></div>
            <button onclick="location.reload()" style="margin-top:20px; background:none; border:none; color:#999; cursor:pointer;">Logout</button>
        </div>

        <div id="intro-view" class="card hidden">
            <h2 id="intro-title">Quiz Title</h2>
            <p style="color:#666;">Confirm your details to begin.</p>
            
            <input type="text" id="firstName" class="input-field" readonly style="background:#f9f9f9; color:#666;">
            <input type="text" id="lastName" class="input-field" readonly style="background:#f9f9f9; color:#666;">
            <input type="email" id="userEmail" class="input-field" readonly style="background:#f9f9f9; color:#666;">

            <button class="btn-primary" onclick="startQuiz()">Start Quiz</button>
            <br>
            <button onclick="document.getElementById('intro-view').classList.add('hidden'); document.getElementById('selection-view').classList.remove('hidden');" style="background:none; border:none; color:#666; margin-top:15px; cursor:pointer;">Back</button>
        </div>

        <div id="quiz-view" class="card hidden">
            <h2 id="active-quiz-title" style="border-bottom:2px solid #2ecc71; padding-bottom:10px; margin-bottom:20px;"></h2>
            <div id="questions-container"></div>
            <button id="finishBtn" class="btn-primary" onclick="submitQuiz()">Submit Results</button>
        </div>

        <div id="result-view" class="card hidden">
            <h1>Quiz Complete!</h1>
            <div style="font-size:3rem; font-weight:800; color:#2ecc71; margin:20px 0;" id="score-display">0%</div>
            <p id="score-detail">You got X out of Y correct.</p>
            <button class="btn-primary" onclick="location.reload()">Return to Login</button>
        </div>
    </div>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyCKkdHudV8CA1hcdV_KN2KEyOeZ5nmaQ_5-fWO40BPpIZwjMO1z3F4lalyP3wMYRf7lQ/exec";

        let allQuizzes = {};
        let currentQuizData = [];
        let currentQuizName = "";
        let score = 0;
        let currentUser = {};

        function handleLogin() {
            const email = document.getElementById('loginEmail').value.trim();
            if (!email) { alert("Please enter an email."); return; }

            const btn = document.querySelector('#login-view button');
            const msg = document.getElementById('login-msg');
            
            btn.innerText = "Verifying...";
            btn.disabled = true;
            msg.style.display = 'none';

            fetch(`${SCRIPT_URL}?action=getQuizData&email=${encodeURIComponent(email)}`)
                .then(res => res.json())
                .then(data => {
                    if (data.error) {
                        msg.innerText = data.error;
                        msg.style.display = 'block';
                        btn.innerText = "Access Quizzes";
                        btn.disabled = false;
                        return;
                    }

                    // Success
                    allQuizzes = data.quizzes;
                    currentUser = data.user || { firstName: "", lastName: "", email: email }; // Fallback if not in roster
                    
                    // Populate hidden fields for later
                    document.getElementById('userEmail').value = email;
                    document.getElementById('firstName').value = currentUser.firstName;
                    document.getElementById('lastName').value = currentUser.lastName;

                    if (currentUser.firstName) {
                        document.getElementById('welcome-header').innerText = `Welcome, ${currentUser.firstName}`;
                    }

                    renderQuizList();
                    
                    document.getElementById('login-view').classList.add('hidden');
                    document.getElementById('selection-view').classList.remove('hidden');
                })
                .catch(err => {
                    console.error(err);
                    msg.innerText = "Connection failed.";
                    msg.style.display = 'block';
                    btn.innerText = "Access Quizzes";
                    btn.disabled = false;
                });
        }

        function renderQuizList() {
            const container = document.getElementById('quiz-list-container');
            container.innerHTML = '';
            
            const titles = Object.keys(allQuizzes);
            if (titles.length === 0) {
                container.innerHTML = "<p style='text-align:center'>No quizzes assigned to your group.</p>";
                return;
            }

            titles.forEach(title => {
                const count = allQuizzes[title].length;
                const div = document.createElement('div');
                div.className = 'quiz-list-item';
                div.innerHTML = `
                    <span class="quiz-title">${title}</span>
                    <span class="quiz-count">${count} Questions</span>
                `;
                div.onclick = () => showIntro(title);
                container.appendChild(div);
            });
        }

        function showIntro(title) {
            currentQuizName = title;
            currentQuizData = allQuizzes[title];
            document.getElementById('selection-view').classList.add('hidden');
            document.getElementById('intro-view').classList.remove('hidden');
            document.getElementById('intro-title').innerText = title;
        }

        function startQuiz() {
            document.getElementById('intro-view').classList.add('hidden');
            document.getElementById('quiz-view').classList.remove('hidden');
            document.getElementById('active-quiz-title').innerText = currentQuizName;
            renderQuestions();
        }

        function getEmbedHtml(url) {
            if (!url || url.length < 5) return "";
            const ytMatch = url.match(/(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/i);
            if (ytMatch && ytMatch[1]) return `<div class="video-wrapper"><iframe src="https://www.youtube.com/embed/${ytMatch[1]}" frameborder="0" allowfullscreen></iframe></div>`;
            const vimeoMatch = url.match(/(?:vimeo\.com\/)(\d+)/i);
            if (vimeoMatch && vimeoMatch[1]) return `<div class="video-wrapper"><iframe src="https://player.vimeo.com/video/${vimeoMatch[1]}" frameborder="0" allowfullscreen></iframe></div>`;
            return `<div class="video-container"><a href="${url}" target="_blank" style="color:#2ecc71; font-weight:bold; text-decoration:none;">â–¶ Watch Video Clip (External Link)</a></div>`;
        }

        function renderQuestions() {
            const container = document.getElementById('questions-container');
            container.innerHTML = '';

            currentQuizData.forEach((q, index) => {
                const qDiv = document.createElement('div');
                qDiv.className = 'question-block';
                qDiv.id = `q-block-${index}`;
                const videoHtml = getEmbedHtml(q.video);

                let optionsHtml = '';
                q.options.forEach(opt => {
                    const safeOpt = opt.replace(/'/g, "\\'");
                    optionsHtml += `<button class="option-btn" onclick="checkAnswer(${index}, '${safeOpt}', this)">${opt}</button>`;
                });

                qDiv.innerHTML = `
                    <div class="q-text">${index + 1}. ${q.question}</div>
                    ${videoHtml}
                    <div class="options-group">${optionsHtml}</div>
                    <div class="explanation" id="explain-${index}"><strong>Note:</strong> ${q.explanation || ""}</div>
                `;
                container.appendChild(qDiv);
            });
        }

        function checkAnswer(index, selectedValue, btnElement) {
            const questionData = currentQuizData[index];
            const parent = document.getElementById(`q-block-${index}`);
            if(parent.getAttribute('data-answered') === 'true') return;
            parent.setAttribute('data-answered', 'true');

            const isCorrect = (selectedValue === questionData.answer);
            if(isCorrect) { btnElement.classList.add('correct'); score++; } 
            else { btnElement.classList.add('wrong'); parent.querySelectorAll('.option-btn').forEach(b => { if(b.innerText === questionData.answer) b.classList.add('correct'); }); }

            if(questionData.explanation) document.getElementById(`explain-${index}`).style.display = 'block';
        }

        function submitQuiz() {
            const total = currentQuizData.length;
            const answered = document.querySelectorAll('[data-answered="true"]').length;
            if(answered < total && !confirm(`You have only answered ${answered} of ${total} questions. Submit anyway?`)) return;

            const percentage = Math.round((score / total) * 100);
            document.getElementById('quiz-view').classList.add('hidden');
            document.getElementById('result-view').classList.remove('hidden');
            document.getElementById('score-display').innerText = `${percentage}%`;
            document.getElementById('score-detail').innerText = `You got ${score} out of ${total} correct.`;

            const payload = {
                type: 'quiz_result',
                firstName: document.getElementById('firstName').value,
                lastName: document.getElementById('lastName').value,
                email: document.getElementById('userEmail').value,
                quizName: currentQuizName,
                score: `${score}/${total}`,
                percent: `${percentage}%`
            };

            fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) });
        }
    </script>
</body>
</html>
