<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TSOA Premium Vault</title>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/framer-motion@10.12.16/dist/framer-motion.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        navy: { 900: '#0f172a', 800: '#1e293b', 700: '#334155' },
                        tsoa: { green: '#2ecc71', blue: '#3498db' }
                    },
                    fontFamily: { sans: ['Inter', 'sans-serif'] }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    
    <style>
        body { background-color: #050b14; color: white; }
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #2ecc71; }
        
        /* Glassmorphism Utilities */
        .glass {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
    </style>
</head>
<body>

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;
        const { motion, AnimatePresence } = window.Motion;

        // *** CONFIGURATION ***
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwhPmP3cQQtep2d0uRgcSW9dPvVt9ppqk2KI2UBT0ZhKO4xOJx2ktMkvkzrotQNkBz-jg/exec";

        // --- COMPONENTS ---

        // 1. The Header Component
        const Header = () => (
            <motion.header 
                initial={{ y: -100 }} animate={{ y: 0 }} 
                className="fixed top-0 w-full h-16 glass z-50 flex items-center justify-between px-6"
            >
                <div className="text-xl font-bold tracking-tight">
                    TSOA <span className="text-tsoa-green">VAULT</span>
                </div>
                <a href="index.html" className="text-sm text-gray-400 hover:text-white transition-colors">
                    &larr; Exit to Portal
                </a>
            </motion.header>
        );

        // 2. Video Card Component (With Hover Physics)
        const VideoCard = ({ vid, onClick }) => {
            // Auto-generate thumb if missing
            let thumb = vid.thumb;
            if(!thumb && vid.url.includes('youtube')) {
                const vidId = vid.url.split('v=')[1]?.split('&')[0];
                thumb = `https://img.youtube.com/vi/${vidId}/hqdefault.jpg`;
            }
            if(!thumb) thumb = 'https://via.placeholder.com/300x200/000/333?text=No+Preview';

            return (
                <motion.div
                    layout
                    initial={{ opacity: 0, scale: 0.9 }}
                    animate={{ opacity: 1, scale: 1 }}
                    exit={{ opacity: 0, scale: 0.9 }}
                    whileHover={{ y: -8, scale: 1.02, boxShadow: "0 20px 30px rgba(0,0,0,0.5)" }}
                    transition={{ type: "spring", stiffness: 300, damping: 20 }}
                    onClick={() => onClick(vid)}
                    className="bg-navy-800 rounded-xl overflow-hidden cursor-pointer group border border-navy-700 hover:border-tsoa-green relative"
                >
                    {/* Image Container */}
                    <div className="h-40 bg-black relative overflow-hidden">
                        <div 
                            className="absolute inset-0 bg-cover bg-center transition-transform duration-700 group-hover:scale-110 opacity-80 group-hover:opacity-100"
                            style={{ backgroundImage: `url(${thumb})` }}
                        />
                        {/* Play Button Overlay */}
                        <div className="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                            <div className="w-12 h-12 bg-tsoa-green rounded-full flex items-center justify-center shadow-lg transform scale-0 group-hover:scale-100 transition-transform">
                                <span className="text-black font-bold ml-1">‚ñ∂</span>
                            </div>
                        </div>
                    </div>
                    
                    {/* Text Content */}
                    <div className="p-4">
                        <h3 className="font-bold text-gray-100 text-sm leading-snug mb-2 line-clamp-2">
                            {vid.title}
                        </h3>
                        <div className="flex flex-wrap gap-1">
                            {vid.tags && vid.tags.split(',').slice(0,2).map((tag, i) => (
                                <span key={i} className="text-[10px] uppercase font-bold tracking-wider text-tsoa-blue bg-navy-900 px-2 py-1 rounded">
                                    {tag}
                                </span>
                            ))}
                        </div>
                    </div>
                </motion.div>
            );
        };

        // 3. Cinema Modal (The Flashy Overlay)
        const CinemaModal = ({ vid, onClose }) => {
            if (!vid) return null;
            
            // Build Embed
            let embedCode;
            if (vid.url.includes('youtube')) {
                const vidId = vid.url.split('v=')[1]?.split('&')[0];
                embedCode = <iframe src={`https://www.youtube.com/embed/${vidId}?autoplay=1`} className="w-full h-full" frameBorder="0" allow="autoplay; encrypted-media" allowFullScreen></iframe>;
            } else {
                embedCode = <video src={vid.url} controls autoPlay className="w-full h-full"></video>;
            }

            return (
                <motion.div 
                    initial={{ opacity: 0 }} animate={{ opacity: 1 }} exit={{ opacity: 0 }}
                    className="fixed inset-0 z-[100] flex items-center justify-center bg-black/90 backdrop-blur-sm p-4"
                    onClick={onClose}
                >
                    <motion.div 
                        initial={{ y: 50, opacity: 0 }} animate={{ y: 0, opacity: 1 }} exit={{ y: 50, opacity: 0 }}
                        className="bg-navy-800 w-full max-w-4xl rounded-2xl overflow-hidden shadow-2xl border border-navy-700"
                        onClick={e => e.stopPropagation()}
                    >
                        <div className="aspect-video bg-black">
                            {embedCode}
                        </div>
                        <div className="p-6">
                            <div className="flex justify-between items-start">
                                <h2 className="text-2xl font-bold text-white mb-2">{vid.title}</h2>
                                <button onClick={onClose} className="text-gray-400 hover:text-white text-2xl leading-none">&times;</button>
                            </div>
                            <p className="text-gray-400 leading-relaxed">{vid.desc}</p>
                            <div className="mt-4 pt-4 border-t border-navy-700 flex flex-wrap gap-2">
                                {vid.tags && vid.tags.split(',').map((tag, i) => (
                                    <span key={i} className="text-xs text-gray-300 bg-navy-900 px-3 py-1 rounded-full border border-navy-700">
                                        #{tag.trim()}
                                    </span>
                                ))}
                            </div>
                        </div>
                    </motion.div>
                </motion.div>
            );
        };

        // --- MAIN APP LOGIC ---
        const App = () => {
            const [videos, setVideos] = useState([]);
            const [loading, setLoading] = useState(true);
            const [search, setSearch] = useState('');
            const [selectedTag, setSelectedTag] = useState('All');
            const [activeVid, setActiveVid] = useState(null);

            // Fetch Data
            useEffect(() => {
                fetch(`${SCRIPT_URL}?action=getVideos`)
                    .then(res => res.json())
                    .then(data => {
                        setVideos(data);
                        setLoading(false);
                    });
            }, []);

            // Generate unique tags
            const allTags = useMemo(() => {
                const tags = new Set(['All']);
                videos.forEach(v => {
                    if (v.tags) v.tags.split(',').forEach(t => tags.add(t.trim()));
                });
                return Array.from(tags).sort();
            }, [videos]);

            // Filtering Logic
            const filteredVideos = useMemo(() => {
                return videos.filter(v => {
                    const matchesSearch = v.title.toLowerCase().includes(search.toLowerCase()) || 
                                          v.desc.toLowerCase().includes(search.toLowerCase());
                    const matchesTag = selectedTag === 'All' || (v.tags && v.tags.includes(selectedTag));
                    return matchesSearch && matchesTag;
                });
            }, [videos, search, selectedTag]);

            return (
                <div className="min-h-screen pt-20 pb-10 px-4 md:px-8 max-w-7xl mx-auto">
                    <Header />

                    {/* Controls Section */}
                    <div className="mb-8 space-y-4">
                        {/* Search Bar */}
                        <div className="relative max-w-lg">
                            <input 
                                type="text" 
                                placeholder="Search library..." 
                                className="w-full bg-navy-800 border border-navy-700 text-white px-5 py-3 rounded-xl focus:outline-none focus:border-tsoa-green focus:ring-1 focus:ring-tsoa-green transition-all shadow-lg"
                                onChange={(e) => setSearch(e.target.value)}
                            />
                            <div className="absolute right-4 top-3 text-gray-500">üîç</div>
                        </div>

                        {/* Tag Chips (Horizontal Scroll) */}
                        <div className="flex gap-2 overflow-x-auto pb-2 no-scrollbar">
                            {allTags.map(tag => (
                                <button
                                    key={tag}
                                    onClick={() => setSelectedTag(tag)}
                                    className={`whitespace-nowrap px-4 py-2 rounded-full text-sm font-medium transition-all duration-300 ${
                                        selectedTag === tag 
                                        ? 'bg-tsoa-green text-black shadow-[0_0_15px_rgba(46,204,113,0.4)]' 
                                        : 'bg-navy-800 text-gray-400 hover:text-white hover:bg-navy-700'
                                    }`}
                                >
                                    {tag}
                                </button>
                            ))}
                        </div>
                        
                        <div className="text-gray-500 text-sm font-medium">
                            Showing {filteredVideos.length} clips
                        </div>
                    </div>

                    {/* Grid */}
                    {loading ? (
                        <div className="flex items-center justify-center h-64 text-tsoa-green animate-pulse">
                            Loading Library...
                        </div>
                    ) : (
                        <motion.div layout className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                            <AnimatePresence>
                                {filteredVideos.map((vid, i) => (
                                    <VideoCard key={i} vid={vid} onClick={setActiveVid} />
                                ))}
                            </AnimatePresence>
                        </motion.div>
                    )}

                    {/* Modal */}
                    <AnimatePresence>
                        {activeVid && <CinemaModal vid={activeVid} onClose={() => setActiveVid(null)} />}
                    </AnimatePresence>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
