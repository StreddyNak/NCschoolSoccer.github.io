<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eligibility & Quizzes</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #f4f6f8; margin: 0; padding: 20px; color: #333; }
        .container { max-width: 800px; margin: 0 auto; }

        /* --- Navigation Menu --- */
        .nav-bar { 
            position: relative; display: flex; justify-content: center; 
            align-items: center; margin-bottom: 40px; padding: 10px 0;
        }
        .nav-center { display: flex; gap: 20px; }
        .nav-link { text-decoration: none; color: #4b5563; font-weight: 600; padding: 8px 16px; border-radius: 6px; font-size: 16px; transition: 0.2s; }
        .nav-link:hover { background-color: #e5e7eb; color: #111827; }
        .nav-link.active { background-color: #2ecc71; color: white; }
        .supervisor-link {
            position: absolute; right: 0; top: 50%; transform: translateY(-50%);
            text-decoration: none; color: #2c3e50; font-size: 0.9rem; font-weight: 600;
            border: 1px solid #d1d5db; padding: 6px 12px; border-radius: 4px; background: white; transition: all 0.2s;
        }
        .supervisor-link:hover { background: #f3f4f6; border-color: #9ca3af; }

        @media (max-width: 800px) {
            .nav-bar { flex-direction: column; gap: 15px; }
            .supervisor-link { position: static; transform: none; margin-left: auto; }
            .nav-center { flex-wrap: wrap; justify-content: center; }
        }

        /* --- Eligibility Section --- */
        .eligibility-section {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .playoff-notice {
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            border: 2px solid #22c55e;
            border-radius: 8px;
            padding: 12px 20px;
            text-align: center;
            font-weight: 700;
            font-size: 1.1rem;
            color: #166534;
        }
        
        .playoff-notice.hidden {
            display: none;
        }
        
        .scrimmage-detail-card {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .scrimmage-detail-card.attended {
            border-left: 4px solid #22c55e;
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
        }
        
        .scrimmage-detail-card.not-attended {
            border-left: 4px solid #ef4444;
        }
        
        .scrimmage-icon {
            font-size: 2rem;
            flex-shrink: 0;
        }
        
        .scrimmage-info {
            flex-grow: 1;
        }
        
        .scrimmage-name {
            font-weight: 700;
            color: #2c3e50;
            font-size: 1rem;
            margin-bottom: 4px;
        }
        
        .scrimmage-date {
            font-size: 0.85rem;
            color: #666;
        }
        
        .scrimmage-status {
            font-size: 0.9rem;
            font-weight: 600;
            padding: 4px 10px;
            border-radius: 12px;
            white-space: nowrap;
        }
        
        .scrimmage-status.attended {
            background: #dcfce7;
            color: #166534;
        }
        
        .scrimmage-status.not-attended {
            background: #fee2e2;
            color: #991b1b;
        }

        /* --- Page Styles --- */
        .hidden { display: none; }
        .card { background: white; border-radius: 12px; padding: 30px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 20px; text-align: center;}
        
        .btn-primary { background: #2ecc71; color: white; border: none; padding: 12px 24px; border-radius: 6px; font-weight: bold; cursor: pointer; font-size: 1rem; width: 100%; }
        .btn-primary:hover { background: #27ae60; }
        .btn-primary:disabled { background: #95a5a6; cursor: not-allowed; }
        
        .input-field { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 6px; font-size: 1rem; box-sizing: border-box; margin-bottom: 15px; }

        /* Quiz List Items */
        .quiz-list-item { 
            padding: 15px; border: 1px solid #e5e7eb; border-radius: 8px; margin-bottom: 10px; cursor: pointer; transition: 0.2s; 
            display: flex; justify-content: space-between; align-items: center; text-align: left;
        }
        .quiz-list-item:hover { border-color: #2ecc71; background: #f0fdf4; }
        
        .quiz-info { display: flex; flex-direction: column; }
        .quiz-title { font-weight: bold; font-size: 1.1rem; color: #2c3e50; }
        .quiz-meta { font-size: 0.85rem; color: #666; margin-top: 4px; }
        
        .score-badge { font-size: 0.9rem; font-weight: bold; padding: 5px 10px; border-radius: 20px; background: #eee; color: #777; }
        .score-badge.good { background: #dcfce7; color: #166534; }
        
        /* ‚≠ê NEW: Randomization Badge */
        .randomization-info {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            font-size: 0.9rem;
            font-weight: 600;
        }
        
        /* Questions */
        .question-block { margin-bottom: 40px; border-bottom: 1px solid #eee; padding-bottom: 30px; text-align: left; }
        .q-text { font-size: 1.2rem; font-weight: 700; margin-bottom: 15px; }
        
        /* Video */
        .video-wrapper { position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; max-width: 100%; border-radius: 8px; background: #000; margin-bottom: 8px; }
        .video-wrapper iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 0; }
        .backup-link { display: inline-block; font-size: 0.85rem; color: #666; text-decoration: underline; margin-bottom: 15px; }
        
        .option-btn { display: block; width: 100%; text-align: left; padding: 12px 15px; margin-bottom: 8px; background: white; border: 2px solid #e5e7eb; border-radius: 8px; cursor: pointer; font-size: 1rem; transition: all 0.2s; }
        .option-btn:hover:not(.disabled) { background-color: #f9fafb; border-color: #d1d5db; }
        .option-btn.selected { background-color: #dbeafe; border-color: #3b82f6; font-weight: 600; }
        .option-btn.disabled { cursor: not-allowed; pointer-events: none; }
    </style>
</head>
<body>

    <div class="container">
        <div class="nav-bar">
            <div class="nav-center">
                <a href="index.html" class="nav-link">Home</a>
                <a href="report.html" class="nav-link">CMI Form</a>
                <a href="jersey.html" class="nav-link">Kit Search</a>
                <span class="nav-link active">Eligibility & Quizzes</span>
            </div>
            <a href="admin.html" class="supervisor-link">üîí Supervisors</a>
        </div>

        <div id="login-view" class="card">
            <h2>Referee Login</h2>
            <p style="color:#666; margin-bottom:20px;">Enter your email to view your eligibility status and training modules.</p>
            <input type="email" id="loginEmail" class="input-field" placeholder="yourname@email.com">
            <button class="btn-primary" onclick="handleLogin()">Login</button>
            <p id="login-msg" style="color:red; margin-top:10px; display:none;"></p>
        </div>

        <div id="eligibility-display" class="eligibility-section hidden">
            <h3 style="color: #2c3e50; font-size: 1.3rem; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                <span>üìã</span> Scrimmage Attendance
            </h3>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 12px; margin-bottom: 15px;">
                <div id="scrimmage1-detail" class="scrimmage-detail-card"></div>
                <div id="scrimmage2-detail" class="scrimmage-detail-card"></div>
            </div>
            
            <div id="playoff-notice" class="playoff-notice hidden">
                You have completed the scrimmages requirement for playoff eligibility!
            </div>
        </div>

        <div id="selection-view" class="hidden">
            <h2 id="welcome-header" style="text-align:center;">Training Quizzes</h2>
            
            <!-- ‚≠ê NEW: Randomization Info -->
            <div class="randomization-info">
                Each quiz randomly selects 15 questions and shuffles answer choices for academic integrity
            </div>
            
            <div id="quiz-list-container"></div>
            <button onclick="location.reload()" style="margin-top:20px; background:none; border:none; color:#999; cursor:pointer;">Logout</button>
        </div>

        <div id="intro-view" class="card hidden">
            <h2 id="intro-title">Quiz Title</h2>
            <p style="color:#666;">Confirm your details to begin.</p>
            <input type="text" id="firstName" class="input-field" readonly style="background:#f9f9f9; color:#666;">
            <input type="text" id="lastName" class="input-field" readonly style="background:#f9f9f9; color:#666;">
            <input type="email" id="userEmail" class="input-field" readonly style="background:#f9f9f9; color:#666;">
            <p style="font-size: 0.9rem; color: #666; background: #f0f9ff; padding: 12px; border-radius: 6px; border-left: 4px solid #3b82f6;">
                <strong>Note:</strong> This quiz will show 15 randomly selected questions with shuffled answer choices.
            </p>
            <button class="btn-primary" onclick="startQuiz()">Start Quiz</button>
            <br>
            <button onclick="document.getElementById('intro-view').classList.add('hidden'); document.getElementById('selection-view').classList.remove('hidden');" style="background:none; border:none; color:#666; margin-top:15px; cursor:pointer;">Back</button>
        </div>

        <div id="quiz-view" class="card hidden">
            <h2 id="active-quiz-title" style="border-bottom:2px solid #2ecc71; padding-bottom:10px; margin-bottom:20px;"></h2>
            <div id="questions-container"></div>
            <button id="finishBtn" class="btn-primary" onclick="submitQuiz()">Submit Quiz</button>
        </div>

        <div id="result-view" class="card hidden">
            <h1>Quiz Complete!</h1>
            <div style="font-size:3rem; font-weight:800; margin:20px 0;" id="score-display">0%</div>
            <p id="score-detail">You got X out of Y correct.</p>
            <p style="color:#22c55e; margin-top:20px; font-weight:600;">‚úì Results saved successfully</p>
            <button class="btn-primary" onclick="location.reload()">Return to Login</button>
        </div>
    </div>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyCKkdHudV8CA1hcdV_KN2KEyOeZ5nmaQ_5-fWO40BPpIZwjMO1z3F4lalyP3wMYRf7lQ/exec";
        const QUESTIONS_PER_QUIZ = 15; // ‚≠ê Configure how many questions to show

        let allQuizzes = {};
        let userScores = {}; 
        let currentQuizData = [];
        let currentQuizName = "";
        let score = 0;
        let currentUser = {};
        let userAnswers = {};
        let eligibilityData = null;

        // ===== ‚≠ê NEW: RANDOMIZATION FUNCTIONS =====
        
        /**
         * Fisher-Yates shuffle algorithm - ensures truly random shuffling
         */
        function shuffleArray(array) {
            const shuffled = [...array]; // Create copy to avoid mutating original
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }
        
        /**
         * Prepare quiz with randomization:
         * 1. Shuffle all questions
         * 2. Select first N questions (e.g., 15 out of 20)
         * 3. Shuffle answer options for each question
         */
        function prepareQuizQuestions(questions, maxQuestions = QUESTIONS_PER_QUIZ) {
            console.log(`Preparing quiz: ${questions.length} total questions, selecting ${maxQuestions}`);
            
            // Step 1: Shuffle questions
            let shuffled = shuffleArray(questions);
            
            // Step 2: Take only first N questions
            shuffled = shuffled.slice(0, Math.min(maxQuestions, questions.length));
            
            // Step 3: Shuffle answer options for each question
            shuffled = shuffled.map((q, index) => {
                const correctAnswer = q.answer;
                
                // Shuffle the options array
                const shuffledOptions = shuffleArray(q.options);
                
                return {
                    ...q,
                    questionNumber: index + 1,
                    options: shuffledOptions, // Use shuffled options
                    correctAnswer: correctAnswer // Keep track of correct answer
                };
            });
            
            console.log(`Quiz prepared: ${shuffled.length} randomized questions with shuffled answers`);
            return shuffled;
        }
        
        // ===== LOGIN & DATA LOADING =====

        function handleLogin() {
            const email = document.getElementById('loginEmail').value.trim();
            if (!email) { alert("Please enter an email."); return; }
            const btn = document.querySelector('#login-view button');
            const msg = document.getElementById('login-msg');
            btn.innerText = "Verifying..."; btn.disabled = true; msg.style.display = 'none';

            fetch(`${SCRIPT_URL}?action=getQuizData&email=${encodeURIComponent(email)}`)
                .then(res => res.json())
                .then(data => {
                    if (data.error) {
                        msg.innerText = data.error; msg.style.display = 'block';
                        btn.innerText = "Login"; btn.disabled = false; return;
                    }
                    allQuizzes = data.quizzes;
                    userScores = data.scores || {}; 
                    currentUser = data.user || { firstName: "", lastName: "", email: email }; 
                    eligibilityData = data.eligibility || null;
                    
                    document.getElementById('userEmail').value = email;
                    document.getElementById('firstName').value = currentUser.firstName;
                    document.getElementById('lastName').value = currentUser.lastName;
                    if (currentUser.firstName) document.getElementById('welcome-header').innerText = `Welcome, ${currentUser.firstName}`;
                    
                    displayEligibility();
                    renderQuizList();
                    
                    document.getElementById('login-view').classList.add('hidden');
                    document.getElementById('eligibility-display').classList.remove('hidden');
                    document.getElementById('selection-view').classList.remove('hidden');
                })
                .catch(err => {
                    console.error(err);
                    msg.innerText = "Connection failed. Please check your internet."; msg.style.display = 'block';
                    btn.innerText = "Login"; btn.disabled = false;
                });
        }

        function displayEligibility() {
            if (!eligibilityData) {
                console.log("No eligibility data available");
                return;
            }
            
            const playoffNotice = document.getElementById('playoff-notice');
            if (eligibilityData.playoffEligible) {
                playoffNotice.classList.remove('hidden');
            } else {
                playoffNotice.classList.add('hidden');
            }
            
            if (eligibilityData.scrimmages && eligibilityData.scrimmages.length >= 2) {
                displayScrimmageDetails(eligibilityData.scrimmages);
            }
        }
        
        function displayScrimmageDetails(scrimmages) {
            const scrim1 = scrimmages[0];
            const scrim1Card = document.getElementById('scrimmage1-detail');
            scrim1Card.className = `scrimmage-detail-card ${scrim1.attended ? 'attended' : 'not-attended'}`;
            scrim1Card.innerHTML = `
                <div class="scrimmage-icon">${scrim1.attended ? '‚úÖ' : 'üìÖ'}</div>
                <div class="scrimmage-info">
                    <div class="scrimmage-name">${scrim1.name}</div>
                    <div class="scrimmage-date">${scrim1.date ? scrim1.date : 'Date TBD'}</div>
                </div>
                <div class="scrimmage-status ${scrim1.attended ? 'attended' : 'not-attended'}">
                    ${scrim1.attended ? 'Attended' : 'Not Attended'}
                </div>
            `;
            
            const scrim2 = scrimmages[1];
            const scrim2Card = document.getElementById('scrimmage2-detail');
            scrim2Card.className = `scrimmage-detail-card ${scrim2.attended ? 'attended' : 'not-attended'}`;
            scrim2Card.innerHTML = `
                <div class="scrimmage-icon">${scrim2.attended ? '‚úÖ' : 'üìÖ'}</div>
                <div class="scrimmage-info">
                    <div class="scrimmage-name">${scrim2.name}</div>
                    <div class="scrimmage-date">${scrim2.date ? scrim2.date : 'Date TBD'}</div>
                </div>
                <div class="scrimmage-status ${scrim2.attended ? 'attended' : 'not-attended'}">
                    ${scrim2.attended ? 'Attended' : 'Not Attended'}
                </div>
            `;
        }

        function renderQuizList() {
            const container = document.getElementById('quiz-list-container');
            container.innerHTML = '';
            const titles = Object.keys(allQuizzes);
            if (titles.length === 0) { 
                container.innerHTML = "<p style='text-align:center'>No quizzes assigned to your group.</p>"; 
                return; 
            }

            titles.forEach(title => {
                const count = allQuizzes[title].length;
                const questionsShown = Math.min(QUESTIONS_PER_QUIZ, count);
                const highScore = userScores[title]; 
                let badgeHtml = "";
                
                if (highScore !== undefined && highScore.score) {
                    badgeHtml = `<span class="score-badge good">Best: ${highScore.score}</span>`;
                } else if (highScore !== undefined && typeof highScore === 'number') {
                    badgeHtml = `<span class="score-badge good">Best: ${highScore}%</span>`;
                } else if (highScore !== undefined && typeof highScore === 'object') {
                    badgeHtml = `<span class="score-badge good">Best: ${highScore.percent}%</span>`;
                }
                
                const div = document.createElement('div');
                div.className = 'quiz-list-item';
                div.innerHTML = `
                    <div class="quiz-info">
                        <span class="quiz-title">${title}</span>
                        <span class="quiz-meta">${count} questions available ‚Ä¢ ${questionsShown} shown randomly</span>
                    </div>
                    ${badgeHtml}
                `;
                div.onclick = () => showIntro(title);
                container.appendChild(div);
            });
        }

        function showIntro(title) {
            currentQuizName = title;
            // ‚≠ê Store original questions but don't randomize yet
            currentQuizData = allQuizzes[title];
            
            document.getElementById('eligibility-display').classList.add('hidden');
            document.getElementById('selection-view').classList.add('hidden');
            document.getElementById('intro-view').classList.remove('hidden');
            document.getElementById('intro-title').innerText = title;
        }

        function startQuiz() {
            // ‚≠ê NOW apply randomization when quiz starts
            const originalQuestions = allQuizzes[currentQuizName];
            currentQuizData = prepareQuizQuestions(originalQuestions, QUESTIONS_PER_QUIZ);
            
            document.getElementById('intro-view').classList.add('hidden');
            document.getElementById('quiz-view').classList.remove('hidden');
            document.getElementById('active-quiz-title').innerText = currentQuizName;
            
            score = 0;
            userAnswers = {};
            renderQuestions();
        }

        function getVideoHtml(url) {
            if (!url || url.length < 5) return "";
            url = url.trim();
            let embed = "";
            
            const ytMatch = url.match(/(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/i);
            if (ytMatch && ytMatch[1]) {
                embed = `<div class="video-wrapper"><iframe src="https://www.youtube.com/embed/${ytMatch[1]}" frameborder="0" allowfullscreen></iframe></div>`;
            } else {
                const vimeoMatch = url.match(/(?:vimeo\.com\/|player\.vimeo\.com\/video\/)([0-9]+)/);
                if (vimeoMatch && vimeoMatch[1]) {
                    embed = `<div class="video-wrapper"><iframe src="https://player.vimeo.com/video/${vimeoMatch[1]}" frameborder="0" allowfullscreen></iframe></div>`;
                }
            }
            
            return `${embed}<a href="${url}" target="_blank" class="backup-link">Open Video in New Tab (if player fails)</a>`;
        }

        function renderQuestions() {
            const container = document.getElementById('questions-container');
            container.innerHTML = '';

            currentQuizData.forEach((q, index) => {
                const qDiv = document.createElement('div');
                qDiv.className = 'question-block';
                qDiv.id = `q-block-${index}`;

                const title = document.createElement('div');
                title.className = 'q-text';
                title.innerText = `${q.questionNumber}. ${q.question}`;
                qDiv.appendChild(title);

                if(q.video) {
                    const vidDiv = document.createElement('div');
                    vidDiv.innerHTML = getVideoHtml(q.video);
                    qDiv.appendChild(vidDiv);
                }

                const optsDiv = document.createElement('div');
                optsDiv.className = 'options-group';
                optsDiv.id = `options-${index}`;
                
                // ‚≠ê Options are already shuffled by prepareQuizQuestions
                q.options.forEach(optText => {
                    const btn = document.createElement('button');
                    btn.className = 'option-btn';
                    btn.innerText = optText;
                    btn.onclick = function() { selectAnswer(index, optText); };
                    optsDiv.appendChild(btn);
                });
                qDiv.appendChild(optsDiv);

                container.appendChild(qDiv);
            });
        }

        function selectAnswer(index, selectedText) {
            userAnswers[index] = selectedText;
            
            const parent = document.getElementById(`options-${index}`);
            const allBtns = parent.querySelectorAll('.option-btn');
            allBtns.forEach(btn => {
                btn.classList.remove('selected');
                if(btn.innerText === selectedText) {
                    btn.classList.add('selected');
                }
            });
        }

        function submitQuiz() {
            const total = currentQuizData.length;
            const answeredCount = Object.keys(userAnswers).length;
            
            if(answeredCount < total) {
                if(!confirm(`You have only answered ${answeredCount} of ${total} questions. Submit anyway?`)) return;
            }

            // Calculate score
            score = 0;
            currentQuizData.forEach((q, index) => {
                const userAnswer = userAnswers[index];
                if (userAnswer && userAnswer.trim() === q.correctAnswer.trim()) {
                    score++;
                }
            });

            const percentage = Math.round((score / total) * 100);
            
            const finishBtn = document.getElementById('finishBtn');
            finishBtn.innerText = "Submitting Results...";
            finishBtn.disabled = true;

            // Build question results for backend
            const questionResults = [];
            currentQuizData.forEach((q, index) => {
                const userAnswer = userAnswers[index] || "";
                const isCorrect = userAnswer.trim() === q.correctAnswer.trim();
                
                questionResults.push({
                    questionNumber: q.questionNumber,
                    questionText: q.question,
                    studentAnswer: userAnswer,
                    correctAnswer: q.correctAnswer,
                    isCorrect: isCorrect
                });
            });

            const payload = {
                type: 'quiz_result',
                firstName: document.getElementById('firstName').value,
                lastName: document.getElementById('lastName').value,
                email: document.getElementById('userEmail').value,
                quizName: currentQuizName,
                score: `${score}/${total}`,
                percent: `${percentage}%`,
                questionResults: questionResults
            };

            // Submit to backend
            fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) })
            .then(() => {
                // ‚≠ê Go directly to result view (no review)
                const scoreDisplay = document.getElementById('score-display');
                scoreDisplay.innerText = `${percentage}%`;
                
                // Color code the score
                if (percentage >= 80) {
                    scoreDisplay.style.color = '#22c55e'; // Green
                } else if (percentage >= 60) {
                    scoreDisplay.style.color = '#eab308'; // Yellow
                } else {
                    scoreDisplay.style.color = '#ef4444'; // Red
                }
                
                document.getElementById('score-detail').innerText = `You got ${score} out of ${total} correct.`;
                
                document.getElementById('quiz-view').classList.add('hidden');
                document.getElementById('result-view').classList.remove('hidden');
            })
            .catch(err => {
                console.error("Submission error:", err);
                alert("Error submitting results. Please try again or contact your supervisor.");
                finishBtn.innerText = "Submit Quiz";
                finishBtn.disabled = false;
            });
        }
    </script>
</body>
</html>
