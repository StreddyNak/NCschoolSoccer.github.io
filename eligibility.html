<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eligibility & Quizzes</title>
    <style>
        * { box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            background: #f4f6f8; 
            margin: 0; 
            padding: 20px; 
            color: #333; 
        }
        .container { max-width: 900px; margin: 0 auto; }

        /* --- Navigation Menu (matching index.html) --- */
        .nav-bar { 
            background: white;
            border-radius: 12px;
            padding: 15px 20px;
            margin-bottom: 30px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .nav-center {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .nav-link { 
            text-decoration: none; 
            color: #4b5563; 
            font-weight: 600; 
            padding: 10px 20px; 
            border-radius: 8px; 
            font-size: 15px; 
            transition: all 0.2s;
            white-space: nowrap;
            border: 2px solid transparent;
        }
        
        .nav-link:hover { 
            background-color: #e5e7eb; 
            color: #111827; 
        }
        
        .nav-link.active { 
            background-color: #2ecc71; 
            color: white;
            border-color: #27ae60;
        }

        /* Welcome Header */
        .welcome-header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .welcome-header h2 {
            color: #2c3e50;
            font-size: 2rem;
            margin: 0;
        }

        /* --- Eligibility Section --- */
        .eligibility-section {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .playoff-notice {
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            border: 2px solid #22c55e;
            border-radius: 8px;
            padding: 12px 20px;
            text-align: center;
            font-weight: 700;
            font-size: 1.1rem;
            color: #166534;
        }
        
        .playoff-notice.hidden {
            display: none;
        }
        
        .scrimmage-detail-card {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 12px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .scrimmage-detail-card.attended {
            border-left: 4px solid #22c55e;
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
        }
        
        .scrimmage-detail-card.not-attended {
            border-left: 4px solid #ef4444;
        }
        
        .scrimmage-info {
            flex-grow: 1;
        }
        
        .scrimmage-name {
            font-weight: 700;
            color: #2c3e50;
            font-size: 1rem;
            margin-bottom: 4px;
        }
        
        .scrimmage-date {
            font-size: 0.85rem;
            color: #666;
        }
        
        .scrimmage-status {
            font-size: 0.9rem;
            font-weight: 600;
            padding: 4px 10px;
            border-radius: 12px;
            white-space: nowrap;
        }
        
        .scrimmage-status.attended {
            background: #dcfce7;
            color: #166534;
        }
        
        .scrimmage-status.not-attended {
            background: #fee2e2;
            color: #991b1b;
        }

        /* Quiz Section Header */
        .quiz-section-header {
            text-align: center;
            margin-bottom: 25px;
        }
        
        .quiz-section-header h2 {
            color: #2c3e50;
            font-size: 1.8rem;
            margin: 0 0 10px 0;
        }
        
        .quiz-section-subtext {
            color: #666;
            font-size: 0.95rem;
            line-height: 1.4;
        }

        /* --- Page Styles --- */
        .hidden { display: none; }
        .card { 
            background: white; 
            border-radius: 12px; 
            padding: 30px; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); 
            margin-bottom: 20px; 
            text-align: center;
        }
        
        .btn-primary { 
            background: #2ecc71; 
            color: white; 
            border: none; 
            padding: 14px 24px; 
            border-radius: 8px; 
            font-weight: bold; 
            cursor: pointer; 
            font-size: 1rem; 
            width: 100%;
            transition: all 0.2s;
        }
        .btn-primary:hover { 
            background: #27ae60;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(46, 204, 113, 0.3);
        }
        .btn-primary:disabled { 
            background: #95a5a6; 
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .input-field { 
            width: 100%; 
            padding: 14px; 
            border: 2px solid #e5e7eb; 
            border-radius: 8px; 
            font-size: 1rem; 
            box-sizing: border-box; 
            margin-bottom: 15px;
            transition: border-color 0.2s;
        }
        .input-field:focus {
            outline: none;
            border-color: #2ecc71;
        }

        /* Quiz List Items */
        .quiz-list-item { 
            padding: 15px; 
            border: 2px solid #e5e7eb; 
            border-radius: 8px; 
            margin-bottom: 10px; 
            cursor: pointer; 
            transition: all 0.2s; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            text-align: left;
        }
        .quiz-list-item:hover { 
            border-color: #2ecc71; 
            background: #f0fdf4;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.08);
        }
        
        /* Closed Quiz Styling */
        .quiz-list-item.closed {
            background: #f9fafb;
            border-color: #d1d5db;
            cursor: not-allowed;
            opacity: 0.75;
        }
        
        .quiz-list-item.closed:hover {
            border-color: #d1d5db;
            background: #f9fafb;
            transform: none;
            box-shadow: none;
        }
        
        .quiz-closed-badge {
            background: #fee2e2;
            color: #991b1b;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-left: 8px;
        }
        
        .quiz-info { display: flex; flex-direction: column; }
        .quiz-title { font-weight: bold; font-size: 1.1rem; color: #2c3e50; }
        .quiz-meta { font-size: 0.85rem; color: #666; margin-top: 4px; }
        .quiz-dates { 
            font-size: 0.75rem; 
            color: #999; 
            margin-top: 4px;
            font-style: italic;
        }
        
        .score-badge { 
            font-size: 0.9rem; 
            font-weight: bold; 
            padding: 6px 12px; 
            border-radius: 20px; 
            background: #eee; 
            color: #777; 
        }
        .score-badge.good { background: #dcfce7; color: #166534; }
        
        /* Questions */
        .question-block { 
            margin-bottom: 40px; 
            border-bottom: 2px solid #e5e7eb; 
            padding-bottom: 30px; 
            text-align: left; 
        }
        .q-text { 
            font-size: 1.2rem; 
            font-weight: 700; 
            margin-bottom: 15px;
            color: #2c3e50;
            line-height: 1.4;
        }
        
        /* Video */
        .video-wrapper { 
            position: relative; 
            padding-bottom: 56.25%; 
            height: 0; 
            overflow: hidden; 
            max-width: 100%; 
            border-radius: 8px; 
            background: #000; 
            margin-bottom: 8px; 
        }
        .video-wrapper iframe { 
            position: absolute; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            border: 0; 
        }
        .backup-link { 
            display: inline-block; 
            font-size: 0.85rem; 
            color: #3498db; 
            text-decoration: underline; 
            margin-bottom: 15px; 
        }
        
        /* IMPROVED: Answer Option Buttons with Better Feedback */
        .option-btn { 
            display: block; 
            width: 100%; 
            text-align: left; 
            padding: 14px 16px; 
            margin-bottom: 10px; 
            background: white; 
            border: 2px solid #e5e7eb; 
            border-radius: 8px; 
            cursor: pointer; 
            font-size: 1rem; 
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }
        
        .option-btn:hover:not(.disabled) { 
            background-color: #f9fafb; 
            border-color: #d1d5db;
            transform: translateX(4px);
        }
        
        /* IMPROVED: Much more obvious selected state */
        .option-btn.selected { 
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            border-color: #3b82f6;
            border-width: 3px;
            font-weight: 600;
            color: #1e40af;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
            transform: translateX(4px);
        }
        
        .option-btn.disabled { 
            cursor: not-allowed; 
            pointer-events: none; 
            opacity: 0.6;
        }

        /* Footer */
        .footer {
            text-align: center;
            padding: 30px 20px;
            color: #999;
            font-size: 0.85rem;
            border-top: 1px solid #e5e7eb;
            margin-top: 40px;
        }

        /* Mobile Optimizations */
        @media (max-width: 768px) {
            body {
                padding: 15px;
            }
            
            .container {
                padding: 0;
            }
            
            .welcome-header h2 {
                font-size: 1.6rem;
            }
            
            .nav-bar {
                padding: 15px;
                gap: 12px;
            }
            
            .nav-center {
                gap: 8px;
            }
            
            .nav-link {
                padding: 10px 16px;
                font-size: 14px;
                flex: 1 1 auto;
                text-align: center;
                min-width: calc(50% - 4px);
            }
            
            .eligibility-section {
                padding: 20px;
            }
            
            .playoff-notice {
                font-size: 1rem;
                padding: 10px 16px;
            }
            
            .scrimmage-detail-card {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
                padding: 12px;
            }
            
            .card {
                padding: 20px;
            }
            
            .q-text {
                font-size: 1.1rem;
            }
            
            .option-btn {
                padding: 12px 14px;
                font-size: 0.95rem;
            }
            
            .quiz-list-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .quiz-closed-badge {
                margin-left: 0;
                margin-top: 4px;
            }
            
            .score-badge {
                align-self: flex-start;
            }
        }
        
        @media (max-width: 480px) {
            .nav-link {
                min-width: 100%;
            }
            
            .welcome-header h2 {
                font-size: 1.4rem;
            }
            
            h2 {
                font-size: 1.5rem;
            }
            
            .btn-primary {
                padding: 12px 20px;
            }
        }
    </style>
</head>
<body>

    <div class="container">
        <!-- Updated Navigation matching index.html -->
        <nav class="nav-bar">
            <div class="nav-center">
                <a href="index.html" class="nav-link">Home</a>
                <a href="report.html" class="nav-link">CMI Form</a>
                <a href="jersey.html" class="nav-link">Kit Search</a>
                <span class="nav-link active">Eligibility/Quizzes</span>
                <a href="admin.html" class="nav-link">üîí Supervisors</a>
            </div>
        </nav>

        <!-- Welcome Header -->
        <div id="welcome-header-container" class="welcome-header hidden">
            <h2 id="welcome-header">Welcome</h2>
        </div>

        <div id="login-view" class="card">
            <h2>Referee Login</h2>
            <p style="color:#666; margin-bottom:20px;">Enter your email to view your eligibility status and training modules.</p>
            <input type="email" id="loginEmail" class="input-field" placeholder="yourname@email.com">
            <button class="btn-primary" onclick="handleLogin()">Login</button>
            <p id="login-msg" style="color:#e74c3c; margin-top:15px; display:none; padding:12px; background:#fee; border-radius:6px;"></p>
        </div>

        <div id="eligibility-display" class="eligibility-section hidden">
            <h3 style="color: #2c3e50; font-size: 1.1rem; margin: 0 0 12px 0; font-weight: 600;">
                Scrimmage Attendance
            </h3>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 10px; margin-bottom: 12px;">
                <div id="scrimmage1-detail" class="scrimmage-detail-card"></div>
                <div id="scrimmage2-detail" class="scrimmage-detail-card"></div>
            </div>
            
            <div id="playoff-notice" class="playoff-notice hidden">
                You have completed the scrimmages requirement for playoff eligibility!
            </div>
        </div>

        <div id="selection-view" class="hidden">
            <div class="quiz-section-header">
                <h2>Quizzes</h2>
                <p class="quiz-section-subtext">You must complete all 3 optional quizzes at 12/15 or better to be eligible for playoffs</p>
            </div>
            <div id="quiz-list-container"></div>
            <button onclick="location.reload()" style="margin-top:20px; background:none; border:none; color:#999; cursor:pointer; text-decoration:underline;">Logout</button>
        </div>

        <div id="intro-view" class="card hidden">
            <h2 id="intro-title">Quiz Title</h2>
            <p style="color:#666; margin-bottom:20px;">Confirm your details to begin.</p>
            <input type="text" id="firstName" class="input-field" readonly style="background:#f9f9f9; color:#666;">
            <input type="text" id="lastName" class="input-field" readonly style="background:#f9f9f9; color:#666;">
            <input type="email" id="userEmail" class="input-field" readonly style="background:#f9f9f9; color:#666;">
            <button class="btn-primary" onclick="startQuiz()">Start Quiz</button>
            <br>
            <button onclick="document.getElementById('intro-view').classList.add('hidden'); document.getElementById('selection-view').classList.remove('hidden');" style="background:none; border:none; color:#666; margin-top:15px; cursor:pointer; text-decoration:underline;">Back</button>
        </div>

        <div id="quiz-view" class="card hidden">
            <h2 id="active-quiz-title" style="border-bottom:2px solid #2ecc71; padding-bottom:10px; margin-bottom:20px; color:#2c3e50;"></h2>
            <div id="questions-container"></div>
            <button id="finishBtn" class="btn-primary" onclick="submitQuiz()">Submit Quiz</button>
        </div>

        <div id="result-view" class="card hidden">
            <h1 style="color:#2c3e50;">Quiz Complete!</h1>
            <div style="font-size:3rem; font-weight:800; margin:20px 0;" id="score-display">0%</div>
            <p id="score-detail" style="font-size:1.1rem; color:#666; margin-bottom:8px;">You got X out of Y correct.</p>
            <p style="font-size:1rem; color:#666; font-weight:600; margin-bottom:20px;">You must get 12/15 or better to receive credit</p>
            <p style="color:#22c55e; margin-top:20px; font-weight:600;">‚úì Results saved successfully</p>
            <button class="btn-primary" onclick="location.reload()">Return to Login</button>
        </div>

        <!-- Footer -->
        <div class="footer">
            <p><a href="https://www.trianglerefs.org/" target="_blank" rel="noopener noreferrer" style="color: #3498db; text-decoration: none;">Triangle Soccer Officials Association</a> &amp; NickNak Productions</p>
            <p>¬© 2026 All Rights Reserved</p>
        </div>
    </div>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyCKkdHudV8CA1hcdV_KN2KEyOeZ5nmaQ_5-fWO40BPpIZwjMO1z3F4lalyP3wMYRf7lQ/exec";
        const QUESTIONS_PER_QUIZ = 15; // ‚≠ê Configure how many questions to show

        let allQuizzes = {};
        let userScores = {}; 
        let quizStatus = {}; // NEW: Track which quizzes are active/closed
        let currentQuizData = [];
        let currentQuizName = "";
        let score = 0;
        let currentUser = {};
        let userAnswers = {};
        let eligibilityData = null;

        // ===== ‚≠ê NEW: RANDOMIZATION FUNCTIONS =====
        
        /**
         * Fisher-Yates shuffle algorithm - ensures truly random shuffling
         */
        function shuffleArray(array) {
            const shuffled = [...array]; // Create copy to avoid mutating original
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }
        
        /**
         * Prepare quiz with randomization:
         * 1. Shuffle all questions
         * 2. Select first N questions (e.g., 15 out of 20)
         * 3. Shuffle answer options for each question
         */
        function prepareQuizQuestions(questions, maxQuestions = QUESTIONS_PER_QUIZ) {
            console.log(`Preparing quiz: ${questions.length} total questions, selecting ${maxQuestions}`);
            
            // Step 1: Shuffle questions
            let shuffled = shuffleArray(questions);
            
            // Step 2: Take only first N questions
            shuffled = shuffled.slice(0, Math.min(maxQuestions, questions.length));
            
            // Step 3: Shuffle answer options for each question
            shuffled = shuffled.map((q, index) => {
                const correctAnswer = q.answer;
                
                // Shuffle the options array
                const shuffledOptions = shuffleArray(q.options);
                
                return {
                    ...q,
                    questionNumber: index + 1,
                    options: shuffledOptions, // Use shuffled options
                    correctAnswer: correctAnswer // Keep track of correct answer
                };
            });
            
            console.log(`Quiz prepared: ${shuffled.length} randomized questions with shuffled answers`);
            return shuffled;
        }
        
        // ===== LOGIN & DATA LOADING =====

        function handleLogin() {
            const email = document.getElementById('loginEmail').value.trim();
            if (!email) { alert("Please enter an email."); return; }
            const btn = document.querySelector('#login-view button');
            const msg = document.getElementById('login-msg');
            btn.innerText = "Verifying..."; btn.disabled = true; msg.style.display = 'none';

            fetch(`${SCRIPT_URL}?action=getQuizData&email=${encodeURIComponent(email)}`)
                .then(res => res.json())
                .then(data => {
                    if (data.error) {
                        msg.innerText = data.error; msg.style.display = 'block';
                        btn.innerText = "Login"; btn.disabled = false; return;
                    }
                    allQuizzes = data.quizzes;
                    userScores = data.scores || {}; 
                    quizStatus = data.quizStatus || {}; // NEW: Capture quiz status
                    currentUser = data.user || { firstName: "", lastName: "", email: email }; 
                    eligibilityData = data.eligibility || null;
                    
                    document.getElementById('userEmail').value = email;
                    document.getElementById('firstName').value = currentUser.firstName;
                    document.getElementById('lastName').value = currentUser.lastName;
                    
                    // Update welcome header at top of page
                    if (currentUser.firstName) {
                        document.getElementById('welcome-header').innerText = `Welcome, ${currentUser.firstName}`;
                        document.getElementById('welcome-header-container').classList.remove('hidden');
                    }
                    
                    displayEligibility();
                    renderQuizList();
                    
                    document.getElementById('login-view').classList.add('hidden');
                    document.getElementById('welcome-header-container').classList.remove('hidden');
                    document.getElementById('eligibility-display').classList.remove('hidden');
                    document.getElementById('selection-view').classList.remove('hidden');
                })
                .catch(err => {
                    console.error(err);
                    msg.innerText = "Connection failed. Please check your internet."; msg.style.display = 'block';
                    btn.innerText = "Login"; btn.disabled = false;
                });
        }

        function displayEligibility() {
            if (!eligibilityData) {
                console.log("No eligibility data available");
                return;
            }
            
            const playoffNotice = document.getElementById('playoff-notice');
            if (eligibilityData.playoffEligible) {
                playoffNotice.classList.remove('hidden');
            } else {
                playoffNotice.classList.add('hidden');
            }
            
            if (eligibilityData.scrimmages && eligibilityData.scrimmages.length >= 2) {
                displayScrimmageDetails(eligibilityData.scrimmages);
            }
        }
        
        function displayScrimmageDetails(scrimmages) {
            const scrim1 = scrimmages[0];
            const scrim1Card = document.getElementById('scrimmage1-detail');
            scrim1Card.className = `scrimmage-detail-card ${scrim1.attended ? 'attended' : 'not-attended'}`;
            scrim1Card.innerHTML = `
                <div class="scrimmage-info">
                    <div class="scrimmage-name">${scrim1.name}</div>
                    <div class="scrimmage-date">${scrim1.date ? scrim1.date : 'Date TBD'}</div>
                </div>
                <div class="scrimmage-status ${scrim1.attended ? 'attended' : 'not-attended'}">
                    ${scrim1.attended ? 'Attended' : 'Not Attended'}
                </div>
            `;
            
            const scrim2 = scrimmages[1];
            const scrim2Card = document.getElementById('scrimmage2-detail');
            scrim2Card.className = `scrimmage-detail-card ${scrim2.attended ? 'attended' : 'not-attended'}`;
            scrim2Card.innerHTML = `
                <div class="scrimmage-info">
                    <div class="scrimmage-name">${scrim2.name}</div>
                    <div class="scrimmage-date">${scrim2.date ? scrim2.date : 'Date TBD'}</div>
                </div>
                <div class="scrimmage-status ${scrim2.attended ? 'attended' : 'not-attended'}">
                    ${scrim2.attended ? 'Attended' : 'Not Attended'}
                </div>
            `;
        }

        function renderQuizList() {
            const container = document.getElementById('quiz-list-container');
            container.innerHTML = '';
            
            // Get all quiz names from active quizzes, scores, AND quiz status
            // This ensures closed quizzes show even if student never took them
            const allQuizNames = new Set([
                ...Object.keys(allQuizzes),      // Active quizzes with questions
                ...Object.keys(userScores),       // Quizzes student has taken
                ...Object.keys(quizStatus)        // ALL quizzes (active and closed)
            ]);
            
            const titles = Array.from(allQuizNames);
            
            if (titles.length === 0) { 
                container.innerHTML = "<p style='text-align:center'>No quizzes assigned to your group.</p>"; 
                return; 
            }

            titles.forEach(title => {
                const statusInfo = quizStatus[title] || { status: 'active', startDate: '', endDate: '' };
                const isClosed = statusInfo.status === 'closed' || statusInfo === 'closed';
                const isActive = statusInfo.status === 'active' || statusInfo === 'active' || allQuizzes[title];
                const count = allQuizzes[title] ? allQuizzes[title].length : 0;
                const questionsShown = Math.min(QUESTIONS_PER_QUIZ, count);
                const highScore = userScores[title]; 
                
                let badgeHtml = "";
                let statusBadgeHtml = "";
                let datesHtml = "";
                
                // Show score if available
                if (highScore !== undefined && highScore.score) {
                    badgeHtml = `<span class="score-badge good">Best: ${highScore.score}</span>`;
                } else if (highScore !== undefined && typeof highScore === 'number') {
                    badgeHtml = `<span class="score-badge good">Best: ${highScore}%</span>`;
                } else if (highScore !== undefined && typeof highScore === 'object') {
                    badgeHtml = `<span class="score-badge good">Best: ${highScore.percent}%</span>`;
                } else if (isClosed) {
                    // ‚≠ê NEW: Show "Not Taken" badge for closed quizzes without scores
                    badgeHtml = `<span class="score-badge" style="background:#f3f4f6; color:#9ca3af;">Not Taken</span>`;
                }
                
                // Show closed badge if quiz is closed
                if (isClosed) {
                    statusBadgeHtml = `<span class="quiz-closed-badge">Closed</span>`;
                }
                
                // Build dates display
                if (typeof statusInfo === 'object') {
                    const startDate = statusInfo.startDate || '';
                    const endDate = statusInfo.endDate || '';
                    
                    if (startDate && endDate) {
                        datesHtml = `<div class="quiz-dates">Available: ${startDate} - ${endDate}</div>`;
                    } else if (startDate) {
                        datesHtml = `<div class="quiz-dates">Opens: ${startDate}</div>`;
                    } else if (endDate) {
                        datesHtml = `<div class="quiz-dates">Closes: ${endDate}</div>`;
                    }
                }
                
                const div = document.createElement('div');
                div.className = `quiz-list-item ${isClosed ? 'closed' : ''}`;
                
                // ‚≠ê UPDATED: Show message for closed quizzes, or question count for active
                const subtitleText = isClosed 
                    ? 'No longer accepting responses' 
                    : (questionsShown > 0 ? questionsShown + ' Questions' : 'Coming Soon');
                
                div.innerHTML = `
                    <div class="quiz-info">
                        <span class="quiz-title">${title}${statusBadgeHtml}</span>
                        <span class="quiz-meta">${subtitleText}</span>
                        ${datesHtml}
                    </div>
                    ${badgeHtml}
                `;
                
                // Only make clickable if quiz is active
                if (!isClosed && isActive) {
                    div.onclick = () => showIntro(title);
                } else if (isClosed) {
                    div.onclick = () => {
                        const scoreMessage = highScore 
                            ? `Your score: ${highScore.score || highScore.percent || highScore}` 
                            : 'You did not take this quiz.';
                        alert(`This quiz is no longer accepting responses.\n\n${scoreMessage}`);
                    };
                }
                
                container.appendChild(div);
            });
        }

        function showIntro(title) {
            // Safety check: prevent taking closed quizzes
            const statusInfo = quizStatus[title] || { status: 'active' };
            const status = typeof statusInfo === 'object' ? statusInfo.status : statusInfo;
            
            if (status === 'closed') {
                alert('This quiz is no longer accepting responses.');
                return;
            }
            
            // Safety check: ensure quiz questions exist
            if (!allQuizzes[title] || allQuizzes[title].length === 0) {
                alert('This quiz is not currently available.');
                return;
            }
            
            currentQuizName = title;
            // ‚≠ê Store original questions but don't randomize yet
            currentQuizData = allQuizzes[title];
            
            document.getElementById('eligibility-display').classList.add('hidden');
            document.getElementById('selection-view').classList.add('hidden');
            document.getElementById('intro-view').classList.remove('hidden');
            document.getElementById('intro-title').innerText = title;
        }

        function startQuiz() {
            // ‚≠ê NOW apply randomization when quiz starts
            const originalQuestions = allQuizzes[currentQuizName];
            currentQuizData = prepareQuizQuestions(originalQuestions, QUESTIONS_PER_QUIZ);
            
            document.getElementById('intro-view').classList.add('hidden');
            document.getElementById('quiz-view').classList.remove('hidden');
            document.getElementById('active-quiz-title').innerText = currentQuizName;
            
            score = 0;
            userAnswers = {};
            renderQuestions();
        }

        function getVideoHtml(url) {
            if (!url || url.length < 5) return "";
            url = url.trim();
            let embed = "";
            
            const ytMatch = url.match(/(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/i);
            if (ytMatch && ytMatch[1]) {
                embed = `<div class="video-wrapper"><iframe src="https://www.youtube.com/embed/${ytMatch[1]}" frameborder="0" allowfullscreen></iframe></div>`;
            } else {
                const vimeoMatch = url.match(/(?:vimeo\.com\/|player\.vimeo\.com\/video\/)([0-9]+)/);
                if (vimeoMatch && vimeoMatch[1]) {
                    embed = `<div class="video-wrapper"><iframe src="https://player.vimeo.com/video/${vimeoMatch[1]}" frameborder="0" allowfullscreen></iframe></div>`;
                }
            }
            
            return `${embed}<a href="${url}" target="_blank" class="backup-link">Open Video in New Tab (if player fails)</a>`;
        }

        function renderQuestions() {
            const container = document.getElementById('questions-container');
            container.innerHTML = '';

            currentQuizData.forEach((q, index) => {
                const qDiv = document.createElement('div');
                qDiv.className = 'question-block';
                qDiv.id = `q-block-${index}`;

                const title = document.createElement('div');
                title.className = 'q-text';
                title.innerText = `${q.questionNumber}. ${q.question}`;
                qDiv.appendChild(title);

                if(q.video) {
                    const vidDiv = document.createElement('div');
                    vidDiv.innerHTML = getVideoHtml(q.video);
                    qDiv.appendChild(vidDiv);
                }

                const optsDiv = document.createElement('div');
                optsDiv.className = 'options-group';
                optsDiv.id = `options-${index}`;
                
                // ‚≠ê Options are already shuffled by prepareQuizQuestions
                q.options.forEach(optText => {
                    const btn = document.createElement('button');
                    btn.className = 'option-btn';
                    btn.innerText = optText;
                    btn.onclick = function() { selectAnswer(index, optText); };
                    optsDiv.appendChild(btn);
                });
                qDiv.appendChild(optsDiv);

                container.appendChild(qDiv);
            });
        }

        function selectAnswer(index, selectedText) {
            // Store the answer
            userAnswers[index] = selectedText;
            
            // Get the options container for this question
            const parent = document.getElementById(`options-${index}`);
            if (!parent) {
                console.error('Could not find options container for question', index);
                return;
            }
            
            // Get all buttons in this question
            const allBtns = parent.querySelectorAll('.option-btn');
            
            // Remove 'selected' class from all buttons
            allBtns.forEach(btn => {
                btn.classList.remove('selected');
            });
            
            // Add 'selected' class to the clicked button
            allBtns.forEach(btn => {
                if (btn.innerText === selectedText) {
                    btn.classList.add('selected');
                }
            });
            
            // Scroll to next question smoothly (better UX)
            if (index < currentQuizData.length - 1) {
                const nextQuestion = document.getElementById(`q-block-${index + 1}`);
                if (nextQuestion) {
                    setTimeout(() => {
                        nextQuestion.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }, 200);
                }
            }
        }

        function submitQuiz() {
            // Safety check: prevent submitting closed quizzes
            const statusInfo = quizStatus[currentQuizName] || { status: 'active' };
            const status = typeof statusInfo === 'object' ? statusInfo.status : statusInfo;
            
            if (status === 'closed') {
                alert('This quiz is no longer accepting responses. Your answers will not be saved.');
                location.reload();
                return;
            }
            
            const total = currentQuizData.length;
            const answeredCount = Object.keys(userAnswers).length;
            
            if(answeredCount < total) {
                if(!confirm(`You have only answered ${answeredCount} of ${total} questions. Submit anyway?`)) return;
            }

            // Calculate score
            score = 0;
            currentQuizData.forEach((q, index) => {
                const userAnswer = userAnswers[index];
                if (userAnswer && userAnswer.trim() === q.correctAnswer.trim()) {
                    score++;
                }
            });

            const percentage = Math.round((score / total) * 100);
            
            const finishBtn = document.getElementById('finishBtn');
            finishBtn.innerText = "Submitting Results...";
            finishBtn.disabled = true;

            // Build question results for backend
            const questionResults = [];
            currentQuizData.forEach((q, index) => {
                const userAnswer = userAnswers[index] || "";
                const isCorrect = userAnswer.trim() === q.correctAnswer.trim();
                
                questionResults.push({
                    questionNumber: q.questionNumber,
                    questionText: q.question,
                    studentAnswer: userAnswer,
                    correctAnswer: q.correctAnswer,
                    isCorrect: isCorrect
                });
            });

            const payload = {
                type: 'quiz_result',
                firstName: document.getElementById('firstName').value,
                lastName: document.getElementById('lastName').value,
                email: document.getElementById('userEmail').value,
                quizName: currentQuizName,
                score: `${score}/${total}`,
                percent: `${percentage}%`,
                questionResults: questionResults
            };

            // Submit to backend
            fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) })
            .then(() => {
                // ‚≠ê Go directly to result view (no review)
                const scoreDisplay = document.getElementById('score-display');
                scoreDisplay.innerText = `${percentage}%`;
                
                // Color code the score: Green for 80%+, Red for below 80%
                if (percentage >= 80) {
                    scoreDisplay.style.color = '#22c55e'; // Green
                } else {
                    scoreDisplay.style.color = '#ef4444'; // Red
                }
                
                document.getElementById('score-detail').innerText = `You got ${score} out of ${total} correct.`;
                
                document.getElementById('quiz-view').classList.add('hidden');
                document.getElementById('result-view').classList.remove('hidden');
            })
            .catch(err => {
                console.error("Submission error:", err);
                alert("Error submitting results. Please try again or contact your supervisor.");
                finishBtn.innerText = "Submit Quiz";
                finishBtn.disabled = false;
            });
        }
    </script>
</body>
</html>
