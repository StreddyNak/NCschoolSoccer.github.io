<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Supervisor Portal</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #f4f6f8; margin: 0; padding: 20px; color: #333; font-size: 14px; }
        .container { max-width: 1400px; margin: 0 auto; }
        
        /* Navigation */
        .nav-bar { 
            position: relative; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            margin-bottom: 40px; 
            padding: 10px 0;
        }
        .nav-center { display: flex; gap: 20px; }
        .nav-link { text-decoration: none; color: #4b5563; font-weight: 600; padding: 8px 16px; border-radius: 6px; font-size: 14px; transition: 0.2s; }
        .nav-link:hover { background-color: #e5e7eb; color: #111827; }
        .nav-link.active { background-color: #2ecc71; color: white; }
        
        .supervisor-link {
            position: absolute;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            text-decoration: none;
            color: #2c3e50;
            font-size: 0.85rem;
            font-weight: 600;
            border: 1px solid #d1d5db;
            padding: 6px 12px;
            border-radius: 4px;
            background: white;
            transition: all 0.2s;
        }
        .supervisor-link:hover { background: #f3f4f6; border-color: #9ca3af; }
        .supervisor-link.active { background: #2ecc71; color: white; border-color: #2ecc71; }
        
        @media (max-width: 800px) {
            .nav-bar { flex-direction: column; gap: 15px; }
            .supervisor-link { position: static; transform: none; margin-left: auto; }
            .nav-center { flex-wrap: wrap; justify-content: center; }
        }
        
        #login-view { max-width: 400px; margin: 60px auto; background: white; padding: 40px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); text-align: center; }
        .hidden { display: none !important; }
        
        /* Login Form Styles */
        .login-input { 
            width: 100%; 
            padding: 12px 15px; 
            border: 1px solid #ddd; 
            border-radius: 6px; 
            font-size: 14px; 
            box-sizing: border-box;
            margin-bottom: 15px;
        }
        .login-input:focus { 
            border-color: #2ecc71; 
            outline: none; 
        }
        .login-btn { 
            width: 100%; 
            padding: 12px; 
            background: #2ecc71; 
            color: white; 
            border: none; 
            border-radius: 6px; 
            font-size: 14px; 
            font-weight: 600; 
            cursor: pointer; 
            transition: 0.2s;
        }
        .login-btn:hover { background: #27ae60; }
        .login-btn:disabled { background: #95a5a6; cursor: not-allowed; }
        
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .season-nav { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #e0e0e0; }
        .season-btn { background: white; border: 1px solid #ccc; color: #555; padding: 6px 14px; border-radius: 20px; cursor: pointer; font-size: 13px; }
        .season-btn.active { background: #2ecc71; color: white; border-color: #2ecc71; }

        .filter-bar { display: flex; gap: 10px; margin-bottom: 20px; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); align-items: center; flex-wrap: wrap; }
        .search-input { flex-grow: 1; padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; min-width: 200px; font-size: 13px; }
        
        /* List Styles - IMPROVED */
        .list-header { 
            display: grid; 
            padding: 8px 15px; 
            font-size: 11px; 
            font-weight: 700; 
            color: #6b7280; 
            text-transform: uppercase; 
            letter-spacing: 0.5px;
            background: #f9fafb;
            border-radius: 6px;
            margin-bottom: 8px;
        }
        
        .list-row { 
            background: white; 
            border-radius: 8px; 
            padding: 10px 15px; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.06); 
            border-left: 4px solid #cbd5e1; 
            display: grid; 
            gap: 12px; 
            align-items: start;
            margin-bottom: 6px; 
            cursor: pointer;
            transition: all 0.2s;
            font-size: 13px;
        }
        
        .list-row:hover { 
            box-shadow: 0 4px 12px rgba(0,0,0,0.1); 
            transform: translateY(-1px);
        }
        
        .list-row.expanded { 
            background-color: #f0fdf4; 
            box-shadow: 0 4px 16px rgba(0,0,0,0.12);
        }
        
        /* CMI-specific styling - NEW LAYOUT */
        .cmi-header { grid-template-columns: 100px 2fr 1.5fr 2fr 2fr 100px; }
        .cmi-row { grid-template-columns: 100px 2fr 1.5fr 2fr 2fr 100px; }
        
        .row-red { border-left-color: #ef4444; } 
        .row-pk { border-left-color: #3b82f6; } 
        .row-goal { border-left-color: #10b981; }
        
        /* Column content styling */
        .col-date { font-weight: 600; color: #374151; font-size: 12px; }
        .col-match { 
            font-weight: 600; 
            color: #1f2937; 
            line-height: 1.4;
        }
        .col-match-level { 
            font-size: 11px; 
            color: #6b7280; 
            margin-top: 2px;
        }
        
        .col-referee { line-height: 1.4; }
        .col-referee-name { font-weight: 600; color: #374151; font-size: 13px; }
        .col-referee-region { font-size: 11px; color: #9ca3af; margin-top: 2px; }
        
        /* Meta tags styling - IMPROVED */
        .col-tags { display: flex; flex-wrap: wrap; gap: 4px; align-items: flex-start; }
        .meta-tag { 
            display: inline-block; 
            background: #f3f4f6; 
            padding: 3px 8px; 
            border-radius: 12px; 
            font-size: 11px;
            font-weight: 600;
            color: #4b5563; 
            white-space: nowrap;
        }
        .meta-tag.highlight { background: #dbeafe; color: #1e40af; }
        
        .col-moderator-notes { 
            font-size: 12px; 
            color: #6b7280; 
            line-height: 1.4;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }
        .list-row.expanded .col-moderator-notes { 
            -webkit-line-clamp: unset;
            overflow: visible;
        }
        
        .col-video { text-align: center; }
        .video-link { 
            display: inline-block;
            background: #3b82f6; 
            color: white; 
            padding: 4px 10px; 
            border-radius: 6px; 
            text-decoration: none; 
            font-size: 11px;
            font-weight: 600;
            transition: 0.2s;
        }
        .video-link:hover { background: #2563eb; }
        .video-none { color: #d1d5db; font-size: 11px; }
        
        /* Detail View - NEW */
        .detail-view {
            display: none;
            margin-top: 12px;
            padding: 15px;
            background: #fafbfc;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            grid-column: 1 / -1;
        }
        .list-row.expanded .detail-view { display: block; }
        
        .detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }
        
        .detail-item {
            background: white;
            padding: 10px 12px;
            border-radius: 6px;
            border: 1px solid #e5e7eb;
        }
        
        .detail-label {
            font-size: 10px;
            font-weight: 700;
            color: #9ca3af;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }
        
        .detail-value {
            font-size: 13px;
            color: #374151;
            line-height: 1.4;
        }
        
        .detail-value.empty {
            color: #d1d5db;
            font-style: italic;
        }
        
        /* Quiz-specific styling */
        .quiz-header { grid-template-columns: 2fr 1.5fr 50px 50px 4fr; }
        .quiz-row { grid-template-columns: 2fr 1.5fr 50px 50px 4fr; align-items: start; }

        /* Scrimmage checkbox styling */
        .scrim-check {
            font-size: 1.2rem;
            text-align: center;
}
        .scrim-check.attended { color: #22c55e; }
        .scrim-check.not-attended { color: #e5e7eb; }
        
        /* Question Analysis styling */
        .question-header { grid-template-columns: 80px 1fr 120px 150px 2fr; }
        .question-row { grid-template-columns: 80px 1fr 120px 150px 2fr; align-items: start; }
        .question-text { font-weight: 600; color: #2c3e50; line-height: 1.4; }
        .success-rate { font-size: 1.2rem; font-weight: bold; }
        .rate-good { color: #22c55e; }
        .rate-warning { color: #eab308; }
        .rate-poor { color: #ef4444; }
        .wrong-answers { font-size: 0.85rem; color: #666; margin-top: 5px; }
        .needs-attention { background: #fef3c7 !important; border-left-color: #eab308 !important; }
        
        .score-badge { padding: 4px 10px; border-radius: 12px; font-weight: bold; font-size: 0.9rem; text-align: center; display: inline-block; min-width: 60px; }
        .score-high { background: #dcfce7; color: #166534; } .score-med { background: #fef9c3; color: #854d0e; } .score-low { background: #fee2e2; color: #991b1b; }
        
        .score-fraction { font-weight: bold; font-size: 1rem; color: #2c3e50; }
        
        /* Quiz score cards */
        .quiz-score-card {
            background: #f9fafb;
            padding: 8px 12px;
            border-radius: 6px;
            flex: 1;
            min-width: 160px;
            max-width: 200px;
        }
        .quiz-score-card.high { border-left: 4px solid #22c55e; }
        .quiz-score-card.med { border-left: 4px solid #eab308; }
        .quiz-score-card.low { border-left: 4px solid #ef4444; }
        
        /* Stats Card */
        .stats-card { background: white; border-radius: 8px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); display: none; }
        .stats-card.show { display: block; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        .stat-item { text-align: center; padding: 15px; background: #f9fafb; border-radius: 6px; }
        .stat-value { font-size: 2rem; font-weight: bold; color: #2c3e50; }
        .stat-label { font-size: 0.9rem; color: #666; margin-top: 5px; }
        
        /* Impersonation Styles */
        .impersonation-banner { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            color: white; 
            padding: 15px 20px; 
            border-radius: 8px; 
            margin-bottom: 20px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            animation: slideDown 0.3s ease;
        }
        .master-controls {
            background: #f8fafc;
            border: 2px dashed #cbd5e1;
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>

    <div class="nav-bar">
        <div class="nav-center">
            <a href="index.html" class="nav-link">Home</a>
            <a href="report.html" class="nav-link">CMI Form</a>
            <a href="jersey.html" class="nav-link">Kit Search</a>
            <a href="eligibility" class="nav-link">Eligibility/Quizzes</a>
        </div>
        <a href="admin.html" class="supervisor-link active">ðŸ”’ Supervisors</a>
    </div>

    <div id="login-view">
        <h2>Supervisor Portal</h2>
        <p style="margin-bottom:25px; color:#666;">Please sign in with your credentials.</p>
        
        <input type="email" id="loginEmail" class="login-input" placeholder="Email Address" autocomplete="email">
        <input type="password" id="loginPassword" class="login-input" placeholder="Password" autocomplete="current-password">
        
        <button id="loginBtn" class="login-btn" onclick="handleLogin()">Sign In</button>
        
        <div id="login-error" style="color:#e74c3c; margin-top:20px; display:none; padding: 15px; background: #fee; border-radius: 6px; font-size: 0.9rem;"></div>
        <div id="login-status" style="color:#666; margin-top:15px; font-size:0.85rem; font-style:italic;"></div>
    </div>

    <div id="dashboard-view" class="container hidden">
        <div class="header">
            <div><h2 style="margin:0;">Dashboard</h2><small id="welcome-msg" style="color:#666;"></small></div>
            <button onclick="location.reload()" style="background:#e74c3c; color:white; border:none; padding:8px 15px; border-radius:4px; cursor:pointer; font-size: 13px;">Logout</button>
        </div>

        <!-- Impersonation Banner -->
        <div id="impersonation-banner" class="impersonation-banner hidden">
            <div style="display:flex; align-items:center; gap:10px;">
                <span style="font-size:1.2rem;">ðŸ‘¤</span>
                <div>
                    <strong>Impersonation Mode Active</strong><br>
                    <small>Viewing as: <span id="impersonated-name"></span></small>
                </div>
            </div>
            <button onclick="exitImpersonation()" style="background:white; color:#e74c3c; border:none; padding:6px 12px; border-radius:4px; cursor:pointer; font-weight:600; font-size: 12px;">Exit Impersonation</button>
        </div>

        <!-- Master Admin Controls -->
        <div id="master-controls" class="master-controls hidden">
            <div style="display:flex; align-items:center; gap:10px;">
                <label style="font-weight:600; color:#666; font-size: 13px;">ðŸ”§ View as Supervisor:</label>
                <select id="impersonate-select" onchange="handleImpersonation()" style="padding:8px 12px; border:1px solid #ddd; border-radius:6px; font-size: 13px; min-width:200px;">
                    <option value="">-- Select Supervisor --</option>
                </select>
            </div>
        </div>

        <div class="filter-bar">
            <select id="viewSelect" onchange="toggleView()" style="padding:8px 12px; border:2px solid #2ecc71; border-radius:6px; font-weight:bold; cursor:pointer; font-size: 13px;">
                <option value="cmi">Show CMI Reports</option>
                <option value="quiz">Show Test Results</option>
                <option value="questions">Question Analysis</option>
            </select>

            <input type="text" id="searchInput" class="search-input" placeholder="Search..." onkeyup="applyFilters()">
            
            <div id="cmi-filters" style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
                <select id="tagFilter" onchange="applyFilters()" style="padding:8px 12px; border:1px solid #ddd; border-radius:6px; font-size: 13px;">
                    <option value="">All Types</option>
                    <option value="Red">Red Cards</option>
                    <option value="Penalty">PKs</option>
                    <option value="Goal">No Goal</option>
                </select>
                <select id="metaTagFilter" onchange="applyFilters()" style="padding:8px 12px; border:1px solid #ddd; border-radius:6px; min-width:160px; font-size: 13px;">
                    <option value="">All Tags</option>
                </select>
                <label style="font-size:12px; font-weight:600;"><input type="checkbox" id="videoToggle" onchange="applyFilters()"> Video Only</label>
            </div>
            
            <div id="quiz-filters" style="display:none; gap:10px; align-items:center;">
                <select id="quizNameFilter" onchange="applyFilters()" style="padding:8px 12px; border:1px solid #ddd; border-radius:6px; min-width:200px; font-size: 13px;">
                    <option value="">All Quizzes</option>
                </select>
            </div>
            
            <div id="question-filters" style="display:none; gap:10px; align-items:center;">
                <select id="questionQuizFilter" onchange="applyFilters()" style="padding:8px 12px; border:1px solid #ddd; border-radius:6px; min-width:200px; font-size: 13px;">
                    <option value="">Select Quiz</option>
                </select>
                <label style="font-size:12px; font-weight:600;">
                    <input type="checkbox" id="problemsOnlyToggle" onchange="applyFilters()"> Show Problem Questions Only (<70%)
                </label>
            </div>
        </div>

        <div class="season-nav" id="season-nav">
            <button class="season-btn active" onclick="switchSeason('Current')">Current Season</button>
            <button class="season-btn" onclick="switchSeason('Boys 2025')">Boys 2025</button>
            <button class="season-btn" onclick="switchSeason('Girls 2025')">Girls 2025</button>
            <button class="season-btn" onclick="switchSeason('Boys 2024')">Boys 2024</button>
            <button class="season-btn" onclick="switchSeason('Girls 2024')">Girls 2024</button>
        </div>

        <div class="stats-card" id="stats-card">
            <div class="stats-grid" id="stats-grid"></div>
        </div>

        <div class="list-header cmi-header" id="list-header">
            <div>Date</div>
            <div>Match</div>
            <div>Referee</div>
            <div>Tags</div>
            <div>Moderator Notes</div>
            <div style="text-align:center;">Video</div>
        </div>

        <div id="data-list" class="list-container"></div>
    </div>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzi1gJkccUwLsjwPcepY_g9JY6nkLwcOxAn2dAEIw3YNQdWLuBl2lQYf6sOIM2WsRi3Cg/exec";
        let cmiData = [], quizData = [], questionStats = [], currentView = 'cmi';
        let actualSupervisor = null;
        let impersonatedSupervisor = null;
        let allSupervisors = [];

        // Handle Enter key on password field
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('loginPassword').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    handleLogin();
                }
            });
        });

        function handleLogin() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            
            const loginBtn = document.getElementById('loginBtn');
            const errorDiv = document.getElementById('login-error');
            const statusDiv = document.getElementById('login-status');
            
            if (!email || !password) {
                errorDiv.style.display = 'block';
                errorDiv.innerText = 'Please enter both email and password';
                return;
            }
            
            errorDiv.style.display = 'none';
            statusDiv.textContent = 'ðŸ”„ Authenticating...';
            statusDiv.style.display = 'block';
            loginBtn.disabled = true;
            loginBtn.textContent = 'Signing In...';
            
            console.log("Attempting login with email:", email);
            
            // Send email and password to backend
            fetch(`${SCRIPT_URL}?action=passwordLogin&email=${encodeURIComponent(email)}&password=${encodeURIComponent(password)}&season=Current`)
            .then(res => {
                console.log("Response received:", res.status);
                statusDiv.textContent = 'ðŸ”„ Loading data...';
                return res.json();
            })
            .then(resp => {
                console.log("Response data:", resp);
                
                if (resp.status === 'success') {
                    console.log("Login successful!");
                    console.log("CMI data count:", resp.data ? resp.data.length : 0);
                    
                    statusDiv.textContent = 'âœ… Success! Loading dashboard...';
                    
                    setTimeout(() => {
                        document.getElementById('login-view').classList.add('hidden');
                        document.getElementById('dashboard-view').classList.remove('hidden');
                    }, 500);
                    
                    actualSupervisor = resp.supervisor;
                    
                    document.getElementById('welcome-msg').textContent = `Logged in as: ${resp.supervisor}`;
                    cmiData = resp.data || [];
                    quizData = resp.quizzes || [];
                    questionStats = resp.questionStats || [];
                    
                    console.log("CMI data loaded:", cmiData.length, "reports");
                    console.log("Quiz data loaded:", quizData.length, "results");
                    console.log("Question stats loaded:", questionStats.length, "questions");
                    
                    if (resp.supervisor === 'MASTER' || resp.supervisor.toUpperCase().includes('MASTER')) {
                        document.getElementById('master-controls').classList.remove('hidden');
                        populateSupervisorList();
                    }
                    
                    populateMetaTagFilter();
                    applyFilters();
                } else {
                    console.error("Login failed:", resp.message || "Access denied");
                    
                    loginBtn.disabled = false;
                    loginBtn.textContent = 'Sign In';
                    
                    statusDiv.textContent = '';
                    statusDiv.style.display = 'none';
                    
                    errorDiv.style.display = 'block';
                    errorDiv.innerText = resp.message || "Invalid email or password.";
                }
            })
            .catch(err => {
                console.error("Fetch error:", err);
                
                loginBtn.disabled = false;
                loginBtn.textContent = 'Sign In';
                
                statusDiv.textContent = '';
                statusDiv.style.display = 'none';
                
                errorDiv.style.display = 'block';
                errorDiv.innerText = "Connection error. Please try again.";
            });
        }

        function switchSeason(seasonName) {
            document.querySelectorAll('.season-btn').forEach(btn => {
                btn.classList.remove('active');
                if(btn.innerText.includes(seasonName)) btn.classList.add('active');
            });
            fetchData(seasonName);
        }

        function fetchData(season) {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            
            if (!email || !password) {
                console.error("No credentials available");
                return;
            }
            
            console.log("Fetching data for season:", season);
            
            fetch(`${SCRIPT_URL}?action=passwordLogin&email=${encodeURIComponent(email)}&password=${encodeURIComponent(password)}&season=${season}`)
            .then(res => {
                console.log("Response received:", res.status);
                return res.json();
            })
            .then(resp => {
                console.log("Response data:", resp);
                
                if (resp.status === 'success') {
                    console.log("Data fetch successful!");
                    
                    actualSupervisor = resp.supervisor;
                    cmiData = resp.data || [];
                    quizData = resp.quizzes || [];
                    questionStats = resp.questionStats || [];
                    
                    console.log("CMI data loaded:", cmiData.length, "reports");
                    console.log("Quiz data loaded:", quizData.length, "results");
                    console.log("Question stats loaded:", questionStats.length, "questions");
                    
                    populateMetaTagFilter();
                    applyFilters();
                } else {
                    console.error("Data fetch failed:", resp.message);
                    alert("Session expired. Please log in again.");
                    location.reload();
                }
            })
            .catch(err => {
                console.error("Fetch error:", err);
                alert("Error loading data. Please try again.");
            });
        }
        
        function populateSupervisorList() {
            const supervisorSet = new Set();
            cmiData.forEach(item => {
                if (item.supervisor && item.supervisor !== 'MASTER') {
                    supervisorSet.add(item.supervisor);
                }
            });
            
            allSupervisors = Array.from(supervisorSet).sort();
            
            const dropdown = document.getElementById('impersonate-select');
            dropdown.innerHTML = '<option value="">-- View as Yourself (MASTER) --</option>';
            
            allSupervisors.forEach(sup => {
                const option = document.createElement('option');
                option.value = sup;
                option.textContent = sup;
                dropdown.appendChild(option);
            });
        }
        
        function populateMetaTagFilter() {
            const tagSet = new Set();
            
            cmiData.forEach(item => {
                if (item.tags) {
                    const tags = item.tags.split(',').map(t => t.trim()).filter(t => t);
                    tags.forEach(tag => tagSet.add(tag));
                }
            });
            
            const sortedTags = Array.from(tagSet).sort();
            
            const dropdown = document.getElementById('metaTagFilter');
            dropdown.innerHTML = '<option value="">All Tags</option>';
            
            sortedTags.forEach(tag => {
                const option = document.createElement('option');
                option.value = tag;
                option.textContent = tag;
                dropdown.appendChild(option);
            });
        }
        
        function handleImpersonation() {
            const selectedSupervisor = document.getElementById('impersonate-select').value;
            
            if (selectedSupervisor) {
                impersonatedSupervisor = selectedSupervisor;
                document.getElementById('impersonation-banner').classList.remove('hidden');
                document.getElementById('impersonated-name').textContent = selectedSupervisor;
            } else {
                impersonatedSupervisor = null;
                document.getElementById('impersonation-banner').classList.add('hidden');
            }
            
            applyFilters();
        }
        
        function exitImpersonation() {
            impersonatedSupervisor = null;
            document.getElementById('impersonate-select').value = '';
            document.getElementById('impersonation-banner').classList.add('hidden');
            applyFilters();
        }

        function toggleView() {
            currentView = document.getElementById('viewSelect').value;
            const cmiFilters = document.getElementById('cmi-filters');
            const quizFilters = document.getElementById('quiz-filters');
            const questionFilters = document.getElementById('question-filters');
            const seasonNav = document.getElementById('season-nav');
            const header = document.getElementById('list-header');
            const statsCard = document.getElementById('stats-card');

            if(currentView === 'quiz') {
                cmiFilters.style.display = 'none';
                quizFilters.style.display = 'flex';
                questionFilters.style.display = 'none';
                seasonNav.style.display = 'none';
                statsCard.classList.add('show');
                header.className = 'list-header quiz-header';
                header.innerHTML = '<div>Referee Name</div><div>Group</div><div style="text-align:center; font-size:0.7rem;">S1</div><div style="text-align:center; font-size:0.7rem;">S2</div><div>Quiz Scores</div>';
                
                populateQuizFilter();
            } else if(currentView === 'questions') {
                cmiFilters.style.display = 'none';
                quizFilters.style.display = 'none';
                questionFilters.style.display = 'flex';
                seasonNav.style.display = 'none';
                statsCard.classList.remove('show');
                header.className = 'list-header question-header';
                header.innerHTML = '<div>Quiz</div><div>Question</div><div style="text-align:center;">Success Rate</div><div style="text-align:center;">Attempts</div><div>Common Mistakes</div>';
                
                populateQuestionQuizFilter();
            } else {
                cmiFilters.style.display = 'flex';
                quizFilters.style.display = 'none';
                questionFilters.style.display = 'none';
                seasonNav.style.display = 'flex';
                statsCard.classList.remove('show');
                header.className = 'list-header cmi-header';
                header.innerHTML = '<div>Date</div><div>Match</div><div>Referee</div><div>Tags</div><div>Moderator Notes</div><div style="text-align:center;">Video</div>';
            }
            applyFilters();
        }
        
        function populateQuizFilter() {
            const dropdown = document.getElementById('quizNameFilter');
            const uniqueQuizzes = new Set();
            
            quizData.forEach(q => {
                if (q.quiz) uniqueQuizzes.add(q.quiz);
            });
            
            const sortedQuizzes = Array.from(uniqueQuizzes).sort();
            
            dropdown.innerHTML = '<option value="">All Quizzes</option>';
            
            sortedQuizzes.forEach(quizName => {
                const option = document.createElement('option');
                option.value = quizName;
                option.textContent = quizName;
                dropdown.appendChild(option);
            });
        }
        
        function populateQuestionQuizFilter() {
            const dropdown = document.getElementById('questionQuizFilter');
            const uniqueQuizzes = new Set();
            
            questionStats.forEach(q => {
                if (q.quiz) uniqueQuizzes.add(q.quiz);
            });
            
            const sortedQuizzes = Array.from(uniqueQuizzes).sort();
            
            dropdown.innerHTML = '<option value="">Select Quiz</option>';
            
            sortedQuizzes.forEach(quizName => {
                const option = document.createElement('option');
                option.value = quizName;
                option.textContent = quizName;
                dropdown.appendChild(option);
            });
        }

        function applyFilters() {
            const term = document.getElementById('searchInput').value.toLowerCase();
            const list = document.getElementById('data-list');
            list.innerHTML = '';

            if (currentView === 'cmi') {
                const tag = document.getElementById('tagFilter').value;
                const metaTag = document.getElementById('metaTagFilter').value;
                const vid = document.getElementById('videoToggle').checked;

                const effectiveSupervisor = impersonatedSupervisor || actualSupervisor;

                const filtered = cmiData.filter(item => {
                    if (effectiveSupervisor !== 'MASTER' && !String(item.supervisor).includes(effectiveSupervisor)) {
                        return false;
                    }
                    
                    if (vid && !(item.video||"").toString().startsWith("http")) return false;
                    if (tag && !(item.cmi||"").includes(tag)) return false;
                    
                    if (metaTag) {
                        const itemTags = (item.tags || "").split(',').map(t => t.trim());
                        if (!itemTags.includes(metaTag)) return false;
                    }
                    
                    return JSON.stringify(item).toLowerCase().includes(term);
                }).sort((a,b) => new Date(b.gameDate) - new Date(a.gameDate));

                filtered.forEach(item => {
                    let rClass = '';
                    if ((item.cmi||"").includes('Red')) rClass='row-red';
                    else if ((item.cmi||"").includes('Penalty')) rClass='row-pk';
                    else if ((item.cmi||"").includes('Goal')) rClass='row-goal';
                    
                    const vidBtn = (item.video||"").startsWith("http") 
                        ? `<a href="${item.video}" target="_blank" class="video-link">Watch</a>` 
                        : `<span class="video-none">No Video</span>`;

                    // Parse tags
                    let tagsHtml = '<div class="col-tags">';
                    if (item.tags) {
                        const tags = item.tags.split(',').map(t => t.trim()).filter(t => t);
                        if (tags.length > 0) {
                            tags.forEach(t => {
                                const isHighlighted = metaTag && t === metaTag;
                                tagsHtml += `<span class="meta-tag ${isHighlighted ? 'highlight' : ''}">${t}</span>`;
                            });
                        } else {
                            tagsHtml += '<span class="meta-tag" style="background:#f9fafb; color:#d1d5db;">No tags</span>';
                        }
                    } else {
                        tagsHtml += '<span class="meta-tag" style="background:#f9fafb; color:#d1d5db;">No tags</span>';
                    }
                    tagsHtml += '</div>';

                    // Extract region from supervisor name
                    const supervisorName = item.supervisor || "";
                    const regionMatch = supervisorName.match(/\(([^)]+)\)/);
                    const region = regionMatch ? regionMatch[1] : "";
                    const refereeName = item.refName || "Unknown";

                    const div = document.createElement('div');
                    div.className = `list-row cmi-row ${rClass}`;
                    div.onclick = (e) => { 
                        if(e.target.tagName !== 'A') {
                            div.classList.toggle('expanded'); 
                        }
                    };
                    
                    div.innerHTML = `
                        <div class="col-date">${item.gameDate}</div>
                        <div class="col-match">
                            <div>${item.home} vs ${item.away}</div>
                            <div class="col-match-level">${item.level}</div>
                        </div>
                        <div class="col-referee">
                            <div class="col-referee-name">${refereeName}</div>
                            <div class="col-referee-region">${region}</div>
                        </div>
                        ${tagsHtml}
                        <div class="col-moderator-notes">${item.moderatorNotes || '<span style="color:#d1d5db; font-style:italic;">No notes</span>'}</div>
                        <div class="col-video">${vidBtn}</div>
                        <div class="detail-view">
                            <div class="detail-grid">
                                <div class="detail-item">
                                    <div class="detail-label">CMI Type</div>
                                    <div class="detail-value">${item.cmi || '-'}</div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-label">Half</div>
                                    <div class="detail-value">${item.half || '-'}</div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-label">Time Remaining</div>
                                    <div class="detail-value">${item.time || '-'}</div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-label">Submitted By</div>
                                    <div class="detail-value">${item.refName || '-'}</div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-label">Regional Supervisor</div>
                                    <div class="detail-value">${item.supervisor || '-'}</div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-label">Timestamp</div>
                                    <div class="detail-value">${item.timestamp || '-'}</div>
                                </div>
                                <div class="detail-item" style="grid-column: 1 / -1;">
                                    <div class="detail-label">Referee Notes</div>
                                    <div class="detail-value ${!item.notes ? 'empty' : ''}">${item.notes || 'No referee notes provided'}</div>
                                </div>
                                <div class="detail-item" style="grid-column: 1 / -1;">
                                    <div class="detail-label">Video Link</div>
                                    <div class="detail-value">${item.video ? `<a href="${item.video}" target="_blank" style="color:#3b82f6;">${item.video}</a>` : '<span class="empty">No video link</span>'}</div>
                                </div>
                            </div>
                        </div>
                    `;
                    list.appendChild(div);
                });
            } else if (currentView === 'quiz') {
                console.log("Quiz Data Received:", quizData);
                
                if (!quizData || quizData.length === 0) {
                    list.innerHTML = '<div style="padding:40px; text-align:center; color:#666;"><h3>No Quiz Results Found</h3><p>Quiz results will appear here once students complete quizzes.</p></div>';
                    document.getElementById('stats-grid').innerHTML = '';
                    return;
                }
                
                const selectedQuiz = document.getElementById('quizNameFilter').value;
                
                const effectiveSupervisor = impersonatedSupervisor || actualSupervisor;
                const supervisorRegion = extractRegionFromSupervisor(effectiveSupervisor);
                
                const studentQuizzes = {};
                
                quizData.forEach(q => {
                    const email = q.email;
                    
                    if (!studentQuizzes[email]) {
                        studentQuizzes[email] = {
    name: q.name,
    email: q.email,
    group: q.group || "Unknown",
    quizzes: {},
    scrimmage1: q.scrimmage1 || false,
    scrimmage2: q.scrimmage2 || false,
    playoffEligible: q.playoffEligible || false
};
                    }
                    
                    const quizName = q.quiz;
                    const percent = parseFloat(q.percent) || 0;
                    
                    if (!studentQuizzes[email].quizzes[quizName] || percent > parseFloat(studentQuizzes[email].quizzes[quizName].percent)) {
                        studentQuizzes[email].quizzes[quizName] = {
                            score: q.score,
                            percent: q.percent,
                            date: q.date
                        };
                    }
                });
                
                let filtered = Object.values(studentQuizzes).filter(student => {
                    if (!JSON.stringify(student).toLowerCase().includes(term)) return false;
                    
                    if (selectedQuiz && !student.quizzes[selectedQuiz]) return false;
                    
                    if (supervisorRegion && !matchesRegion(student.group, supervisorRegion)) {
                        return false;
                    }
                    
                    return true;
                }).sort((a, b) => a.name.localeCompare(b.name));
                
                updateQuizStats(filtered, selectedQuiz);
                
                if (filtered.length === 0) {
                    list.innerHTML = '<div style="padding:40px; text-align:center; color:#666;"><p>No results match your filters.</p></div>';
                    return;
                }
                
                filtered.forEach(student => {
                    const div = document.createElement('div');
                    div.className = 'list-row quiz-row';
                    
                    let quizScoresHtml = '<div style="display: flex; flex-wrap: wrap; gap: 8px;">';
                    
                    const quizNames = Object.keys(student.quizzes).sort();
                    const quizzesToShow = selectedQuiz ? [selectedQuiz] : quizNames;
                    
                    quizzesToShow.forEach(quizName => {
                        if (!student.quizzes[quizName]) return;
                        
                        const quiz = student.quizzes[quizName];
                        const p = parseFloat(quiz.percent);
                        let bClass = 'score-low';
                        if (p >= 90) bClass = 'score-high';
                        else if (p >= 70) bClass = 'score-med';
                        
                        quizScoresHtml += `
                            <div style="background: #f9fafb; padding: 8px 12px; border-radius: 6px; border-left: 4px solid ${bClass === 'score-high' ? '#22c55e' : bClass === 'score-med' ? '#eab308' : '#ef4444'}; flex: 1; min-width: 160px; max-width: 200px;">
                                <div style="font-weight: 600; color: #2c3e50; margin-bottom: 3px; font-size: 0.9rem;">${quizName}</div>
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span style="font-size: 1rem; font-weight: bold; color: #2c3e50;">${quiz.score || 'N/A'}</span>
                                    <span class="score-badge ${bClass}" style="margin-left: 8px; padding: 3px 8px; font-size: 0.85rem;">${quiz.percent}%</span>
                                </div>
                                <div style="font-size: 0.7rem; color: #999; margin-top: 3px;">${quiz.date}</div>
                            </div>
                        `;
                    });
                    
                    quizScoresHtml += '</div>';
                    
                    // Add scrimmage checkboxes
const scrim1Icon = student.scrimmage1 ? 'âœ“' : 'â—‹';
const scrim2Icon = student.scrimmage2 ? 'âœ“' : 'â—‹';
const scrim1Class = student.scrimmage1 ? 'attended' : 'not-attended';
const scrim2Class = student.scrimmage2 ? 'attended' : 'not-attended';

div.innerHTML = `
    <div style="font-weight:bold; padding-right: 15px;">
        ${student.name}
        <br><small style="font-weight:normal; color:#888;">${student.email}</small>
    </div>
    <div style="color:#666; font-size:0.95rem; padding-right: 15px;">
        <span style="display: inline-block; background: #e5e7eb; padding: 4px 12px; border-radius: 12px; font-weight: 600;">${student.group}</span>
    </div>
    <div class="scrim-check ${scrim1Class}">${scrim1Icon}</div>
    <div class="scrim-check ${scrim2Class}">${scrim2Icon}</div>
    ${quizScoresHtml}
`;
                    list.appendChild(div);
                });
            } else if (currentView === 'questions') {
                console.log("Question stats data:", questionStats);
                
                if (!questionStats || questionStats.length === 0) {
                    list.innerHTML = '<div style="padding:40px; text-align:center; color:#666;"><h3>No Question Data Found</h3><p>Question-level data will appear here once students take quizzes.</p></div>';
                    return;
                }
                
                const selectedQuiz = document.getElementById('questionQuizFilter').value;
                const problemsOnly = document.getElementById('problemsOnlyToggle').checked;
                
                const effectiveSupervisor = impersonatedSupervisor || actualSupervisor;
                const supervisorRegion = extractRegionFromSupervisor(effectiveSupervisor);
                
                let filtered = questionStats.filter(q => {
                    if (!JSON.stringify(q).toLowerCase().includes(term)) return false;
                    
                    if (!selectedQuiz) return false;
                    if (q.quiz !== selectedQuiz) return false;
                    
                    if (problemsOnly && q.successRate >= 70) return false;
                    
                    if (supervisorRegion && !Object.keys(q.studentGroups).some(group => matchesRegion(group, supervisorRegion))) {
                        return false;
                    }
                    
                    return true;
                }).sort((a, b) => a.questionNumber - b.questionNumber);
                
                if (!selectedQuiz) {
                    list.innerHTML = '<div style="padding:40px; text-align:center; color:#666;"><p>Please select a quiz from the dropdown above to view question analysis.</p></div>';
                    return;
                }
                
                if (filtered.length === 0) {
                    list.innerHTML = '<div style="padding:40px; text-align:center; color:#666;"><p>No questions match your filters.</p></div>';
                    return;
                }
                
                filtered.forEach(q => {
                    const rateClass = q.successRate >= 80 ? 'rate-good' : q.successRate >= 60 ? 'rate-warning' : 'rate-poor';
                    const needsAttention = q.successRate < 70;
                    
                    const div = document.createElement('div');
                    div.className = `list-row question-row ${needsAttention ? 'needs-attention' : ''}`;
                    
                    let wrongAnswersHtml = '';
                    if (q.mostCommonWrongAnswer && q.mostCommonWrongCount > 0) {
                        wrongAnswersHtml = `<div class="wrong-answers">Most common: "${q.mostCommonWrongAnswer}" (${q.mostCommonWrongCount} times)</div>`;
                    }
                    
                    div.innerHTML = `
                        <div style="font-weight:bold; color:#2c3e50; font-size:1.1rem;">Q${q.questionNumber}</div>
                        <div class="question-text">${q.questionText}</div>
                        <div style="text-align:center;">
                            <div class="success-rate ${rateClass}">${q.successRate}%</div>
                            <div style="font-size:0.75rem; color:#999; margin-top:3px;">
                                ${needsAttention ? 'âš ï¸ Needs Review' : q.successRate >= 80 ? 'âœ“ Good' : '~ OK'}
                            </div>
                        </div>
                        <div style="text-align:center; color:#666;">
                            <div style="font-weight:600;">${q.correctAttempts}/${q.totalAttempts}</div>
                            <div style="font-size:0.75rem; color:#999;">${q.correctAttempts} correct</div>
                        </div>
                        <div>
                            <div style="font-size:0.9rem; color:#2c3e50; margin-bottom:3px;"><strong>Correct:</strong> ${q.correctAnswer}</div>
                            ${wrongAnswersHtml}
                        </div>
                    `;
                    list.appendChild(div);
                });
            }
        }
        
        function extractRegionFromSupervisor(supervisorName) {
            if (!supervisorName || supervisorName === 'MASTER') return null;
            
            const match = supervisorName.match(/\(([^)]+)\)/);
            return match ? match[1] : null;
        }
        
        function matchesRegion(studentGroup, supervisorRegion) {
            if (!studentGroup || !supervisorRegion) return false;
            
            const normalizedGroup = studentGroup.toLowerCase().trim();
            const normalizedRegion = supervisorRegion.toLowerCase().trim();
            
            if (normalizedGroup === normalizedRegion) return true;
            
            if (normalizedGroup.includes(normalizedRegion) || normalizedRegion.includes(normalizedGroup)) {
                return true;
            }
            
            return false;
        }
        
        function updateQuizStats(filteredData, selectedQuiz) {
            const statsGrid = document.getElementById('stats-grid');
            
            if (filteredData.length === 0) {
                statsGrid.innerHTML = '';
                return;
            }
            
            const quizCounts = {};
            filteredData.forEach(student => {
                Object.keys(student.quizzes).forEach(quizName => {
                    if (!selectedQuiz || selectedQuiz === quizName) {
                        quizCounts[quizName] = (quizCounts[quizName] || 0) + 1;
                    }
                });
            });
            
            const sortedQuizNames = Object.keys(quizCounts).sort();
            
            let statsHtml = '';
            
            statsHtml += `
                <div class="stat-item">
                    <div class="stat-value">${filteredData.length}</div>
                    <div class="stat-label">Total Students</div>
                </div>
            `;
            
            if (selectedQuiz) {
                statsHtml += `
                    <div class="stat-item">
                        <div class="stat-value">${quizCounts[selectedQuiz] || 0}</div>
                        <div class="stat-label">${selectedQuiz} Attempts</div>
                    </div>
                `;
            } else {
                sortedQuizNames.forEach(quizName => {
                    statsHtml += `
                        <div class="stat-item">
                            <div class="stat-value">${quizCounts[quizName]}</div>
                            <div class="stat-label">${quizName}</div>
                        </div>
                    `;
                });
            }
            
            statsGrid.innerHTML = statsHtml;
        }
    </script>
</body>
</html>
