<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supervisor Portal</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #f4f6f8; margin: 0; padding: 20px; color: #333; font-size: 14px; }
        .container { max-width: 1400px; margin: 0 auto; }
        
        /* Navigation */
        .nav-bar { 
            position: relative; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            margin-bottom: 40px; 
            padding: 10px 0;
        }
        .nav-center { display: flex; gap: 20px; flex-wrap: wrap; justify-content: center; }
        .nav-link { text-decoration: none; color: #4b5563; font-weight: 600; padding: 8px 16px; border-radius: 6px; font-size: 14px; transition: 0.2s; white-space: nowrap; }
        .nav-link:hover { background-color: #e5e7eb; color: #111827; }
        .nav-link.active { background-color: #2ecc71; color: white; }
        
        .supervisor-link {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            text-decoration: none;
            color: #2c3e50;
            font-size: 0.85rem;
            font-weight: 600;
            border: 1px solid #d1d5db;
            padding: 6px 12px;
            border-radius: 4px;
            background: white;
            transition: all 0.2s;
        }
        .supervisor-link:hover { background: #f3f4f6; border-color: #9ca3af; }
        .supervisor-link.active { background: #2ecc71; color: white; border-color: #2ecc71; }
        
        #login-view { max-width: 400px; margin: 60px auto; background: white; padding: 40px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); text-align: center; }
        .hidden { display: none !important; }
        
        /* Login Form Styles */
        .login-input { 
            width: 100%; 
            padding: 12px 15px; 
            border: 1px solid #ddd; 
            border-radius: 6px; 
            font-size: 14px; 
            box-sizing: border-box;
            margin-bottom: 15px;
        }
        .login-input:focus { 
            border-color: #2ecc71; 
            outline: none; 
        }
        .login-btn { 
            width: 100%; 
            padding: 12px; 
            background: #2ecc71; 
            color: white; 
            border: none; 
            border-radius: 6px; 
            font-size: 14px; 
            font-weight: 600; 
            cursor: pointer; 
            transition: 0.2s;
        }
        .login-btn:hover { background: #27ae60; }
        .login-btn:disabled { background: #95a5a6; cursor: not-allowed; }
        
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .season-nav { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #e0e0e0; }
        .season-btn { background: white; border: 1px solid #ccc; color: #555; padding: 6px 14px; border-radius: 20px; cursor: pointer; font-size: 13px; }
        .season-btn.active { background: #2ecc71; color: white; border-color: #2ecc71; }

        .filter-bar { display: flex; gap: 10px; margin-bottom: 20px; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); align-items: center; flex-wrap: wrap; }
        .search-input { flex-grow: 1; padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; min-width: 200px; font-size: 13px; }
        
        /* List Styles */
        .list-header { 
            display: grid; 
            padding: 8px 15px; 
            font-size: 11px; 
            font-weight: 700; 
            color: #6b7280; 
            text-transform: uppercase; 
            letter-spacing: 0.5px;
            background: #f9fafb;
            border-radius: 6px;
            margin-bottom: 8px;
        }
        
        .list-row { 
            background: white; 
            border-radius: 8px; 
            padding: 10px 15px; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.06); 
            border-left: 4px solid #cbd5e1; 
            display: grid; 
            gap: 12px; 
            align-items: start;
            margin-bottom: 6px; 
            cursor: pointer;
            transition: all 0.2s;
            font-size: 13px;
        }
        
        .list-row:hover { 
            box-shadow: 0 4px 12px rgba(0,0,0,0.1); 
            transform: translateY(-1px);
        }
        
        .list-row.expanded { 
            background-color: #f0fdf4; 
            box-shadow: 0 4px 16px rgba(0,0,0,0.12);
        }
        
        /* CMI-specific styling */
        .cmi-header { grid-template-columns: 100px 2fr 1.5fr 2fr 2fr 100px; }
        .cmi-row { grid-template-columns: 100px 2fr 1.5fr 2fr 2fr 100px; }
        
        .row-red { border-left-color: #ef4444; } 
        .row-pk { border-left-color: #3b82f6; } 
        .row-goal { border-left-color: #10b981; }
        
        /* Column content styling */
        .col-date { font-weight: 600; color: #374151; font-size: 12px; }
        .col-match { 
            font-weight: 600; 
            color: #1f2937; 
            line-height: 1.4;
        }
        .col-match-level { 
            font-size: 11px; 
            color: #6b7280; 
            margin-top: 2px;
        }
        
        .col-referee { line-height: 1.3; }
        .col-referee-name { font-weight: 600; color: #374151; font-size: 13px; margin-bottom: 3px; }
        .col-referee-region { font-size: 10px; color: #9ca3af; margin-top: 0; }
        
        /* Meta tags styling */
        .col-tags { display: flex; flex-wrap: wrap; gap: 4px; align-items: flex-start; }
        .meta-tag { 
            display: inline-block; 
            background: #f3f4f6; 
            padding: 3px 8px; 
            border-radius: 12px; 
            font-size: 11px;
            font-weight: 600;
            color: #4b5563; 
            white-space: nowrap;
        }
        .meta-tag.highlight { background: #dbeafe; color: #1e40af; }
        
        .col-moderator-notes { 
            font-size: 12px; 
            color: #6b7280; 
            line-height: 1.4;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }
        .list-row.expanded .col-moderator-notes { 
            -webkit-line-clamp: unset;
            overflow: visible;
        }
        
        .col-video { text-align: center; }
        .video-link { 
            display: inline-block;
            background: #3b82f6; 
            color: white; 
            padding: 4px 10px; 
            border-radius: 6px; 
            text-decoration: none; 
            font-size: 11px;
            font-weight: 600;
            transition: 0.2s;
        }
        .video-link:hover { background: #2563eb; }
        .video-none { color: #d1d5db; font-size: 11px; }
        
        /* Detail View */
        .detail-view {
            display: none;
            margin-top: 12px;
            padding: 15px;
            background: #fafbfc;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            grid-column: 1 / -1;
        }
        .list-row.expanded .detail-view { display: block; }
        
        .detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }
        
        .detail-item {
            background: white;
            padding: 10px 12px;
            border-radius: 6px;
            border: 1px solid #e5e7eb;
        }
        
        .detail-label {
            font-size: 10px;
            font-weight: 700;
            color: #9ca3af;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }
        
        .detail-value {
            font-size: 13px;
            color: #374151;
            line-height: 1.4;
        }
        
        .detail-value.empty {
            color: #d1d5db;
            font-style: italic;
        }
        
        /* Quiz-specific styling */
        .quiz-header { grid-template-columns: 2fr 1.5fr 60px 60px 4fr; }
        .quiz-row { grid-template-columns: 2fr 1.5fr 60px 60px 4fr; align-items: center; }

        /* Scrimmage checkbox styling */
        .scrim-check {
            font-size: 1.4rem;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
        }
        .scrim-check.attended { color: #22c55e; }
        .scrim-check.not-attended { color: #e5e7eb; }

        /* Quiz score cards */
        .quiz-scores-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .quiz-score-card {
            background: #f9fafb;
            padding: 8px 12px;
            border-radius: 6px;
            flex: 0 1 auto;
            min-width: 140px;
            max-width: 180px;
        }

        .quiz-score-card.high { 
            border-left: 4px solid #22c55e;
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
        }

        .quiz-score-card.low { 
            border-left: 4px solid #ef4444;
            background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
        }

        .quiz-score-card.none {
            border-left: 4px solid #e5e7eb;
            background: #f9fafb;
        }

        .quiz-name-label {
            font-weight: 600;
            color: #2c3e50;
            font-size: 0.85rem;
            margin-bottom: 4px;
            display: block;
        }

        .quiz-score-value {
            font-size: 0.95rem;
            font-weight: bold;
            color: #374151;
        }

        .quiz-score-value.not-taken {
            color: #9ca3af;
            font-style: italic;
            font-weight: normal;
        }

        .quiz-date {
            font-size: 0.7rem;
            color: #999;
            margin-top: 3px;
        }
        
        /* NEW: Attempt count badge */
        .attempt-count {
            font-size: 0.75rem;
            color: #6b7280;
            background: #f3f4f6;
            padding: 2px 8px;
            border-radius: 10px;
            display: inline-block;
            margin-top: 4px;
        }
        
        /* Question Analysis styling */
        .question-header { grid-template-columns: 1fr 120px 2fr; }
        .question-row { grid-template-columns: 1fr 120px 2fr; align-items: start; }
        .question-text { font-weight: 600; color: #2c3e50; line-height: 1.4; }
        .success-rate { font-size: 1.2rem; font-weight: bold; color: #374151; }
        .wrong-answers { font-size: 0.85rem; color: #666; margin-top: 5px; }
        .lowest-performer { background: #fef3c7 !important; border-left-color: #eab308 !important; }
        
        /* Answer breakdown in expanded view */
        .answer-breakdown {
            display: none;
            margin-top: 12px;
            padding: 15px;
            background: #fafbfc;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            grid-column: 1 / -1;
        }
        .list-row.expanded .answer-breakdown { display: block; }
        
        .answer-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            margin-bottom: 6px;
            background: white;
            border-radius: 4px;
            border-left: 3px solid #e5e7eb;
        }
        .answer-item.correct {
            border-left-color: #22c55e;
            background: #f0fdf4;
        }
        .answer-item.incorrect {
            border-left-color: #ef4444;
        }
        .answer-text {
            font-weight: 600;
            color: #374151;
            flex: 1;
        }
        .answer-stats {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .answer-count {
            font-size: 0.9rem;
            color: #6b7280;
        }
        .answer-bar {
            width: 150px;
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
        }
        .answer-bar-fill {
            height: 100%;
            background: #3b82f6;
            transition: width 0.3s ease;
        }
        .answer-bar-fill.correct {
            background: #22c55e;
        }
        .answer-bar-fill.incorrect {
            background: #ef4444;
        }
        .answer-percent {
            min-width: 45px;
            text-align: right;
            font-weight: 600;
            color: #374151;
        }
        
        /* Stats Card */
        .stats-card { background: white; border-radius: 8px; padding: 15px 20px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); display: none; }
        .stats-card.show { display: block; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; }
        .stat-item { text-align: center; padding: 12px; background: #f9fafb; border-radius: 6px; border-left: 4px solid #2ecc71; }
        .stat-value { font-size: 1.5rem; font-weight: bold; color: #2c3e50; }
        .stat-label { font-size: 0.8rem; color: #666; margin-top: 4px; font-weight: 600; }
        
        /* NEW: Quiz Detail Stats */
        .quiz-detail-stats {
            background: #f0fdf4;
            border: 1px solid #bbf7d0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            display: none;
        }
        .quiz-detail-stats.show { display: block; }
        .quiz-detail-stats h4 {
            margin: 0 0 10px 0;
            color: #2c3e50;
            font-size: 1rem;
        }
        .quiz-detail-stats p {
            margin: 5px 0;
            color: #374151;
            font-size: 0.9rem;
        }
        .quiz-detail-stats strong {
            color: #166534;
        }
        
        /* Impersonation Styles */
        .impersonation-banner { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            color: white; 
            padding: 15px 20px; 
            border-radius: 8px; 
            margin-bottom: 20px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            animation: slideDown 0.3s ease;
        }
        .master-controls {
            background: #f8fafc;
            border: 2px dashed #cbd5e1;
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* ========== MOBILE RESPONSIVE STYLES ========== */
        @media (max-width: 800px) {
            .nav-bar { flex-direction: column; gap: 15px; }
            .supervisor-link { 
                position: static; 
                transform: none; 
                margin: 0 auto;
                display: block;
                text-align: center;
            }
            .nav-center { flex-wrap: wrap; justify-content: center; }
        }
        
        @media (max-width: 768px) {
            body { padding: 10px; font-size: 13px; }
            .container { max-width: 100%; }
            
            .header { flex-direction: column; gap: 15px; align-items: stretch; }
            .header button { width: 100%; }
            
            .filter-bar { 
                flex-direction: column; 
                align-items: stretch; 
                gap: 12px;
            }
            .search-input { min-width: 100%; }
            #cmi-filters, #quiz-filters, #question-filters { 
                flex-direction: column; 
                align-items: stretch;
                width: 100%;
            }
            #cmi-filters select, #quiz-filters select, #question-filters select {
                width: 100%;
            }
            #cmi-filters label, #quiz-filters label, #question-filters label {
                width: 100%;
                display: block;
                padding: 10px;
                background: #f9fafb;
                border-radius: 6px;
                text-align: center;
            }
            
            .season-nav { 
                gap: 6px;
                justify-content: center;
            }
            .season-btn { 
                padding: 8px 12px; 
                font-size: 12px;
                flex: 1 1 auto;
                min-width: calc(50% - 3px);
            }
            
            /* Mobile CMI Layout - Stack vertically */
            .cmi-header { 
                display: none; /* Hide header on mobile */
            }
            .cmi-row { 
                grid-template-columns: 1fr;
                gap: 8px;
                padding: 15px;
            }
            .cmi-row > div {
                padding: 8px 0;
                border-bottom: 1px solid #f0f0f0;
            }
            .cmi-row > div:last-child {
                border-bottom: none;
            }
            /* Add labels for mobile */
            .col-date::before { content: "Date: "; font-weight: 700; color: #6b7280; }
            .col-match::before { content: "Match: "; font-weight: 700; color: #6b7280; display: block; }
            .col-referee::before { content: "Referee: "; font-weight: 700; color: #6b7280; display: block; }
            .col-tags::before { content: "Tags: "; font-weight: 700; color: #6b7280; display: block; margin-bottom: 6px; }
            .col-moderator-notes::before { content: "Notes: "; font-weight: 700; color: #6b7280; display: block; margin-bottom: 4px; }
            .col-video::before { content: "Video: "; font-weight: 700; color: #6b7280; display: block; margin-bottom: 6px; }
            .col-video { text-align: left; }
            
            /* Mobile Quiz Layout */
            .quiz-header { display: none; }
            .quiz-row {
                grid-template-columns: 1fr;
                gap: 12px;
                padding: 15px;
            }
            .quiz-row > div {
                padding: 8px 0;
            }
            /* Add labels for mobile quiz view */
            .quiz-row > .col-referee::before { content: "Referee: "; }
            .quiz-row > div:nth-child(2)::before { content: "Email: "; font-weight: 700; color: #6b7280; display: block; margin-bottom: 4px; }
            
            /* Scrimmage section on mobile */
            .scrim-check {
                display: inline-flex;
                margin-right: 20px;
                font-size: 1.2rem;
            }
            .scrim-check::before {
                content: "Scrimmage ";
                font-weight: 700;
                color: #6b7280;
                font-size: 0.85rem;
                margin-right: 8px;
            }
            .quiz-row > div:nth-child(3)::before { content: "S1: "; }
            .quiz-row > div:nth-child(4)::before { content: "S2: "; }
            
            .quiz-scores-container {
                flex-direction: column;
                gap: 10px;
                border-top: 1px solid #e5e7eb;
                padding-top: 12px;
                margin-top: 8px;
            }
            .quiz-scores-container::before {
                content: "Quiz Scores:";
                font-weight: 700;
                color: #6b7280;
                display: block;
                margin-bottom: 8px;
            }
            .quiz-score-card {
                max-width: 100%;
                min-width: 100%;
            }
            
            /* Mobile Question Layout */
            .question-header { display: none; }
            .question-row {
                grid-template-columns: 1fr;
                gap: 10px;
                padding: 15px;
            }
            .question-row > div:first-child::before {
                content: "Question: ";
                font-weight: 700;
                color: #6b7280;
                display: block;
                margin-bottom: 6px;
            }
            .question-row > div:nth-child(2)::before {
                content: "Success Rate: ";
                font-weight: 700;
                color: #6b7280;
                display: block;
                margin-bottom: 6px;
            }
            
            .detail-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
                gap: 10px;
            }
            .stat-item { padding: 10px; }
            .stat-value { font-size: 1.3rem; }
            
            .impersonation-banner {
                flex-direction: column;
                gap: 12px;
                align-items: stretch;
                text-align: center;
            }
            .impersonation-banner button {
                width: 100%;
            }
            
            .master-controls {
                padding: 12px;
            }
            .master-controls > div {
                flex-direction: column;
                gap: 10px;
            }
            .master-controls select {
                min-width: 100%;
            }
            
            .answer-stats {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
            .answer-bar {
                width: 100%;
            }
        }
        
        @media (max-width: 480px) {
            body { font-size: 12px; padding: 5px; }
            .season-btn { 
                font-size: 11px;
                padding: 6px 10px;
            }
            .list-row { padding: 12px; }
            .meta-tag { font-size: 10px; }
            .nav-link { font-size: 13px; padding: 8px 12px; }
        }
    </style>
</head>
<body>

    <div class="nav-bar">
        <div class="nav-center">
            <a href="index.html" class="nav-link">Home</a>
            <a href="report.html" class="nav-link">CMI Form</a>
            <a href="jersey.html" class="nav-link">Kit Search</a>
            <a href="eligibility.html" class="nav-link">Eligibility/Quizzes</a>
        </div>
        <a href="admin.html" class="supervisor-link active">ðŸ”’ Supervisors</a>
    </div>

    <div id="login-view">
        <h2>Supervisor Portal</h2>
        <p style="margin-bottom:25px; color:#666;">Please sign in with your credentials.</p>
        
        <input type="email" id="loginEmail" class="login-input" placeholder="Email Address" autocomplete="email">
        <input type="password" id="loginPassword" class="login-input" placeholder="Password" autocomplete="current-password">
        
        <button id="loginBtn" class="login-btn" onclick="handleLogin()">Sign In</button>
        
        <div id="login-error" style="color:#e74c3c; margin-top:20px; display:none; padding: 15px; background: #fee; border-radius: 6px; font-size: 0.9rem;"></div>
        <div id="login-status" style="color:#666; margin-top:15px; font-size:0.85rem; font-style:italic;"></div>
    </div>

    <div id="dashboard-view" class="container hidden">
        <div class="header">
            <div><h2 style="margin:0;">Dashboard</h2><small id="welcome-msg" style="color:#666;"></small></div>
            <button onclick="location.reload()" style="background:#e74c3c; color:white; border:none; padding:8px 15px; border-radius:4px; cursor:pointer; font-size: 13px;">Logout</button>
        </div>

        <!-- Impersonation Banner -->
        <div id="impersonation-banner" class="impersonation-banner hidden">
            <div style="display:flex; align-items:center; gap:10px;">
                <span style="font-size:1.2rem;">ðŸ‘¤</span>
                <div>
                    <strong>Impersonation Mode Active</strong><br>
                    <small>Viewing as: <span id="impersonated-name"></span></small>
                </div>
            </div>
            <button onclick="exitImpersonation()" style="background:white; color:#e74c3c; border:none; padding:6px 12px; border-radius:4px; cursor:pointer; font-weight:600; font-size: 12px;">Exit Impersonation</button>
        </div>

        <!-- Master Admin Controls -->
        <div id="master-controls" class="master-controls hidden">
            <div style="display:flex; align-items:center; gap:10px;">
                <label style="font-weight:600; color:#666; font-size: 13px;">ðŸ”§ View as Supervisor:</label>
                <select id="impersonate-select" onchange="handleImpersonation()" style="padding:8px 12px; border:1px solid #ddd; border-radius:6px; font-size: 13px; min-width:200px;">
                    <option value="">-- Select Supervisor --</option>
                </select>
            </div>
        </div>

        <div class="filter-bar">
            <select id="viewSelect" onchange="toggleView()" style="padding:8px 12px; border:2px solid #2ecc71; border-radius:6px; font-weight:bold; cursor:pointer; font-size: 13px;">
                <option value="cmi">Show CMI Reports</option>
                <option value="quiz">Show Test Results</option>
                <option value="questions">Question Analysis</option>
            </select>

            <input type="text" id="searchInput" class="search-input" placeholder="Search..." onkeyup="applyFilters()">
            
            <div id="cmi-filters" style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
                <select id="tagFilter" onchange="applyFilters()" style="padding:8px 12px; border:1px solid #ddd; border-radius:6px; font-size: 13px;">
                    <option value="">All Types</option>
                    <option value="Red">Red Cards</option>
                    <option value="Penalty">PKs</option>
                    <option value="Goal">No Goal</option>
                </select>
                <select id="metaTagFilter" onchange="applyFilters()" style="padding:8px 12px; border:1px solid #ddd; border-radius:6px; min-width:160px; font-size: 13px;">
                    <option value="">All Tags</option>
                </select>
                <label style="font-size:12px; font-weight:600;"><input type="checkbox" id="videoToggle" onchange="applyFilters()"> Video Only</label>
            </div>
            
            <div id="quiz-filters" style="display:none; gap:10px; align-items:center;">
                <select id="quizNameFilter" onchange="applyFilters()" style="padding:8px 12px; border:1px solid #ddd; border-radius:6px; min-width:200px; font-size: 13px;">
                    <option value="">All Quizzes</option>
                </select>
            </div>
            
            <div id="question-filters" style="display:none; gap:10px; align-items:center;">
                <select id="questionQuizFilter" onchange="applyFilters()" style="padding:8px 12px; border:1px solid #ddd; border-radius:6px; min-width:200px; font-size: 13px;">
                    <option value="">Select Quiz</option>
                </select>
                <label style="font-size:12px; font-weight:600;">
                    <input type="checkbox" id="problemsOnlyToggle" onchange="applyFilters()"> Show Problem Questions Only (<70%)
                </label>
            </div>
        </div>

        <div class="season-nav" id="season-nav">
            <button class="season-btn active" onclick="switchSeason('Current')">Current Season</button>
            <button class="season-btn" onclick="switchSeason('Boys 2025')">Boys 2025</button>
            <button class="season-btn" onclick="switchSeason('Girls 2025')">Girls 2025</button>
            <button class="season-btn" onclick="switchSeason('Boys 2024')">Boys 2024</button>
            <button class="season-btn" onclick="switchSeason('Girls 2024')">Girls 2024</button>
        </div>

        <div class="stats-card" id="stats-card">
            <div class="stats-grid" id="stats-grid"></div>
        </div>

        <!-- NEW: Quiz Detail Stats -->
        <div class="quiz-detail-stats" id="quiz-detail-stats">
            <h4 id="quiz-stats-title">Quiz Statistics</h4>
            <p><strong id="unique-referees">0</strong> unique referees have taken this quiz</p>
            <p>Quiz has been taken a total of <strong id="total-attempts">0</strong> times</p>
        </div>

        <div class="list-header cmi-header" id="list-header">
            <div>Date</div>
            <div>Match</div>
            <div>Referee</div>
            <div>Tags</div>
            <div>Moderator Notes</div>
            <div style="text-align:center;">Video</div>
        </div>

        <div id="data-list" class="list-container"></div>
    </div>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzi1gJkccUwLsjwPcepY_g9JY6nkLwcOxAn2dAEIw3YNQdWLuBl2lQYf6sOIM2WsRi3Cg/exec";
        let cmiData = [], quizData = [], questionStats = [], currentView = 'cmi';
        let actualSupervisor = null;
        let impersonatedSupervisor = null;
        let allSupervisors = [];

        // Handle Enter key on password field
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('loginPassword').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    handleLogin();
                }
            });
        });

        function handleLogin() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            
            const loginBtn = document.getElementById('loginBtn');
            const errorDiv = document.getElementById('login-error');
            const statusDiv = document.getElementById('login-status');
            
            if (!email || !password) {
                errorDiv.style.display = 'block';
                errorDiv.innerText = 'Please enter both email and password';
                return;
            }
            
            errorDiv.style.display = 'none';
            statusDiv.textContent = 'ðŸ”„ Authenticating...';
            statusDiv.style.display = 'block';
            loginBtn.disabled = true;
            loginBtn.textContent = 'Signing In...';
            
            fetch(`${SCRIPT_URL}?action=passwordLogin&email=${encodeURIComponent(email)}&password=${encodeURIComponent(password)}&season=Current`)
            .then(res => {
                statusDiv.textContent = 'ðŸ”„ Loading data...';
                return res.json();
            })
            .then(resp => {
                if (resp.status === 'success') {
                    statusDiv.textContent = 'âœ… Success! Loading dashboard...';
                    
                    setTimeout(() => {
                        document.getElementById('login-view').classList.add('hidden');
                        document.getElementById('dashboard-view').classList.remove('hidden');
                    }, 500);
                    
                    actualSupervisor = resp.supervisor;
                    
                    document.getElementById('welcome-msg').textContent = `Logged in as: ${resp.supervisor}`;
                    cmiData = resp.data || [];
                    quizData = resp.quizzes || [];
                    questionStats = resp.questionStats || [];
                    
                    if (resp.supervisor === 'MASTER' || resp.supervisor.toUpperCase().includes('MASTER')) {
                        document.getElementById('master-controls').classList.remove('hidden');
                        populateSupervisorList();
                    }
                    
                    populateMetaTagFilter();
                    applyFilters();
                } else {
                    loginBtn.disabled = false;
                    loginBtn.textContent = 'Sign In';
                    
                    statusDiv.textContent = '';
                    statusDiv.style.display = 'none';
                    
                    errorDiv.style.display = 'block';
                    errorDiv.innerText = resp.message || "Invalid email or password.";
                }
            })
            .catch(err => {
                console.error("Fetch error:", err);
                
                loginBtn.disabled = false;
                loginBtn.textContent = 'Sign In';
                
                statusDiv.textContent = '';
                statusDiv.style.display = 'none';
                
                errorDiv.style.display = 'block';
                errorDiv.innerText = "Connection error. Please try again.";
            });
        }

        function switchSeason(seasonName) {
            document.querySelectorAll('.season-btn').forEach(btn => {
                btn.classList.remove('active');
                if(btn.innerText.includes(seasonName)) btn.classList.add('active');
            });
            fetchData(seasonName);
        }

        function fetchData(season) {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            
            if (!email || !password) {
                console.error("No credentials available");
                return;
            }
            
            fetch(`${SCRIPT_URL}?action=passwordLogin&email=${encodeURIComponent(email)}&password=${encodeURIComponent(password)}&season=${season}`)
            .then(res => res.json())
            .then(resp => {
                if (resp.status === 'success') {
                    actualSupervisor = resp.supervisor;
                    cmiData = resp.data || [];
                    quizData = resp.quizzes || [];
                    questionStats = resp.questionStats || [];
                    
                    populateMetaTagFilter();
                    applyFilters();
                } else {
                    alert("Session expired. Please log in again.");
                    location.reload();
                }
            })
            .catch(err => {
                console.error("Fetch error:", err);
                alert("Error loading data. Please try again.");
            });
        }
        
        function populateSupervisorList() {
            const supervisorSet = new Set();
            cmiData.forEach(item => {
                if (item.supervisor && item.supervisor !== 'MASTER') {
                    supervisorSet.add(item.supervisor);
                }
            });
            
            allSupervisors = Array.from(supervisorSet).sort();
            
            const dropdown = document.getElementById('impersonate-select');
            dropdown.innerHTML = '<option value="">-- View as Yourself (MASTER) --</option>';
            
            allSupervisors.forEach(sup => {
                const option = document.createElement('option');
                option.value = sup;
                option.textContent = sup;
                dropdown.appendChild(option);
            });
        }
        
        function populateMetaTagFilter() {
            const tagSet = new Set();
            
            cmiData.forEach(item => {
                if (item.tags) {
                    const tags = item.tags.split(',').map(t => t.trim()).filter(t => t);
                    tags.forEach(tag => tagSet.add(tag));
                }
            });
            
            const sortedTags = Array.from(tagSet).sort();
            
            const dropdown = document.getElementById('metaTagFilter');
            dropdown.innerHTML = '<option value="">All Tags</option>';
            
            sortedTags.forEach(tag => {
                const option = document.createElement('option');
                option.value = tag;
                option.textContent = tag;
                dropdown.appendChild(option);
            });
        }
        
        function handleImpersonation() {
            const selectedSupervisor = document.getElementById('impersonate-select').value;
            
            if (selectedSupervisor) {
                impersonatedSupervisor = selectedSupervisor;
                document.getElementById('impersonation-banner').classList.remove('hidden');
                document.getElementById('impersonated-name').textContent = selectedSupervisor;
            } else {
                impersonatedSupervisor = null;
                document.getElementById('impersonation-banner').classList.add('hidden');
            }
            
            applyFilters();
        }
        
        function exitImpersonation() {
            impersonatedSupervisor = null;
            document.getElementById('impersonate-select').value = '';
            document.getElementById('impersonation-banner').classList.add('hidden');
            applyFilters();
        }

        function toggleView() {
            currentView = document.getElementById('viewSelect').value;
            const cmiFilters = document.getElementById('cmi-filters');
            const quizFilters = document.getElementById('quiz-filters');
            const questionFilters = document.getElementById('question-filters');
            const seasonNav = document.getElementById('season-nav');
            const header = document.getElementById('list-header');
            const statsCard = document.getElementById('stats-card');
            const quizDetailStats = document.getElementById('quiz-detail-stats');

            if(currentView === 'quiz') {
                cmiFilters.style.display = 'none';
                quizFilters.style.display = 'flex';
                questionFilters.style.display = 'none';
                seasonNav.style.display = 'none';
                statsCard.classList.add('show');
                quizDetailStats.classList.remove('show');
                header.className = 'list-header quiz-header';
                header.innerHTML = '<div>Referee Name</div><div>Email</div><div style="text-align:center; font-size:0.7rem;">S1</div><div style="text-align:center; font-size:0.7rem;">S2</div><div>Quiz Scores</div>';                
                populateQuizFilter();
            } else if(currentView === 'questions') {
                cmiFilters.style.display = 'none';
                quizFilters.style.display = 'none';
                questionFilters.style.display = 'flex';
                seasonNav.style.display = 'none';
                statsCard.classList.remove('show');
                quizDetailStats.classList.remove('show');
                header.className = 'list-header question-header';
                header.innerHTML = '<div>Question</div><div style="text-align:center;">Success Rate</div><div>Answer Details</div>';
                
                populateQuestionQuizFilter();
            } else {
                cmiFilters.style.display = 'flex';
                quizFilters.style.display = 'none';
                questionFilters.style.display = 'none';
                seasonNav.style.display = 'flex';
                statsCard.classList.remove('show');
                quizDetailStats.classList.remove('show');
                header.className = 'list-header cmi-header';
                header.innerHTML = '<div>Date</div><div>Match</div><div>Referee</div><div>Tags</div><div>Moderator Notes</div><div style="text-align:center;">Video</div>';
            }
            applyFilters();
        }
        
        function populateQuizFilter() {
            const dropdown = document.getElementById('quizNameFilter');
            const uniqueQuizzes = new Set();
            
            quizData.forEach(q => {
                if (q.quiz) uniqueQuizzes.add(q.quiz);
            });
            
            const sortedQuizzes = Array.from(uniqueQuizzes).sort();
            
            dropdown.innerHTML = '<option value="">All Quizzes</option>';
            
            sortedQuizzes.forEach(quizName => {
                const option = document.createElement('option');
                option.value = quizName;
                option.textContent = quizName;
                dropdown.appendChild(option);
            });
        }
        
        function populateQuestionQuizFilter() {
            const dropdown = document.getElementById('questionQuizFilter');
            const uniqueQuizzes = new Set();
            
            questionStats.forEach(q => {
                if (q.quiz) uniqueQuizzes.add(q.quiz);
            });
            
            const sortedQuizzes = Array.from(uniqueQuizzes).sort();
            
            dropdown.innerHTML = '<option value="">Select Quiz</option>';
            
            sortedQuizzes.forEach(quizName => {
                const option = document.createElement('option');
                option.value = quizName;
                option.textContent = quizName;
                dropdown.appendChild(option);
            });
        }

        function applyFilters() {
            const term = document.getElementById('searchInput').value.toLowerCase();
            const list = document.getElementById('data-list');
            list.innerHTML = '';

            if (currentView === 'cmi') {
                const tag = document.getElementById('tagFilter').value;
                const metaTag = document.getElementById('metaTagFilter').value;
                const vid = document.getElementById('videoToggle').checked;

                const effectiveSupervisor = impersonatedSupervisor || actualSupervisor;

                const filtered = cmiData.filter(item => {
                    if (effectiveSupervisor !== 'MASTER' && !String(item.supervisor).includes(effectiveSupervisor)) {
                        return false;
                    }
                    
                    if (vid && !(item.video||"").toString().startsWith("http")) return false;
                    if (tag && !(item.cmi||"").includes(tag)) return false;
                    
                    if (metaTag) {
                        const itemTags = (item.tags || "").split(',').map(t => t.trim());
                        if (!itemTags.includes(metaTag)) return false;
                    }
                    
                    return JSON.stringify(item).toLowerCase().includes(term);
                }).sort((a,b) => new Date(b.gameDate) - new Date(a.gameDate));

                filtered.forEach(item => {
                    let rClass = '';
                    if ((item.cmi||"").includes('Red')) rClass='row-red';
                    else if ((item.cmi||"").includes('Penalty')) rClass='row-pk';
                    else if ((item.cmi||"").includes('Goal')) rClass='row-goal';
                    
                    const vidBtn = (item.video||"").startsWith("http") 
                        ? `<a href="${item.video}" target="_blank" class="video-link">Watch</a>` 
                        : `<span class="video-none">No Video</span>`;

                    // Parse tags
                    let tagsHtml = '<div class="col-tags">';
                    if (item.tags) {
                        const tags = item.tags.split(',').map(t => t.trim()).filter(t => t);
                        if (tags.length > 0) {
                            tags.forEach(t => {
                                const isHighlighted = metaTag && t === metaTag;
                                tagsHtml += `<span class="meta-tag ${isHighlighted ? 'highlight' : ''}">${t}</span>`;
                            });
                        } else {
                            tagsHtml += '<span class="meta-tag" style="background:#f9fafb; color:#d1d5db;">No tags</span>';
                        }
                    } else {
                        tagsHtml += '<span class="meta-tag" style="background:#f9fafb; color:#d1d5db;">No tags</span>';
                    }
                    tagsHtml += '</div>';

                    // Extract region from supervisor name
                    const supervisorName = item.supervisor || "";
                    const regionMatch = supervisorName.match(/\(([^)]+)\)/);
                    const region = regionMatch ? regionMatch[1] : "";
                    const refereeName = item.refName || "Unknown";

                    const div = document.createElement('div');
                    div.className = `list-row cmi-row ${rClass}`;
                    div.onclick = (e) => { 
                        if(e.target.tagName !== 'A') {
                            div.classList.toggle('expanded'); 
                        }
                    };
                    
                    div.innerHTML = `
                        <div class="col-date">${item.gameDate}</div>
                        <div class="col-match">
                            <div>${item.home} vs ${item.away}</div>
                            <div class="col-match-level">${item.level}</div>
                        </div>
                        <div class="col-referee">
                            <div class="col-referee-name">${refereeName}</div>
                            <div class="col-referee-region">${region}</div>
                        </div>
                        ${tagsHtml}
                        <div class="col-moderator-notes">${item.moderatorNotes || '<span style="color:#d1d5db; font-style:italic;">No notes</span>'}</div>
                        <div class="col-video">${vidBtn}</div>
                        <div class="detail-view">
                            <div class="detail-grid">
                                <div class="detail-item">
                                    <div class="detail-label">CMI Type</div>
                                    <div class="detail-value">${item.cmi || '-'}</div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-label">Half</div>
                                    <div class="detail-value">${item.half || '-'}</div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-label">Time Remaining</div>
                                    <div class="detail-value">${item.time || '-'}</div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-label">Submitted By</div>
                                    <div class="detail-value">${item.refName || '-'}</div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-label">Regional Supervisor</div>
                                    <div class="detail-value">${item.supervisor || '-'}</div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-label">Timestamp</div>
                                    <div class="detail-value">${item.timestamp || '-'}</div>
                                </div>
                                <div class="detail-item" style="grid-column: 1 / -1;">
                                    <div class="detail-label">Referee Notes</div>
                                    <div class="detail-value ${!item.notes ? 'empty' : ''}">${item.notes || 'No referee notes provided'}</div>
                                </div>
                                <div class="detail-item" style="grid-column: 1 / -1;">
                                    <div class="detail-label">Video Link</div>
                                    <div class="detail-value">${item.video ? `<a href="${item.video}" target="_blank" style="color:#3b82f6;">${item.video}</a>` : '<span class="empty">No video link</span>'}</div>
                                </div>
                            </div>
                        </div>
                    `;
                    list.appendChild(div);
                });
            } else if (currentView === 'quiz') {
                if (!quizData || quizData.length === 0) {
                    list.innerHTML = '<div style="padding:40px; text-align:center; color:#666;"><h3>No Quiz Results Found</h3><p>Quiz results will appear here once students complete quizzes.</p></div>';
                    document.getElementById('stats-grid').innerHTML = '';
                    return;
                }
                
                const selectedQuiz = document.getElementById('quizNameFilter').value;
                
                const effectiveSupervisor = impersonatedSupervisor || actualSupervisor;
                const supervisorRegion = extractRegionFromSupervisor(effectiveSupervisor);
                
                const studentQuizzes = {};
                
                quizData.forEach(q => {
                    const email = q.email;
                    
                    if (!studentQuizzes[email]) {
                        studentQuizzes[email] = {
                            name: q.name,
                            email: q.email,
                            group: q.group || "Unknown",
                            quizzes: {},
                            scrimmage1: q.scrimmage1 || false,
                            scrimmage2: q.scrimmage2 || false,
                            playoffEligible: q.playoffEligible || false
                        };
                    }
                    
                    const quizName = q.quiz;
                    const percent = parseFloat(q.percent) || 0;
                    
                    // Track ALL attempts for each quiz
                    if (!studentQuizzes[email].quizzes[quizName]) {
                        studentQuizzes[email].quizzes[quizName] = {
                            attempts: []
                        };
                    }
                    
                    studentQuizzes[email].quizzes[quizName].attempts.push({
                        score: q.score,
                        percent: q.percent,
                        date: q.date
                    });
                });
                
                // Calculate best attempt for each quiz
                Object.values(studentQuizzes).forEach(student => {
                    Object.keys(student.quizzes).forEach(quizName => {
                        const attempts = student.quizzes[quizName].attempts;
                        
                        // Find best attempt
                        let bestAttempt = attempts[0];
                        attempts.forEach(attempt => {
                            const currentPercent = parseFloat(attempt.percent) || 0;
                            const bestPercent = parseFloat(bestAttempt.percent) || 0;
                            if (currentPercent > bestPercent) {
                                bestAttempt = attempt;
                            }
                        });
                        
                        student.quizzes[quizName].best = bestAttempt;
                        student.quizzes[quizName].attemptCount = attempts.length;
                    });
                });
                
                // Get all unique quiz names from the data (skip empty names)
                const allQuizNames = new Set();
                Object.values(studentQuizzes).forEach(student => {
                    Object.keys(student.quizzes).forEach(quizName => {
                        // Only add non-empty quiz names
                        if (quizName && quizName.trim()) {
                            allQuizNames.add(quizName);
                        }
                    });
                });
                const sortedAllQuizNames = Array.from(allQuizNames).sort();
                
                let filtered = Object.values(studentQuizzes).filter(student => {
                    if (!JSON.stringify(student).toLowerCase().includes(term)) return false;
                    
                    if (selectedQuiz && !student.quizzes[selectedQuiz]) return false;
                    
                    if (supervisorRegion && !matchesRegion(student.group, supervisorRegion)) {
                        return false;
                    }
                    
                    return true;
                }).sort((a, b) => a.name.localeCompare(b.name));
                
                updateQuizStats(filtered, selectedQuiz, studentQuizzes);
                
                if (filtered.length === 0) {
                    list.innerHTML = '<div style="padding:40px; text-align:center; color:#666;"><p>No results match your filters.</p></div>';
                    return;
                }
                
                filtered.forEach(student => {
                    const div = document.createElement('div');
                    div.className = 'list-row quiz-row';
                    
                    // Build quiz scores HTML
                    let quizScoresHtml = '<div class="quiz-scores-container">';
                    
                    const quizzesToShow = selectedQuiz ? [selectedQuiz] : sortedAllQuizNames;
                    
                    quizzesToShow.forEach(quizName => {
                        // Skip empty quiz names
                        if (!quizName || !quizName.trim()) return;
                        
                        const quizData = student.quizzes[quizName];
                        
                        if (quizData && quizData.best) {
                            // Student has taken this quiz
                            const quiz = quizData.best;
                            const attemptCount = quizData.attemptCount;
                            
                            var quizPercent = 0;
                            if (quiz.percent && quiz.percent !== '') {
                                quizPercent = parseFloat(quiz.percent);
                            }
                            
                            // If percentage is missing or wrong, calculate from fractional score
                            if ((quizPercent === 0 || quizPercent === 1) && quiz.score && quiz.score.includes('/')) {
                                var parts = quiz.score.split('/');
                                if (parts.length === 2) {
                                    var earned = parseFloat(parts[0]);
                                    var total = parseFloat(parts[1]);
                                    if (total > 0) {
                                        quizPercent = Math.round((earned / total) * 100);
                                    }
                                }
                            }
                            
                            var borderClass = 'none';
                            if (quizPercent >= 80) borderClass = 'high';
                            else if (quizPercent > 0) borderClass = 'low';
                            
                            quizScoresHtml += `
                                <div class="quiz-score-card ${borderClass}">
                                    <div class="quiz-name-label">${quizName}</div>
                                    <div class="quiz-score-value">${quiz.score || 'N/A'}</div>
                                    <div class="quiz-date">${quiz.date || ''}</div>
                                    <div class="attempt-count">${attemptCount} attempt${attemptCount > 1 ? 's' : ''}</div>
                                </div>
                            `;
                        } else {
                            // Student has NOT taken this quiz
                            quizScoresHtml += `
                                <div class="quiz-score-card none">
                                    <div class="quiz-name-label">${quizName}</div>
                                    <div class="quiz-score-value not-taken">Not taken</div>
                                </div>
                            `;
                        }
                    });
                    
                    quizScoresHtml += '</div>';

                    // Scrimmage checkboxes
                    const scrim1Icon = student.scrimmage1 ? 'âœ“' : 'â—‹';
                    const scrim2Icon = student.scrimmage2 ? 'âœ“' : 'â—‹';
                    const scrim1Class = student.scrimmage1 ? 'attended' : 'not-attended';
                    const scrim2Class = student.scrimmage2 ? 'attended' : 'not-attended';

                    div.innerHTML = `
                        <div class="col-referee">
                            <div class="col-referee-name">${student.name}</div>
                            <div class="col-referee-region">${student.group}</div>
                        </div>
                        <div style="color:#666; font-size:0.85rem; padding-right: 10px;">
                            ${student.email}
                        </div>
                        <div class="scrim-check ${scrim1Class}">${scrim1Icon}</div>
                        <div class="scrim-check ${scrim2Class}">${scrim2Icon}</div>
                        ${quizScoresHtml}
                    `;
                    list.appendChild(div);
                });
            } else if (currentView === 'questions') {
                if (!questionStats || questionStats.length === 0) {
                    list.innerHTML = '<div style="padding:40px; text-align:center; color:#666;"><h3>No Question Data Found</h3><p>Question-level data will appear here once students take quizzes.</p></div>';
                    return;
                }
                
                const selectedQuiz = document.getElementById('questionQuizFilter').value;
                const problemsOnly = document.getElementById('problemsOnlyToggle').checked;
                
                const effectiveSupervisor = impersonatedSupervisor || actualSupervisor;
                const supervisorRegion = extractRegionFromSupervisor(effectiveSupervisor);
                
                let filtered = questionStats.filter(q => {
                    if (!JSON.stringify(q).toLowerCase().includes(term)) return false;
                    
                    if (!selectedQuiz) return false;
                    if (q.quiz !== selectedQuiz) return false;
                    
                    if (problemsOnly && q.successRate >= 70) return false;
                    
                    if (supervisorRegion && !Object.keys(q.studentGroups).some(group => matchesRegion(group, supervisorRegion))) {
                        return false;
                    }
                    
                    return true;
                }).sort((a, b) => a.questionNumber - b.questionNumber);
                
                if (!selectedQuiz) {
                    list.innerHTML = '<div style="padding:40px; text-align:center; color:#666;"><p>Please select a quiz from the dropdown above to view question analysis.</p></div>';
                    return;
                }
                
                if (filtered.length === 0) {
                    list.innerHTML = '<div style="padding:40px; text-align:center; color:#666;"><p>No questions match your filters.</p></div>';
                    return;
                }
                
                
                // Find the lowest success rate for highlighting
                let lowestRate = 100;
                filtered.forEach(q => {
                    if (q.successRate < lowestRate) {
                        lowestRate = q.successRate;
                    }
                });
                
                filtered.forEach(q => {
                    const isLowestPerformer = q.successRate === lowestRate;
                    
                    const div = document.createElement('div');
                    div.className = `list-row question-row ${isLowestPerformer ? 'lowest-performer' : ''}`;
                    
                    // Build answer breakdown
                    let answerBreakdownHtml = '<div class="answer-breakdown">';
                    answerBreakdownHtml += '<div style="font-weight:600; margin-bottom:10px; color:#374151;">Answer Breakdown:</div>';
                    
                    // Calculate total responses
                    const totalResponses = q.totalAttempts;
                    
                    // Create array of all answers with their counts
                    const allAnswers = [];
                    
                    // Add correct answer
                    const correctCount = q.correctAttempts;
                    const correctPercent = Math.round((correctCount / totalResponses) * 100);
                    allAnswers.push({
                        text: q.correctAnswer,
                        count: correctCount,
                        percent: correctPercent,
                        isCorrect: true
                    });
                    
                    // Add wrong answers
                    if (q.wrongAnswers) {
                        for (const [answer, count] of Object.entries(q.wrongAnswers)) {
                            const percent = Math.round((count / totalResponses) * 100);
                            allAnswers.push({
                                text: answer,
                                count: count,
                                percent: percent,
                                isCorrect: false
                            });
                        }
                    }
                    
                    // Sort by count (most selected first)
                    allAnswers.sort((a, b) => b.count - a.count);
                    
                    // Render answer items
                    allAnswers.forEach(ans => {
                        const correctClass = ans.isCorrect ? 'correct' : 'incorrect';
                        const fillClass = ans.isCorrect ? 'correct' : 'incorrect';
                        
                        answerBreakdownHtml += `
                            <div class="answer-item ${correctClass}">
                                <div class="answer-text">
                                    ${ans.text}
                                    ${ans.isCorrect ? '<span style="color:#22c55e; margin-left:8px;">âœ“ Correct</span>' : ''}
                                </div>
                                <div class="answer-stats">
                                    <div class="answer-count">${ans.count} ${ans.count === 1 ? 'student' : 'students'}</div>
                                    <div class="answer-bar">
                                        <div class="answer-bar-fill ${fillClass}" style="width: ${ans.percent}%"></div>
                                    </div>
                                    <div class="answer-percent">${ans.percent}%</div>
                                </div>
                            </div>
                        `;
                    });
                    
                    answerBreakdownHtml += '</div>';
                    
                    // Build wrong answers summary (only most common incorrect)
                    let wrongAnswersHtml = '';
                    if (q.mostCommonWrongAnswer && q.mostCommonWrongCount > 0) {
                        wrongAnswersHtml = `<div class="wrong-answers">Most common incorrect: "${q.mostCommonWrongAnswer}" (${q.mostCommonWrongCount} times)</div>`;
                    }
                    
                    div.innerHTML = `
                        <div class="question-text">${q.questionText}</div>
                        <div style="text-align:center;">
                            <div class="success-rate">${q.successRate}%</div>
                        </div>
                        <div>
                            <div style="font-size:0.9rem; color:#2c3e50; margin-bottom:3px;"><strong>Correct:</strong> ${q.correctAnswer}</div>
                            ${wrongAnswersHtml}
                        </div>
                        ${answerBreakdownHtml}
                    `;
                    
                    // Add click handler to expand/collapse
                    div.onclick = function(e) {
                        // Don't collapse if clicking on links
                        if (e.target.tagName === 'A') return;
                        div.classList.toggle('expanded');
                    };
                    
                    list.appendChild(div);
                });
            }
        }
        
        function extractRegionFromSupervisor(supervisorName) {
            if (!supervisorName || supervisorName === 'MASTER') return null;
            
            const match = supervisorName.match(/\(([^)]+)\)/);
            return match ? match[1] : null;
        }
        
        function matchesRegion(studentGroup, supervisorRegion) {
            if (!studentGroup || !supervisorRegion) return false;
            
            const normalizedGroup = studentGroup.toLowerCase().trim();
            const normalizedRegion = supervisorRegion.toLowerCase().trim();
            
            if (normalizedGroup === normalizedRegion) return true;
            
            if (normalizedGroup.includes(normalizedRegion) || normalizedRegion.includes(normalizedGroup)) {
                return true;
            }
            
            return false;
        }
        
        function updateQuizStats(filteredData, selectedQuiz, allStudentQuizzes) {
            const statsGrid = document.getElementById('stats-grid');
            const quizDetailStats = document.getElementById('quiz-detail-stats');
            
            if (filteredData.length === 0) {
                statsGrid.innerHTML = '';
                quizDetailStats.classList.remove('show');
                return;
            }
            
            const quizCounts = {};
            filteredData.forEach(student => {
                Object.keys(student.quizzes).forEach(quizName => {
                    // Skip empty or whitespace-only quiz names
                    if (!quizName || !quizName.trim()) return;
                    
                    if (!selectedQuiz || selectedQuiz === quizName) {
                        quizCounts[quizName] = (quizCounts[quizName] || 0) + 1;
                    }
                });
            });
            
            const sortedQuizNames = Object.keys(quizCounts).sort();
            
            let statsHtml = '';
            
            // Always show total students
            statsHtml += `
                <div class="stat-item">
                    <div class="stat-value">${filteredData.length}</div>
                    <div class="stat-label">Referees</div>
                </div>
            `;
            
            // Show quiz-specific stats
            if (selectedQuiz) {
                // Single quiz selected - show attempts for that quiz
                statsHtml += `
                    <div class="stat-item">
                        <div class="stat-value">${quizCounts[selectedQuiz] || 0}</div>
                        <div class="stat-label">${selectedQuiz} Attempts</div>
                    </div>
                `;
                
                // NEW: Show detailed quiz statistics
                const uniqueReferees = quizCounts[selectedQuiz] || 0;
                let totalAttempts = 0;
                
                // Count total attempts for this quiz across all students (even if filtered out)
                Object.values(allStudentQuizzes).forEach(student => {
                    if (student.quizzes[selectedQuiz]) {
                        totalAttempts += student.quizzes[selectedQuiz].attemptCount;
                    }
                });
                
                document.getElementById('quiz-stats-title').textContent = `${selectedQuiz} Statistics`;
                document.getElementById('unique-referees').textContent = uniqueReferees;
                document.getElementById('total-attempts').textContent = totalAttempts;
                quizDetailStats.classList.add('show');
            } else {
                // All quizzes - show count for each quiz
                sortedQuizNames.forEach(quizName => {
                    statsHtml += `
                        <div class="stat-item">
                            <div class="stat-value">${quizCounts[quizName]}</div>
                            <div class="stat-label">${quizName}</div>
                        </div>
                    `;
                });
                quizDetailStats.classList.remove('show');
            }
            
            statsGrid.innerHTML = statsHtml;
        }
    </script>
</body>
</html>
