<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Supervisor Portal</title>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #f4f6f8; margin: 0; padding: 20px; color: #333; }
        .container { max-width: 1200px; margin: 0 auto; }
        
        /* Navigation */
        .nav-bar { 
            position: relative; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            margin-bottom: 40px; 
            padding: 10px 0;
        }
        .nav-center { display: flex; gap: 20px; }
        .nav-link { text-decoration: none; color: #4b5563; font-weight: 600; padding: 8px 16px; border-radius: 6px; font-size: 16px; transition: 0.2s; }
        .nav-link:hover { background-color: #e5e7eb; color: #111827; }
        .nav-link.active { background-color: #2ecc71; color: white; }
        
        .supervisor-link {
            position: absolute;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            text-decoration: none;
            color: #2c3e50;
            font-size: 0.9rem;
            font-weight: 600;
            border: 1px solid #d1d5db;
            padding: 6px 12px;
            border-radius: 4px;
            background: white;
            transition: all 0.2s;
        }
        .supervisor-link:hover { background: #f3f4f6; border-color: #9ca3af; }
        .supervisor-link.active { background: #2ecc71; color: white; border-color: #2ecc71; }
        
        @media (max-width: 800px) {
            .nav-bar { flex-direction: column; gap: 15px; }
            .supervisor-link { position: static; transform: none; margin-left: auto; }
            .nav-center { flex-wrap: wrap; justify-content: center; }
        }
        
        #login-view { max-width: 400px; margin: 60px auto; background: white; padding: 40px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); text-align: center; }
        .hidden { display: none !important; }
        
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .season-nav { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #e0e0e0; }
        .season-btn { background: white; border: 1px solid #ccc; color: #555; padding: 8px 16px; border-radius: 20px; cursor: pointer; }
        .season-btn.active { background: #2ecc71; color: white; border-color: #2ecc71; }

        .filter-bar { display: flex; gap: 10px; margin-bottom: 20px; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); align-items: center; }
        .search-input { flex-grow: 1; padding: 10px; border: 1px solid #ddd; border-radius: 6px; }
        
        /* List Styles */
        .list-header { display: grid; padding: 10px 20px; font-size: 12px; font-weight: bold; color: #888; text-transform: uppercase; }
        .list-row { background: white; border-radius: 8px; padding: 12px 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); border-left: 5px solid #ccc; display: grid; gap: 15px; align-items: center; margin-bottom: 8px; cursor: pointer; }
        .list-row.expanded { background-color: #f0fdf4; }
        .list-row.expanded .col-notes { white-space: normal; overflow: visible; }
        
        /* CMI-specific styling */
        .cmi-header { grid-template-columns: 110px 2fr 1.5fr 140px 2fr 110px; }
        .cmi-row { grid-template-columns: 110px 2fr 1.5fr 140px 2fr 110px; }
        
        .col-notes { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: 0.85rem; color: #555; }
        .row-red { border-left-color: #e74c3c; } .row-pk { border-left-color: #3498db; } .row-goal { border-left-color: #2ecc71; }
        
        .tag { display: inline-block; padding: 4px 10px; border-radius: 12px; font-size: 0.75rem; font-weight: bold; text-align: center; width: 100%; }
        .tag-red { background: #fee2e2; color: #991b1b; } .tag-pk { background: #e0f2fe; color: #075985; } .tag-goal { background: #dcfce7; color: #166534; }
        
        /* Quiz-specific styling */
        .quiz-header { grid-template-columns: 2fr 1.5fr 5fr; }
        .quiz-row { grid-template-columns: 2fr 1.5fr 5fr; align-items: start; }
        
        /* Question Analysis styling */
        .question-header { grid-template-columns: 80px 1fr 120px 150px 2fr; }
        .question-row { grid-template-columns: 80px 1fr 120px 150px 2fr; align-items: start; }
        .question-text { font-weight: 600; color: #2c3e50; line-height: 1.4; }
        .success-rate { font-size: 1.2rem; font-weight: bold; }
        .rate-good { color: #22c55e; }
        .rate-warning { color: #eab308; }
        .rate-poor { color: #ef4444; }
        .wrong-answers { font-size: 0.85rem; color: #666; margin-top: 5px; }
        .needs-attention { background: #fef3c7 !important; border-left-color: #eab308 !important; }
        
        .score-badge { padding: 4px 10px; border-radius: 12px; font-weight: bold; font-size: 0.9rem; text-align: center; display: inline-block; min-width: 60px; }
        .score-high { background: #dcfce7; color: #166534; } .score-med { background: #fef9c3; color: #854d0e; } .score-low { background: #fee2e2; color: #991b1b; }
        
        .score-fraction { font-weight: bold; font-size: 1rem; color: #2c3e50; }
        
        /* Quiz score cards */
        .quiz-score-card {
            background: #f9fafb;
            padding: 8px 12px;
            border-radius: 6px;
            flex: 1;
            min-width: 160px;
            max-width: 200px;
        }
        .quiz-score-card.high { border-left: 4px solid #22c55e; }
        .quiz-score-card.med { border-left: 4px solid #eab308; }
        .quiz-score-card.low { border-left: 4px solid #ef4444; }
        
        /* Stats Card */
        .stats-card { background: white; border-radius: 8px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); display: none; }
        .stats-card.show { display: block; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        .stat-item { text-align: center; padding: 15px; background: #f9fafb; border-radius: 6px; }
        .stat-value { font-size: 2rem; font-weight: bold; color: #2c3e50; }
        .stat-label { font-size: 0.9rem; color: #666; margin-top: 5px; }
        
        /* Impersonation Styles */
        .impersonation-banner { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            color: white; 
            padding: 15px 20px; 
            border-radius: 8px; 
            margin-bottom: 20px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            animation: slideDown 0.3s ease;
        }
        .master-controls {
            background: #f8fafc;
            border: 2px dashed #cbd5e1;
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>

    <div class="nav-bar">
        <div class="nav-center">
            <a href="index.html" class="nav-link">Home</a>
            <a href="report.html" class="nav-link">CMI Form</a>
            <a href="jersey.html" class="nav-link">Kit Search</a>
            <a href="quizzes.html" class="nav-link">Training Quizzes</a>
        </div>
        <a href="admin.html" class="supervisor-link active">ðŸ”’ Supervisors</a>
    </div>

    <div id="login-view">
        <h2>Supervisor Portal</h2>
        <p style="margin-bottom:20px; color:#666;">Please sign in with your authorized Google Account.</p>
        <div id="g_id_onload" data-client_id="340823693231-qr4j73bfcsn971po2h153jqnvimlab6h.apps.googleusercontent.com" data-callback="handleCredentialResponse" data-auto_prompt="false"></div>
        <div class="g_id_signin" data-type="standard" data-size="large" data-theme="outline" data-text="sign_in_with" data-shape="rectangular" data-logo_alignment="left"></div>
        <div id="login-error" style="color:red; margin-top:20px; display:none; white-space: pre-line; text-align: left; padding: 15px; background: #fee; border-radius: 6px; font-size: 0.9rem;"></div>
        <div id="login-status" style="color:#666; margin-top:15px; font-size:0.85rem; font-style:italic;"></div>
        
        <details style="margin-top: 20px; padding: 15px; background: #f9f9f9; border-radius: 6px; cursor: pointer;">
            <summary style="font-weight: 600; color: #666;">ðŸ”§ Troubleshooting</summary>
            <div style="margin-top: 10px; font-size: 0.85rem; line-height: 1.6;">
                <p><strong>If login keeps failing:</strong></p>
                <ol>
                    <li>Open browser console (F12) and check for errors</li>
                    <li>Verify your email is listed in Form Responses â†’ Admins tab</li>
                    <li>Ensure Form Responses backend script is deployed</li>
                    <li>Try clearing browser cache and cookies</li>
                    <li>Try in an incognito/private window</li>
                </ol>
                <p style="margin-top:10px;"><strong>Console logs will show:</strong></p>
                <ul>
                    <li>"Attempting login with token..." - OAuth successful</li>
                    <li>"Response received: 200" - Server responded</li>
                    <li>"Login successful!" - You should see the dashboard</li>
                </ul>
            </div>
        </details>
    </div>

    <div id="dashboard-view" class="container hidden">
        <div class="header">
            <div><h2 style="margin:0;">Dashboard</h2><small id="welcome-msg" style="color:#666;"></small></div>
            <button onclick="location.reload()" style="background:#e74c3c; color:white; border:none; padding:8px 15px; border-radius:4px; cursor:pointer;">Logout</button>
        </div>

        <!-- Impersonation Banner -->
        <div id="impersonation-banner" class="impersonation-banner hidden">
            <div style="display:flex; align-items:center; gap:10px;">
                <span style="font-size:1.2rem;">ðŸ‘¤</span>
                <div>
                    <strong>Impersonation Mode Active</strong><br>
                    <small>Viewing as: <span id="impersonated-name"></span></small>
                </div>
            </div>
            <button onclick="exitImpersonation()" style="background:white; color:#e74c3c; border:none; padding:6px 12px; border-radius:4px; cursor:pointer; font-weight:600;">Exit Impersonation</button>
        </div>

        <!-- Master Admin Controls -->
        <div id="master-controls" class="master-controls hidden">
            <div style="display:flex; align-items:center; gap:10px;">
                <label style="font-weight:600; color:#666;">ðŸ”§ View as Supervisor:</label>
                <select id="impersonate-select" onchange="handleImpersonation()" style="padding:8px 12px; border:1px solid #ddd; border-radius:6px; font-size:0.95rem; min-width:200px;">
                    <option value="">-- Select Supervisor --</option>
                </select>
            </div>
        </div>

        <div class="filter-bar">
            <select id="viewSelect" onchange="toggleView()" style="padding:10px; border:2px solid #2ecc71; border-radius:6px; font-weight:bold; cursor:pointer;">
                <option value="cmi">Show CMI Reports</option>
                <option value="quiz">Show Test Results</option>
                <option value="questions">Question Analysis</option>
            </select>

            <input type="text" id="searchInput" class="search-input" placeholder="Search..." onkeyup="applyFilters()">
            
            <div id="cmi-filters" style="display:flex; gap:10px; align-items:center;">
                <select id="tagFilter" onchange="applyFilters()" style="padding:10px; border:1px solid #ddd; border-radius:6px;">
                    <option value="">All Types</option>
                    <option value="Red">Red Cards</option>
                    <option value="Penalty">PKs</option>
                    <option value="Goal">No Goal</option>
                </select>
                <label style="font-size:13px; font-weight:600;"><input type="checkbox" id="videoToggle" onchange="applyFilters()"> Video Only</label>
            </div>
            
            <div id="quiz-filters" style="display:none; gap:10px; align-items:center;">
                <select id="quizNameFilter" onchange="applyFilters()" style="padding:10px; border:1px solid #ddd; border-radius:6px; min-width:200px;">
                    <option value="">All Quizzes</option>
                </select>
            </div>
            
            <div id="question-filters" style="display:none; gap:10px; align-items:center;">
                <select id="questionQuizFilter" onchange="applyFilters()" style="padding:10px; border:1px solid #ddd; border-radius:6px; min-width:200px;">
                    <option value="">Select Quiz</option>
                </select>
                <label style="font-size:13px; font-weight:600;">
                    <input type="checkbox" id="problemsOnlyToggle" onchange="applyFilters()"> Show Problem Questions Only (<70%)
                </label>
            </div>
        </div>

        <div class="season-nav" id="season-nav">
            <button class="season-btn active" onclick="switchSeason('Current')">Current Season</button>
            <button class="season-btn" onclick="switchSeason('Boys 2025')">Boys 2025</button>
            <button class="season-btn" onclick="switchSeason('Girls 2025')">Girls 2025</button>
            <button class="season-btn" onclick="switchSeason('Boys 2024')">Boys 2024</button>
            <button class="season-btn" onclick="switchSeason('Girls 2024')">Girls 2024</button>
        </div>

        <div class="stats-card" id="stats-card">
            <div class="stats-grid" id="stats-grid"></div>
        </div>

        <div class="list-header cmi-header" id="list-header">
            <div>Date</div><div>Match</div><div>Referee</div><div style="text-align:center;">Type</div><div>Notes</div><div style="text-align:right;">Video</div>
        </div>

        <div id="data-list" class="list-container"></div>
    </div>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzi1gJkccUwLsjwPcepY_g9JY6nkLwcOxAn2dAEIw3YNQdWLuBl2lQYf6sOIM2WsRi3Cg/exec";
        let userToken = null, cmiData = [], quizData = [], questionStats = [], currentView = 'cmi';
        let actualSupervisor = null; // The real logged-in supervisor
        let impersonatedSupervisor = null; // Who we're viewing as
        let allSupervisors = []; // List of all supervisors for impersonation dropdown

        function handleCredentialResponse(response) {
            userToken = response.credential;
            
            // Show loading state
            const loginView = document.getElementById('login-view');
            const errorDiv = document.getElementById('login-error');
            const statusDiv = document.getElementById('login-status');
            const signinButton = document.querySelector('.g_id_signin');
            
            errorDiv.style.display = 'none';
            statusDiv.textContent = 'ðŸ”„ Authenticating...';
            statusDiv.style.display = 'block';
            if (signinButton) signinButton.style.opacity = '0.5';
            
            console.log("Attempting login with token...");
            fetchData('Current');
        }

        function switchSeason(seasonName) {
            document.querySelectorAll('.season-btn').forEach(btn => {
                btn.classList.remove('active');
                if(btn.innerText.includes(seasonName)) btn.classList.add('active');
            });
            fetchData(seasonName);
        }

        function fetchData(season) {
            if (!userToken) {
                console.error("No user token available");
                const statusDiv = document.getElementById('login-status');
                if (statusDiv) {
                    statusDiv.textContent = 'âŒ No authentication token';
                    statusDiv.style.color = 'red';
                }
                return;
            }
            
            const statusDiv = document.getElementById('login-status');
            if (statusDiv && season === 'Current') {
                statusDiv.textContent = 'ðŸ”„ Verifying credentials...';
            }
            
            console.log("Fetching data for season:", season);
            
            fetch(`${SCRIPT_URL}?action=googleLogin&token=${userToken}&season=${season}`)
            .then(res => {
                console.log("Response received:", res.status);
                
                if (statusDiv && season === 'Current') {
                    statusDiv.textContent = 'ðŸ”„ Loading data...';
                }
                
                return res.json();
            })
            .then(resp => {
                console.log("Response data:", resp);
                
                if (resp.status === 'success') {
                    console.log("Login successful!");
                    
                    if (statusDiv && season === 'Current') {
                        statusDiv.textContent = 'âœ… Success! Loading dashboard...';
                    }
                    
                    // Small delay to show success message
                    setTimeout(() => {
                        document.getElementById('login-view').classList.add('hidden');
                        document.getElementById('dashboard-view').classList.remove('hidden');
                    }, 500);
                    
                    // Store actual supervisor
                    actualSupervisor = resp.supervisor;
                    
                    document.getElementById('welcome-msg').textContent = `Logged in as: ${resp.supervisor}`;
                    cmiData = resp.data || [];
                    quizData = resp.quizzes || [];
                    questionStats = resp.questionStats || []; // NEW: Load question statistics
                    
                    // Log quiz data for debugging
                    console.log("Quiz data loaded:", quizData.length, "results");
                    console.log("Question stats loaded:", questionStats.length, "questions");
                    
                    // Check if user is MASTER admin
                    if (resp.supervisor === 'MASTER' || resp.supervisor.toUpperCase().includes('MASTER')) {
                        document.getElementById('master-controls').classList.remove('hidden');
                        populateSupervisorList();
                    }
                    
                    // Apply filters for initial view (CMI)
                    applyFilters();
                } else {
                    console.error("Login failed:", resp.message || "Access denied");
                    
                    // Reset login state
                    userToken = null;
                    const signinButton = document.querySelector('.g_id_signin');
                    if (signinButton) signinButton.style.opacity = '1';
                    
                    if (statusDiv) {
                        statusDiv.textContent = '';
                        statusDiv.style.display = 'none';
                    }
                    
                    document.getElementById('login-error').style.display = 'block';
                    document.getElementById('login-error').innerText = "âŒ Access Denied\n\n" + (resp.message || "Your email is not authorized.") + "\n\nPlease ensure your email is listed in:\nForm Responses â†’ Admins tab";
                }
            })
            .catch(err => {
                console.error("Fetch error:", err);
                
                // Reset login state
                userToken = null;
                const signinButton = document.querySelector('.g_id_signin');
                if (signinButton) signinButton.style.opacity = '1';
                
                if (statusDiv) {
                    statusDiv.textContent = '';
                    statusDiv.style.display = 'none';
                }
                
                document.getElementById('login-error').style.display = 'block';
                document.getElementById('login-error').innerText = "âŒ Connection Error\n\n" + err.toString() + "\n\nPossible issues:\n1. Form Responses script not deployed\n2. Internet connection problem\n3. Browser blocking the request\n\nTry:\n- Refresh the page\n- Clear browser cache\n- Use incognito mode";
            });
        }
        
        function populateSupervisorList() {
            // Extract unique supervisors from CMI data
            const supervisorSet = new Set();
            cmiData.forEach(item => {
                if (item.supervisor && item.supervisor !== 'MASTER') {
                    supervisorSet.add(item.supervisor);
                }
            });
            
            // Sort alphabetically
            allSupervisors = Array.from(supervisorSet).sort();
            
            // Populate dropdown
            const dropdown = document.getElementById('impersonate-select');
            dropdown.innerHTML = '<option value="">-- View as Yourself (MASTER) --</option>';
            
            allSupervisors.forEach(sup => {
                const option = document.createElement('option');
                option.value = sup;
                option.textContent = sup;
                dropdown.appendChild(option);
            });
        }
        
        function handleImpersonation() {
            const selectedSupervisor = document.getElementById('impersonate-select').value;
            
            if (selectedSupervisor) {
                impersonatedSupervisor = selectedSupervisor;
                document.getElementById('impersonation-banner').classList.remove('hidden');
                document.getElementById('impersonated-name').textContent = selectedSupervisor;
            } else {
                impersonatedSupervisor = null;
                document.getElementById('impersonation-banner').classList.add('hidden');
            }
            
            // Reapply filters to show data for impersonated supervisor
            applyFilters();
        }
        
        function exitImpersonation() {
            impersonatedSupervisor = null;
            document.getElementById('impersonate-select').value = '';
            document.getElementById('impersonation-banner').classList.add('hidden');
            applyFilters();
        }

        function toggleView() {
            currentView = document.getElementById('viewSelect').value;
            const cmiFilters = document.getElementById('cmi-filters');
            const quizFilters = document.getElementById('quiz-filters');
            const questionFilters = document.getElementById('question-filters');
            const seasonNav = document.getElementById('season-nav');
            const header = document.getElementById('list-header');
            const statsCard = document.getElementById('stats-card');

            if(currentView === 'quiz') {
                cmiFilters.style.display = 'none';
                quizFilters.style.display = 'flex';
                questionFilters.style.display = 'none';
                seasonNav.style.display = 'none';
                statsCard.classList.add('show');
                header.className = 'list-header quiz-header';
                header.innerHTML = '<div>Referee Name</div><div>Group</div><div>Quiz Scores</div>';
                
                // Populate quiz name dropdown
                populateQuizFilter();
            } else if(currentView === 'questions') {
                cmiFilters.style.display = 'none';
                quizFilters.style.display = 'none';
                questionFilters.style.display = 'flex';
                seasonNav.style.display = 'none';
                statsCard.classList.remove('show');
                header.className = 'list-header question-header';
                header.innerHTML = '<div>Quiz</div><div>Question</div><div style="text-align:center;">Success Rate</div><div style="text-align:center;">Attempts</div><div>Common Mistakes</div>';
                
                // Populate question quiz dropdown
                populateQuestionQuizFilter();
            } else {
                cmiFilters.style.display = 'flex';
                quizFilters.style.display = 'none';
                questionFilters.style.display = 'none';
                seasonNav.style.display = 'flex';
                statsCard.classList.remove('show');
                header.className = 'list-header cmi-header';
                header.innerHTML = '<div>Date</div><div>Match</div><div>Referee</div><div style="text-align:center;">Type</div><div>Notes</div><div style="text-align:right;">Video</div>';
            }
            applyFilters();
        }
        
        function populateQuizFilter() {
            const dropdown = document.getElementById('quizNameFilter');
            const uniqueQuizzes = new Set();
            
            // Extract unique quiz names from quiz data
            quizData.forEach(q => {
                if (q.quiz) uniqueQuizzes.add(q.quiz);
            });
            
            // Sort alphabetically
            const sortedQuizzes = Array.from(uniqueQuizzes).sort();
            
            // Clear existing options except "All Quizzes"
            dropdown.innerHTML = '<option value="">All Quizzes</option>';
            
            // Add each unique quiz
            sortedQuizzes.forEach(quizName => {
                const option = document.createElement('option');
                option.value = quizName;
                option.textContent = quizName;
                dropdown.appendChild(option);
            });
        }
        
        function populateQuestionQuizFilter() {
            const dropdown = document.getElementById('questionQuizFilter');
            const uniqueQuizzes = new Set();
            
            // Extract unique quiz names from question stats
            questionStats.forEach(q => {
                if (q.quiz) uniqueQuizzes.add(q.quiz);
            });
            
            // Sort alphabetically
            const sortedQuizzes = Array.from(uniqueQuizzes).sort();
            
            // Clear and populate dropdown
            dropdown.innerHTML = '<option value="">Select Quiz</option>';
            
            sortedQuizzes.forEach(quizName => {
                const option = document.createElement('option');
                option.value = quizName;
                option.textContent = quizName;
                dropdown.appendChild(option);
            });
        }

        function applyFilters() {
            const term = document.getElementById('searchInput').value.toLowerCase();
            const list = document.getElementById('data-list');
            list.innerHTML = '';

            if (currentView === 'cmi') {
                const tag = document.getElementById('tagFilter').value;
                const vid = document.getElementById('videoToggle').checked;

                // Determine which supervisor to filter by
                const effectiveSupervisor = impersonatedSupervisor || actualSupervisor;

                const filtered = cmiData.filter(item => {
                    // Filter by supervisor (unless MASTER without impersonation)
                    if (effectiveSupervisor !== 'MASTER' && !String(item.supervisor).includes(effectiveSupervisor)) {
                        return false;
                    }
                    
                    if (vid && !(item.video||"").toString().startsWith("http")) return false;
                    if (tag && !(item.cmi||"").includes(tag)) return false;
                    return JSON.stringify(item).toLowerCase().includes(term);
                }).sort((a,b) => new Date(b.gameDate) - new Date(a.gameDate));

                filtered.forEach(item => {
                    let rClass = '', tClass = '', tLabel = item.cmi || "Report";
                    if ((item.cmi||"").includes('Red')) { rClass='row-red'; tClass='tag-red tag'; tLabel='Red Card'; }
                    else if ((item.cmi||"").includes('Penalty')) { rClass='row-pk'; tClass='tag-pk tag'; tLabel='PK'; }
                    else if ((item.cmi||"").includes('Goal')) { rClass='row-goal'; tClass='tag-goal tag'; tLabel='No Goal'; }
                    
                    const vidBtn = (item.video||"").startsWith("http") ? `<a href="${item.video}" target="_blank" style="font-weight:bold; color:#3498db; text-decoration:none;">Watch</a>` : `<span style="color:#ccc;">No Video</span>`;

                    const div = document.createElement('div');
                    div.className = `list-row cmi-row ${rClass}`;
                    div.onclick = (e) => { if(e.target.tagName !== 'A') div.classList.toggle('expanded'); };
                    div.innerHTML = `
                        <div>${item.gameDate}</div>
                        <div style="font-weight:600;">${item.home} vs ${item.away}<br><small style="font-weight:normal; color:#888;">${item.level}</small></div>
                        <div>${item.refName}<br><small style="color:#999;">${item.supervisor}</small></div>
                        <div style="text-align:center;"><span class="${tClass}">${tLabel}</span></div>
                        <div class="col-notes">${item.notes || "No notes"}</div>
                        <div style="text-align:right;">${vidBtn}</div>
                    `;
                    list.appendChild(div);
                });
            } else {
                // QUIZ VIEW - Show all quiz scores per student in one row
                console.log("Quiz Data Received:", quizData); // Debug logging
                
                if (!quizData || quizData.length === 0) {
                    list.innerHTML = '<div style="padding:40px; text-align:center; color:#666;"><h3>No Quiz Results Found</h3><p>Quiz results will appear here once students complete quizzes.</p><p style="font-size:0.9rem; margin-top:20px;">Make sure the "Quiz Results" tab exists in your Form Responses sheet.</p></div>';
                    document.getElementById('stats-grid').innerHTML = '';
                    return;
                }
                
                // Get selected quiz filter
                const selectedQuiz = document.getElementById('quizNameFilter').value;
                
                // Determine which supervisor's region to filter by
                const effectiveSupervisor = impersonatedSupervisor || actualSupervisor;
                const supervisorRegion = extractRegionFromSupervisor(effectiveSupervisor);
                
                // Group by student email and collect best scores for each quiz
                const studentQuizzes = {};
                
                quizData.forEach(q => {
                    const email = q.email;
                    
                    // Initialize student entry if not exists
                    if (!studentQuizzes[email]) {
                        studentQuizzes[email] = {
                            name: q.name,
                            email: q.email,
                            group: q.group || "Unknown",
                            quizzes: {}
                        };
                    }
                    
                    // Track best score for each quiz
                    const quizName = q.quiz;
                    const percent = parseFloat(q.percent) || 0;
                    
                    if (!studentQuizzes[email].quizzes[quizName] || percent > parseFloat(studentQuizzes[email].quizzes[quizName].percent)) {
                        studentQuizzes[email].quizzes[quizName] = {
                            score: q.score,
                            percent: q.percent,
                            date: q.date
                        };
                    }
                });
                
                // Filter students
                let filtered = Object.values(studentQuizzes).filter(student => {
                    // Filter by search term
                    if (!JSON.stringify(student).toLowerCase().includes(term)) return false;
                    
                    // Filter by selected quiz (only show students who took that quiz)
                    if (selectedQuiz && !student.quizzes[selectedQuiz]) return false;
                    
                    // Filter by supervisor's region (unless MASTER without impersonation)
                    if (supervisorRegion && !matchesRegion(student.group, supervisorRegion)) {
                        return false;
                    }
                    
                    return true;
                }).sort((a, b) => a.name.localeCompare(b.name));
                
                // Calculate stats based on all quiz attempts
                const allAttempts = [];
                filtered.forEach(student => {
                    Object.values(student.quizzes).forEach(quiz => {
                        if (!selectedQuiz || selectedQuiz === Object.keys(student.quizzes).find(q => student.quizzes[q] === quiz)) {
                            allAttempts.push({percent: parseFloat(quiz.percent)});
                        }
                    });
                });
                updateQuizStats(allAttempts, selectedQuiz);
                
                if (filtered.length === 0) {
                    list.innerHTML = '<div style="padding:40px; text-align:center; color:#666;"><p>No results match your filters.</p></div>';
                    return;
                }
                
                // Render each student with all their quiz scores
                filtered.forEach(student => {
                    const div = document.createElement('div');
                    div.className = 'list-row quiz-row';
                    
                    // Build quiz scores display
                    let quizScoresHtml = '<div style="display: flex; flex-wrap: wrap; gap: 8px;">';
                    
                    // Sort quizzes alphabetically
                    const quizNames = Object.keys(student.quizzes).sort();
                    
                    // If filtering by specific quiz, show only that one
                    const quizzesToShow = selectedQuiz ? [selectedQuiz] : quizNames;
                    
                    quizzesToShow.forEach(quizName => {
                        if (!student.quizzes[quizName]) return; // Skip if student didn't take this quiz
                        
                        const quiz = student.quizzes[quizName];
                        const p = parseFloat(quiz.percent);
                        let bClass = 'score-low';
                        if (p >= 90) bClass = 'score-high';
                        else if (p >= 70) bClass = 'score-med';
                        
                        quizScoresHtml += `
                            <div style="background: #f9fafb; padding: 8px 12px; border-radius: 6px; border-left: 4px solid ${bClass === 'score-high' ? '#22c55e' : bClass === 'score-med' ? '#eab308' : '#ef4444'}; flex: 1; min-width: 160px; max-width: 200px;">
                                <div style="font-weight: 600; color: #2c3e50; margin-bottom: 3px; font-size: 0.9rem;">${quizName}</div>
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span style="font-size: 1rem; font-weight: bold; color: #2c3e50;">${quiz.score || 'N/A'}</span>
                                    <span class="score-badge ${bClass}" style="margin-left: 8px; padding: 3px 8px; font-size: 0.85rem;">${quiz.percent}%</span>
                                </div>
                                <div style="font-size: 0.7rem; color: #999; margin-top: 3px;">${quiz.date}</div>
                            </div>
                        `;
                    });
                    
                    quizScoresHtml += '</div>';
                    
                    div.innerHTML = `
                        <div style="font-weight:bold; padding-right: 15px;">
                            ${student.name}
                            <br><small style="font-weight:normal; color:#888;">${student.email}</small>
                        </div>
                        <div style="color:#666; font-size:0.95rem; padding-right: 15px;">
                            <span style="display: inline-block; background: #e5e7eb; padding: 4px 12px; border-radius: 12px; font-weight: 600;">${student.group}</span>
                        </div>
                        ${quizScoresHtml}
                    `;
                    list.appendChild(div);
                });
            } else if (currentView === 'questions') {
                // QUESTION ANALYSIS VIEW
                console.log("Question stats data:", questionStats);
                
                if (!questionStats || questionStats.length === 0) {
                    list.innerHTML = '<div style="padding:40px; text-align:center; color:#666;"><h3>No Question Data Found</h3><p>Question-level data will appear here once students take quizzes with the updated system.</p><p style="font-size:0.9rem; margin-top:20px;">Make sure students are taking quizzes after the update, and sync has been run.</p></div>';
                    return;
                }
                
                const selectedQuiz = document.getElementById('questionQuizFilter').value;
                const problemsOnly = document.getElementById('problemsOnlyToggle').checked;
                
                // Determine which supervisor's region to filter by
                const effectiveSupervisor = impersonatedSupervisor || actualSupervisor;
                const supervisorRegion = extractRegionFromSupervisor(effectiveSupervisor);
                
                let filtered = questionStats.filter(q => {
                    // Filter by search term
                    if (!JSON.stringify(q).toLowerCase().includes(term)) return false;
                    
                    // Filter by selected quiz (required)
                    if (!selectedQuiz) return false; // Must select a quiz
                    if (q.quiz !== selectedQuiz) return false;
                    
                    // Filter by problems only
                    if (problemsOnly && q.successRate >= 70) return false;
                    
                    // Filter by supervisor region (check if any students from their region took this question)
                    if (supervisorRegion && !Object.keys(q.studentGroups).some(group => matchesRegion(group, supervisorRegion))) {
                        return false;
                    }
                    
                    return true;
                }).sort((a, b) => a.questionNumber - b.questionNumber);
                
                if (!selectedQuiz) {
                    list.innerHTML = '<div style="padding:40px; text-align:center; color:#666;"><p>Please select a quiz from the dropdown above to view question analysis.</p></div>';
                    return;
                }
                
                if (filtered.length === 0) {
                    list.innerHTML = '<div style="padding:40px; text-align:center; color:#666;"><p>No questions match your filters.</p></div>';
                    return;
                }
                
                filtered.forEach(q => {
                    const rateClass = q.successRate >= 80 ? 'rate-good' : q.successRate >= 60 ? 'rate-warning' : 'rate-poor';
                    const needsAttention = q.successRate < 70;
                    
                    const div = document.createElement('div');
                    div.className = `list-row question-row ${needsAttention ? 'needs-attention' : ''}`;
                    
                    // Build wrong answers display
                    let wrongAnswersHtml = '';
                    if (q.mostCommonWrongAnswer && q.mostCommonWrongCount > 0) {
                        wrongAnswersHtml = `<div class="wrong-answers">Most common: "${q.mostCommonWrongAnswer}" (${q.mostCommonWrongCount} times)</div>`;
                    }
                    
                    div.innerHTML = `
                        <div style="font-weight:bold; color:#2c3e50; font-size:1.1rem;">Q${q.questionNumber}</div>
                        <div class="question-text">${q.questionText}</div>
                        <div style="text-align:center;">
                            <div class="success-rate ${rateClass}">${q.successRate}%</div>
                            <div style="font-size:0.75rem; color:#999; margin-top:3px;">
                                ${needsAttention ? 'âš ï¸ Needs Review' : q.successRate >= 80 ? 'âœ“ Good' : '~ OK'}
                            </div>
                        </div>
                        <div style="text-align:center; color:#666;">
                            <div style="font-weight:600;">${q.correctAttempts}/${q.totalAttempts}</div>
                            <div style="font-size:0.75rem; color:#999;">${q.correctAttempts} correct</div>
                        </div>
                        <div>
                            <div style="font-size:0.9rem; color:#2c3e50; margin-bottom:3px;"><strong>Correct:</strong> ${q.correctAnswer}</div>
                            ${wrongAnswersHtml}
                        </div>
                    `;
                    list.appendChild(div);
                });
            }
        }
        
        // Helper function to extract region from supervisor name
        // e.g., "Roger Morton (Piedmont)" -> "Piedmont"
        function extractRegionFromSupervisor(supervisorName) {
            if (!supervisorName || supervisorName === 'MASTER') return null;
            
            const match = supervisorName.match(/\(([^)]+)\)/);
            return match ? match[1] : null;
        }
        
        // Helper function to check if student's group matches supervisor's region
        function matchesRegion(studentGroup, supervisorRegion) {
            if (!studentGroup || !supervisorRegion) return false;
            
            // Normalize strings for comparison
            const normalizedGroup = studentGroup.toLowerCase().trim();
            const normalizedRegion = supervisorRegion.toLowerCase().trim();
            
            // Direct match
            if (normalizedGroup === normalizedRegion) return true;
            
            // Partial match (e.g., "Western NC" matches "Western")
            if (normalizedGroup.includes(normalizedRegion) || normalizedRegion.includes(normalizedGroup)) {
                return true;
            }
            
            return false;
        }
        
        function updateQuizStats(filteredData, selectedQuiz) {
            const statsGrid = document.getElementById('stats-grid');
            
            if (filteredData.length === 0) {
                statsGrid.innerHTML = '';
                return;
            }
            
            // Count quiz attempts by quiz name
            const quizCounts = {};
            filteredData.forEach(student => {
                Object.keys(student.quizzes).forEach(quizName => {
                    if (!selectedQuiz || selectedQuiz === quizName) {
                        quizCounts[quizName] = (quizCounts[quizName] || 0) + 1;
                    }
                });
            });
            
            // Sort quiz names alphabetically
            const sortedQuizNames = Object.keys(quizCounts).sort();
            
            let statsHtml = '';
            
            // Total students
            statsHtml += `
                <div class="stat-item">
                    <div class="stat-value">${filteredData.length}</div>
                    <div class="stat-label">Total Students</div>
                </div>
            `;
            
            // Quiz counts
            if (selectedQuiz) {
                // Show single quiz count
                statsHtml += `
                    <div class="stat-item">
                        <div class="stat-value">${quizCounts[selectedQuiz] || 0}</div>
                        <div class="stat-label">${selectedQuiz} Attempts</div>
                    </div>
                `;
            } else {
                // Show all quiz counts
                sortedQuizNames.forEach(quizName => {
                    statsHtml += `
                        <div class="stat-item">
                            <div class="stat-value">${quizCounts[quizName]}</div>
                            <div class="stat-label">${quizName}</div>
                        </div>
                    `;
                });
            }
            
            statsGrid.innerHTML = statsHtml;
        }
    </script>
</body>
</html>
