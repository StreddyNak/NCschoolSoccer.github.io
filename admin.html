<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Supervisor Portal</title>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #f4f6f8; margin: 0; padding: 20px; color: #333; }
        .container { max-width: 1200px; margin: 0 auto; }
        .nav-bar { display: flex; justify-content: center; gap: 20px; margin-bottom: 40px; }
        .nav-link { text-decoration: none; color: #4b5563; font-weight: 600; padding: 8px 16px; border-radius: 6px; transition: 0.2s; }
        .nav-link.active { background-color: #2ecc71; color: white; }
        
        #login-view { max-width: 400px; margin: 60px auto; background: white; padding: 40px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); text-align: center; }
        .hidden { display: none !important; }
        
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .season-nav { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #e0e0e0; }
        .season-btn { background: white; border: 1px solid #ccc; color: #555; padding: 8px 16px; border-radius: 20px; cursor: pointer; }
        .season-btn.active { background: #2ecc71; color: white; border-color: #2ecc71; }

        .filter-bar { display: flex; gap: 10px; margin-bottom: 20px; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); align-items: center; }
        .search-input { flex-grow: 1; padding: 10px; border: 1px solid #ddd; border-radius: 6px; }
        
        /* List Styles */
        .list-header { display: grid; padding: 10px 20px; font-size: 12px; font-weight: bold; color: #888; text-transform: uppercase; }
        .list-row { background: white; border-radius: 8px; padding: 12px 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); border-left: 5px solid #ccc; display: grid; gap: 15px; align-items: center; margin-bottom: 8px; cursor: pointer; }
        .list-row.expanded { background-color: #f0fdf4; }
        .list-row.expanded .col-notes { white-space: normal; overflow: visible; }
        
        /* CMI-specific styling */
        .cmi-header { grid-template-columns: 110px 2fr 1.5fr 140px 2fr 110px; }
        .cmi-row { grid-template-columns: 110px 2fr 1.5fr 140px 2fr 110px; }
        
        .col-notes { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: 0.85rem; color: #555; }
        .row-red { border-left-color: #e74c3c; } .row-pk { border-left-color: #3498db; } .row-goal { border-left-color: #2ecc71; }
        
        .tag { display: inline-block; padding: 4px 10px; border-radius: 12px; font-size: 0.75rem; font-weight: bold; text-align: center; width: 100%; }
        .tag-red { background: #fee2e2; color: #991b1b; } .tag-pk { background: #e0f2fe; color: #075985; } .tag-goal { background: #dcfce7; color: #166534; }
        
        /* Quiz-specific styling */
        .quiz-header { grid-template-columns: 2fr 2fr 120px 100px 1fr; }
        .quiz-row { grid-template-columns: 2fr 2fr 120px 100px 1fr; }
        
        .score-badge { padding: 4px 10px; border-radius: 12px; font-weight: bold; font-size: 0.9rem; text-align: center; display: inline-block; min-width: 60px; }
        .score-high { background: #dcfce7; color: #166534; } .score-med { background: #fef9c3; color: #854d0e; } .score-low { background: #fee2e2; color: #991b1b; }
        
        .score-fraction { font-weight: bold; font-size: 1rem; color: #2c3e50; }
        
        /* Stats Card */
        .stats-card { background: white; border-radius: 8px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); display: none; }
        .stats-card.show { display: block; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        .stat-item { text-align: center; padding: 15px; background: #f9fafb; border-radius: 6px; }
        .stat-value { font-size: 2rem; font-weight: bold; color: #2c3e50; }
        .stat-label { font-size: 0.9rem; color: #666; margin-top: 5px; }
    </style>
</head>
<body>

    <div class="nav-bar">
        <a href="index.html" class="nav-link">Home</a>
        <a href="report.html" class="nav-link">CMI Form</a>
        <a href="jersey.html" class="nav-link">Kit Search</a>
        <span class="nav-link active">Admin Portal</span>
    </div>

    <div id="login-view">
        <h2>Supervisor Portal</h2>
        <p style="margin-bottom:20px; color:#666;">Please sign in with your authorized Google Account.</p>
        <div id="g_id_onload" data-client_id="340823693231-qr4j73bfcsn971po2h153jqnvimlab6h.apps.googleusercontent.com" data-callback="handleCredentialResponse" data-auto_prompt="false"></div>
        <div class="g_id_signin" data-type="standard" data-size="large" data-theme="outline" data-text="sign_in_with" data-shape="rectangular" data-logo_alignment="left"></div>
        <div id="login-error" style="color:red; margin-top:20px; display:none;"></div>
    </div>

    <div id="dashboard-view" class="container hidden">
        <div class="header">
            <div><h2 style="margin:0;">Dashboard</h2><small id="welcome-msg" style="color:#666;"></small></div>
            <button onclick="location.reload()" style="background:#e74c3c; color:white; border:none; padding:8px 15px; border-radius:4px; cursor:pointer;">Logout</button>
        </div>

        <div class="filter-bar">
            <select id="viewSelect" onchange="toggleView()" style="padding:10px; border:2px solid #2ecc71; border-radius:6px; font-weight:bold; cursor:pointer;">
                <option value="cmi">Show CMI Reports</option>
                <option value="quiz">Show Test Results</option>
            </select>

            <input type="text" id="searchInput" class="search-input" placeholder="Search..." onkeyup="applyFilters()">
            
            <div id="cmi-filters" style="display:flex; gap:10px; align-items:center;">
                <select id="tagFilter" onchange="applyFilters()" style="padding:10px; border:1px solid #ddd; border-radius:6px;">
                    <option value="">All Types</option>
                    <option value="Red">Red Cards</option>
                    <option value="Penalty">PKs</option>
                    <option value="Goal">No Goal</option>
                </select>
                <label style="font-size:13px; font-weight:600;"><input type="checkbox" id="videoToggle" onchange="applyFilters()"> Video Only</label>
            </div>
            
            <div id="quiz-filters" style="display:none; gap:10px; align-items:center;">
                <select id="quizNameFilter" onchange="applyFilters()" style="padding:10px; border:1px solid #ddd; border-radius:6px; min-width:200px;">
                    <option value="">All Quizzes</option>
                </select>
            </div>
        </div>

        <div class="season-nav" id="season-nav">
            <button class="season-btn active" onclick="switchSeason('Current')">Current Season</button>
            <button class="season-btn" onclick="switchSeason('Boys 2025')">Boys 2025</button>
            <button class="season-btn" onclick="switchSeason('Girls 2025')">Girls 2025</button>
            <button class="season-btn" onclick="switchSeason('Boys 2024')">Boys 2024</button>
            <button class="season-btn" onclick="switchSeason('Girls 2024')">Girls 2024</button>
        </div>

        <div class="stats-card" id="stats-card">
            <div class="stats-grid" id="stats-grid"></div>
        </div>

        <div class="list-header cmi-header" id="list-header">
            <div>Date</div><div>Match</div><div>Referee</div><div style="text-align:center;">Type</div><div>Notes</div><div style="text-align:right;">Video</div>
        </div>

        <div id="data-list" class="list-container"></div>
    </div>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzi1gJkccUwLsjwPcepY_g9JY6nkLwcOxAn2dAEIw3YNQdWLuBl2lQYf6sOIM2WsRi3Cg/exec";
        let userToken = null, cmiData = [], quizData = [], currentView = 'cmi';

        function handleCredentialResponse(response) {
            userToken = response.credential;
            fetchData('Current');
        }

        function switchSeason(seasonName) {
            document.querySelectorAll('.season-btn').forEach(btn => {
                btn.classList.remove('active');
                if(btn.innerText.includes(seasonName)) btn.classList.add('active');
            });
            fetchData(seasonName);
        }

        function fetchData(season) {
            if (!userToken) return;
            fetch(`${SCRIPT_URL}?action=googleLogin&token=${userToken}&season=${season}`)
            .then(res => res.json())
            .then(resp => {
                if (resp.status === 'success') {
                    document.getElementById('login-view').classList.add('hidden');
                    document.getElementById('dashboard-view').classList.remove('hidden');
                    document.getElementById('welcome-msg').textContent = `Logged in as: ${resp.supervisor}`;
                    cmiData = resp.data || [];
                    quizData = resp.quizzes || [];
                    applyFilters();
                } else {
                    document.getElementById('login-error').style.display = 'block';
                    document.getElementById('login-error').innerText = "Access Denied.";
                }
            });
        }

        function toggleView() {
            currentView = document.getElementById('viewSelect').value;
            const cmiFilters = document.getElementById('cmi-filters');
            const quizFilters = document.getElementById('quiz-filters');
            const seasonNav = document.getElementById('season-nav');
            const header = document.getElementById('list-header');
            const statsCard = document.getElementById('stats-card');

            if(currentView === 'quiz') {
                cmiFilters.style.display = 'none';
                quizFilters.style.display = 'flex';
                seasonNav.style.display = 'none';
                statsCard.classList.add('show');
                header.className = 'list-header quiz-header';
                header.innerHTML = '<div>Referee Name</div><div>Test Name</div><div style="text-align:center;">Score</div><div style="text-align:center;">Percent</div><div>Date Taken</div>';
                
                // Populate quiz name dropdown
                populateQuizFilter();
            } else {
                cmiFilters.style.display = 'flex';
                quizFilters.style.display = 'none';
                seasonNav.style.display = 'flex';
                statsCard.classList.remove('show');
                header.className = 'list-header cmi-header';
                header.innerHTML = '<div>Date</div><div>Match</div><div>Referee</div><div style="text-align:center;">Type</div><div>Notes</div><div style="text-align:right;">Video</div>';
            }
            applyFilters();
        }
        
        function populateQuizFilter() {
            const dropdown = document.getElementById('quizNameFilter');
            const uniqueQuizzes = new Set();
            
            // Extract unique quiz names from quiz data
            quizData.forEach(q => {
                if (q.quiz) uniqueQuizzes.add(q.quiz);
            });
            
            // Sort alphabetically
            const sortedQuizzes = Array.from(uniqueQuizzes).sort();
            
            // Clear existing options except "All Quizzes"
            dropdown.innerHTML = '<option value="">All Quizzes</option>';
            
            // Add each unique quiz
            sortedQuizzes.forEach(quizName => {
                const option = document.createElement('option');
                option.value = quizName;
                option.textContent = quizName;
                dropdown.appendChild(option);
            });
        }

        function applyFilters() {
            const term = document.getElementById('searchInput').value.toLowerCase();
            const list = document.getElementById('data-list');
            list.innerHTML = '';

            if (currentView === 'cmi') {
                const tag = document.getElementById('tagFilter').value;
                const vid = document.getElementById('videoToggle').checked;

                const filtered = cmiData.filter(item => {
                    if (vid && !(item.video||"").toString().startsWith("http")) return false;
                    if (tag && !(item.cmi||"").includes(tag)) return false;
                    return JSON.stringify(item).toLowerCase().includes(term);
                }).sort((a,b) => new Date(b.gameDate) - new Date(a.gameDate));

                filtered.forEach(item => {
                    let rClass = '', tClass = '', tLabel = item.cmi || "Report";
                    if ((item.cmi||"").includes('Red')) { rClass='row-red'; tClass='tag-red tag'; tLabel='Red Card'; }
                    else if ((item.cmi||"").includes('Penalty')) { rClass='row-pk'; tClass='tag-pk tag'; tLabel='PK'; }
                    else if ((item.cmi||"").includes('Goal')) { rClass='row-goal'; tClass='tag-goal tag'; tLabel='No Goal'; }
                    
                    const vidBtn = (item.video||"").startsWith("http") ? `<a href="${item.video}" target="_blank" style="font-weight:bold; color:#3498db; text-decoration:none;">Watch</a>` : `<span style="color:#ccc;">No Video</span>`;

                    const div = document.createElement('div');
                    div.className = `list-row cmi-row ${rClass}`;
                    div.onclick = (e) => { if(e.target.tagName !== 'A') div.classList.toggle('expanded'); };
                    div.innerHTML = `
                        <div>${item.gameDate}</div>
                        <div style="font-weight:600;">${item.home} vs ${item.away}<br><small style="font-weight:normal; color:#888;">${item.level}</small></div>
                        <div>${item.refName}<br><small style="color:#999;">${item.supervisor}</small></div>
                        <div style="text-align:center;"><span class="${tClass}">${tLabel}</span></div>
                        <div class="col-notes">${item.notes || "No notes"}</div>
                        <div style="text-align:right;">${vidBtn}</div>
                    `;
                    list.appendChild(div);
                });
            } else {
                // QUIZ VIEW - Show fractional scores
                console.log("Quiz Data Received:", quizData); // Debug logging
                
                if (!quizData || quizData.length === 0) {
                    list.innerHTML = '<div style="padding:40px; text-align:center; color:#666;"><h3>No Quiz Results Found</h3><p>Quiz results will appear here once students complete quizzes.</p><p style="font-size:0.9rem; margin-top:20px;">Make sure the "Quiz Results" tab exists in your Form Responses sheet.</p></div>';
                    document.getElementById('stats-grid').innerHTML = '';
                    return;
                }
                
                // Get selected quiz filter
                const selectedQuiz = document.getElementById('quizNameFilter').value;
                
                const bestScores = {};
                quizData.forEach(q => {
                    const key = `${q.email}_${q.quiz}`;
                    const p = parseFloat(q.percent)||0;
                    if (!bestScores[key] || p > parseFloat(bestScores[key].percent)) bestScores[key] = q;
                });
                
                let filtered = Object.values(bestScores).filter(q => {
                    // Filter by search term
                    if (!JSON.stringify(q).toLowerCase().includes(term)) return false;
                    
                    // Filter by selected quiz
                    if (selectedQuiz && q.quiz !== selectedQuiz) return false;
                    
                    return true;
                }).sort((a,b) => a.name.localeCompare(b.name));
                
                // Update stats
                updateQuizStats(filtered, selectedQuiz);
                
                if (filtered.length === 0) {
                    list.innerHTML = '<div style="padding:40px; text-align:center; color:#666;"><p>No results match your filters.</p></div>';
                    return;
                }
                
                filtered.forEach(q => {
                    const p = parseFloat(q.percent);
                    let bClass = 'score-low';
                    if(p>=90) bClass='score-high'; else if(p>=70) bClass='score-med';
                    
                    const div = document.createElement('div');
                    div.className = 'list-row quiz-row';
                    div.innerHTML = `
                        <div style="font-weight:bold;">${q.name}<br><small style="font-weight:normal; color:#888;">${q.email}</small></div>
                        <div style="font-weight:600; color:#2c3e50;">${q.quiz}</div>
                        <div style="text-align:center;"><span class="score-fraction">${q.score || 'N/A'}</span></div>
                        <div style="text-align:center;"><span class="score-badge ${bClass}">${q.percent}%</span></div>
                        <div style="color:#666; font-size:0.85rem;">${q.date}</div>
                    `;
                    list.appendChild(div);
                });
            }
        }
        
        function updateQuizStats(filteredData, selectedQuiz) {
            const statsGrid = document.getElementById('stats-grid');
            
            if (filteredData.length === 0) {
                statsGrid.innerHTML = '';
                return;
            }
            
            // Calculate stats
            const totalStudents = filteredData.length;
            const percentages = filteredData.map(q => parseFloat(q.percent) || 0);
            const avgPercent = Math.round(percentages.reduce((a, b) => a + b, 0) / percentages.length);
            const highScore = Math.max(...percentages);
            const lowScore = Math.min(...percentages);
            
            // Count by quiz if showing all
            let quizBreakdown = '';
            if (!selectedQuiz) {
                const quizCounts = {};
                filteredData.forEach(q => {
                    quizCounts[q.quiz] = (quizCounts[q.quiz] || 0) + 1;
                });
                const topQuiz = Object.keys(quizCounts).reduce((a, b) => quizCounts[a] > quizCounts[b] ? a : b);
                quizBreakdown = `
                    <div class="stat-item">
                        <div class="stat-value">${quizCounts[topQuiz]}</div>
                        <div class="stat-label">Most Taken: ${topQuiz}</div>
                    </div>
                `;
            }
            
            statsGrid.innerHTML = `
                <div class="stat-item">
                    <div class="stat-value">${totalStudents}</div>
                    <div class="stat-label">${selectedQuiz ? 'Students' : 'Total Results'}</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">${avgPercent}%</div>
                    <div class="stat-label">Average Score</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">${highScore}%</div>
                    <div class="stat-label">Highest Score</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">${lowScore}%</div>
                    <div class="stat-label">Lowest Score</div>
                </div>
                ${quizBreakdown}
            `;
        }
    </script>
</body>
</html>
