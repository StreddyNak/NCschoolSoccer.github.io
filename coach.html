<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coach Portal - NC HS Soccer</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link
        href="https://fonts.googleapis.com/css2?family=Barlow+Condensed:wght@400;600;700;800&family=Barlow:wght@400;500;600&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --navy: #0d1b2a;
            --navy-mid: #1b2d42;
            --navy-light: #243b55;
            --green: #00e676;
            --green-dark: #00c853;
            --white: #ffffff;
            --gray-light: #f0f4f8;
            --gray: #8a9bb0;
            --text: #1a2a3a;
            --card-shadow: 0 4px 24px rgba(13, 27, 42, 0.10);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Barlow', sans-serif;
            background: var(--gray-light);
            color: var(--text);
            min-height: 100vh;
        }

        /* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */
        .site-header {
            background: linear-gradient(135deg, var(--navy) 0%, var(--navy-light) 100%);
            padding: 14px 30px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 30px;
            flex-wrap: wrap;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.25);
            position: relative;
            overflow: hidden;
        }

        .site-header::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, transparent, var(--green), transparent);
        }

        .logo-img {
            height: 48px;
            width: auto;
            object-fit: contain;
            background: white;
            padding: 5px;
            border-radius: 4px;
        }

        .partnership-text {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.8rem;
            font-weight: 600;
            letter-spacing: 1px;
            text-transform: uppercase;
            text-align: center;
        }

        /* ‚îÄ‚îÄ Page wrapper ‚îÄ‚îÄ */
        .page {
            min-height: calc(100vh - 80px);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 50px 20px 40px;
        }

        /* ‚îÄ‚îÄ Auth cards (login / register) ‚îÄ‚îÄ */
        .auth-card {
            background: white;
            border-radius: 16px;
            box-shadow: var(--card-shadow);
            padding: 44px 40px;
            width: 100%;
            max-width: 520px;
            border-top: 4px solid var(--green);
        }

        .auth-card h1 {
            font-family: 'Barlow Condensed', sans-serif;
            font-size: 2rem;
            font-weight: 800;
            color: var(--navy);
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .auth-card p.sub {
            color: var(--gray);
            font-size: 0.9rem;
            margin-bottom: 28px;
        }

        .auth-card.wide {
            max-width: 640px;
        }

        /* ‚îÄ‚îÄ Form elements ‚îÄ‚îÄ */
        .form-group {
            margin-bottom: 18px;
        }

        .form-label {
            display: block;
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--navy-mid);
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-control {
            width: 100%;
            padding: 11px 14px;
            border: 2px solid #dde4ed;
            border-radius: 8px;
            font-size: 0.95rem;
            font-family: 'Barlow', sans-serif;
            transition: border-color 0.2s, box-shadow 0.2s;
            background: #fff;
            color: var(--text);
        }

        .form-control:focus {
            border-color: var(--green-dark);
            outline: none;
            box-shadow: 0 0 0 3px rgba(0, 200, 83, 0.12);
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 14px;
        }

        .grid-4 {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }

        @media(max-width:600px) {
            .grid-2 {
                grid-template-columns: 1fr;
            }

            .grid-4 {
                grid-template-columns: 1fr 1fr;
            }
        }

        /* ‚îÄ‚îÄ Buttons ‚îÄ‚îÄ */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-family: 'Barlow Condensed', sans-serif;
            font-size: 1rem;
            font-weight: 700;
            letter-spacing: 0.5px;
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
        }

        .btn-primary {
            background: var(--green);
            color: var(--navy);
            width: 100%;
        }

        .btn-primary:hover {
            background: var(--green-dark);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 200, 83, 0.3);
        }

        .btn-dark {
            background: var(--navy);
            color: white;
        }

        .btn-dark:hover {
            background: var(--navy-mid);
        }

        .btn-ghost {
            background: transparent;
            color: var(--gray);
            border: 2px solid #dde4ed;
        }

        .btn-ghost:hover {
            border-color: var(--navy);
            color: var(--navy);
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 0.85rem;
        }

        .btn-block {
            width: 100%;
        }

        .link-btn {
            background: none;
            border: none;
            color: #3498db;
            font-size: 0.9rem;
            cursor: pointer;
            padding: 0;
            font-family: 'Barlow', sans-serif;
            text-decoration: underline;
        }

        .error-msg {
            color: #e74c3c;
            margin-top: 12px;
            display: none;
            font-weight: 500;
            font-size: 0.9rem;
        }

        .helper-text {
            font-size: 0.8rem;
            color: var(--gray);
            margin-top: 6px;
        }

        .helper-text a {
            color: #3498db;
        }

        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-top: 8px;
        }

        .checkbox-group label {
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            font-size: 0.9rem;
        }

        hr.divider {
            border: 0;
            border-top: 1px solid #e8edf3;
            margin: 22px 0;
        }

        /* ‚îÄ‚îÄ Dashboard ‚îÄ‚îÄ */
        #dashboard-view {
            display: none;
            width: 100%;
            max-width: 1000px;
        }

        .dash-hero {
            background: linear-gradient(135deg, var(--navy) 0%, var(--navy-light) 100%);
            border-radius: 16px;
            padding: 30px 36px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 30px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 8px 30px rgba(13, 27, 42, 0.2);
        }

        .dash-hero::before {
            content: '';
            position: absolute;
            top: -40px;
            right: -40px;
            width: 200px;
            height: 200px;
            background: rgba(0, 230, 118, 0.07);
            border-radius: 50%;
        }

        .dash-hero::after {
            content: '';
            position: absolute;
            bottom: -60px;
            right: 80px;
            width: 150px;
            height: 150px;
            background: rgba(0, 230, 118, 0.05);
            border-radius: 50%;
        }

        .hero-left {
            position: relative;
            z-index: 1;
        }

        .hero-greeting {
            font-family: 'Barlow Condensed', sans-serif;
            font-size: 2.2rem;
            font-weight: 800;
            color: white;
            line-height: 1.1;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .hero-greeting span {
            color: var(--green);
        }

        .hero-school {
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.95rem;
            margin-top: 4px;
        }

        .hero-right {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 12px;
            position: relative;
            z-index: 1;
        }

        .mascot-badge {
            background: rgba(0, 230, 118, 0.15);
            border: 1px solid rgba(0, 230, 118, 0.3);
            color: var(--green);
            font-family: 'Barlow Condensed', sans-serif;
            font-size: 1.1rem;
            font-weight: 700;
            padding: 6px 16px;
            border-radius: 20px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn-logout {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: rgba(255, 255, 255, 0.7);
            font-family: 'Barlow Condensed', sans-serif;
            font-size: 0.85rem;
            font-weight: 600;
            padding: 7px 16px;
            border-radius: 6px;
            cursor: pointer;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            transition: all 0.2s;
        }

        .btn-logout:hover {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        /* ‚îÄ‚îÄ Card Grid ‚îÄ‚îÄ */
        #card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }

        .portal-card {
            background: white;
            border-radius: 14px;
            padding: 28px;
            box-shadow: var(--card-shadow);
            border-top: 4px solid var(--green);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .portal-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 32px rgba(13, 27, 42, 0.13);
        }

        .card-icon {
            font-size: 2rem;
            margin-bottom: 12px;
        }

        .portal-card h3 {
            font-family: 'Barlow Condensed', sans-serif;
            font-size: 1.3rem;
            font-weight: 800;
            color: var(--navy);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .portal-card p {
            color: var(--gray);
            font-size: 0.9rem;
            margin-bottom: 20px;
            line-height: 1.5;
        }

        .card-actions {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        /* ‚îÄ‚îÄ Sub-views ‚îÄ‚îÄ */
        .sub-view {
            display: none;
            background: white;
            border-radius: 16px;
            padding: 36px;
            box-shadow: var(--card-shadow);
            width: 100%;
        }

        .sub-view.active {
            display: block;
        }

        .sub-view-header {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 28px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e8edf3;
        }

        .sub-view-header h2 {
            font-family: 'Barlow Condensed', sans-serif;
            font-size: 1.7rem;
            font-weight: 800;
            color: var(--navy);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .back-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--gray);
            font-size: 0.85rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 6px 12px;
            border-radius: 6px;
            transition: all 0.2s;
            white-space: nowrap;
            font-family: 'Barlow', sans-serif;
        }

        .back-btn:hover {
            background: var(--gray-light);
            color: var(--navy);
        }

        /* ‚îÄ‚îÄ Star Ratings ‚îÄ‚îÄ */
        .rating-group {
            margin: 16px 0;
        }

        .stars {
            display: flex;
            gap: 6px;
            margin-top: 6px;
        }

        .star {
            font-size: 1.6rem;
            color: #dde4ed;
            cursor: pointer;
            transition: color 0.15s;
        }

        .star.active {
            color: #f1c40f;
        }

        .star:hover {
            color: #f39c12;
        }

        /* ‚îÄ‚îÄ Expandable History Rows ‚îÄ‚îÄ */
        .history-item {
            background: var(--gray-light);
            border-radius: 10px;
            overflow: hidden;
            border-left: 4px solid #dde4ed;
            transition: border-color 0.2s;
        }

        .history-item.reviewed {
            border-left-color: #00c853;
        }

        .history-item.pending {
            border-left-color: #f39c12;
        }

        .history-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            cursor: pointer;
            gap: 12px;
            user-select: none;
        }

        .history-item-header:hover {
            background: rgba(0, 0, 0, 0.02);
        }

        .hi-left strong {
            color: var(--navy);
            font-size: 1rem;
        }

        .hi-left span {
            display: block;
            color: var(--gray);
            font-size: 0.82rem;
            margin-top: 2px;
        }

        .hi-right {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .expand-icon {
            color: var(--gray);
            font-size: 0.75rem;
            transition: transform 0.2s;
        }

        .history-item.open .expand-icon {
            transform: rotate(180deg);
        }

        .history-item-body {
            display: none;
            padding: 0 20px 18px;
            border-top: 1px solid #e8edf3;
        }

        .history-item.open .history-item-body {
            display: block;
        }

        .detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
            margin-top: 14px;
        }

        .detail-cell {
            background: white;
            border-radius: 8px;
            padding: 10px 14px;
        }

        .detail-cell .dc-label {
            font-size: 0.72rem;
            font-weight: 700;
            color: var(--gray);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .detail-cell .dc-value {
            font-size: 1rem;
            font-weight: 700;
            color: var(--navy);
            margin-top: 2px;
        }

        .star-display {
            color: #f1c40f;
            letter-spacing: 1px;
        }

        /* ‚îÄ‚îÄ Review Sections ‚îÄ‚îÄ */
        .review-section {
            background: var(--gray-light);
            border-radius: 12px;
            padding: 20px 22px;
        }

        .review-section-title {
            font-family: 'Barlow Condensed', sans-serif;
            font-size: 1.1rem;
            font-weight: 800;
            color: var(--navy);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 16px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e8edf3;
        }

        .rating-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 10px;
            padding: 10px 0;
            border-bottom: 1px solid #e8edf3;
        }

        .rating-row:last-child {
            border-bottom: none;
        }

        .rating-row-label {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--navy-mid);
            flex: 1;
            min-width: 160px;
        }

        .rating-row-controls {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .na-btn {
            background: none;
            border: 2px solid #dde4ed;
            color: var(--gray);
            border-radius: 6px;
            font-family: 'Barlow Condensed', sans-serif;
            font-size: 0.8rem;
            font-weight: 700;
            padding: 4px 10px;
            cursor: pointer;
            transition: all 0.2s;
            letter-spacing: 0.5px;
            width: auto;
        }

        .na-btn.active {
            background: #f0f0f0;
            border-color: #aaa;
            color: #555;
        }

        .na-btn.active~.stars {
            opacity: 0.3;
            pointer-events: none;
        }

        /* Clip status badges */
        .status-submitted {
            background: #e8f4fd;
            color: #1a6fa8;
        }

        .status-received {
            background: #fff3cd;
            color: #856404;
        }

        .status-reviewed {
            background: #d1f2eb;
            color: #0e6655;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .discussion-btn {
            margin-top: 14px;
            background: var(--navy);
            color: white;
            border: none;
            padding: 9px 18px;
            border-radius: 7px;
            font-family: 'Barlow Condensed', sans-serif;
            font-size: 0.9rem;
            font-weight: 700;
            letter-spacing: 0.5px;
            cursor: pointer;
            text-transform: uppercase;
            transition: background 0.2s;
        }

        .discussion-btn:hover {
            background: var(--navy-mid);
        }

        .discussion-panel {
            display: none;
            margin-top: 12px;
            background: white;
            border-radius: 8px;
            padding: 14px 16px;
            border-left: 3px solid var(--green);
        }

        .discussion-panel.open {
            display: block;
        }

        .discussion-panel .dp-label {
            font-size: 0.72rem;
            font-weight: 700;
            color: var(--gray);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
        }

        .discussion-panel p {
            color: var(--navy);
            font-size: 0.9rem;
            line-height: 1.5;
            margin: 0;
        }

        /* ‚îÄ‚îÄ Clip upload area ‚îÄ‚îÄ */
        .clip-drop-area {
            border: 2px dashed #dde4ed;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            color: var(--gray);
            font-size: 0.9rem;
            cursor: pointer;
            transition: border-color 0.2s, background 0.2s;
        }

        .clip-drop-area:hover {
            border-color: var(--green-dark);
            background: rgba(0, 200, 83, 0.03);
        }

        .clip-drop-area .drop-icon {
            font-size: 2rem;
            margin-bottom: 8px;
        }

        /* ‚îÄ‚îÄ Modal ‚îÄ‚îÄ */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(13, 27, 42, 0.6);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-card {
            background: white;
            padding: 44px 36px;
            border-radius: 16px;
            text-align: center;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.25);
            animation: popIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .modal-icon {
            font-size: 3rem;
            margin-bottom: 16px;
        }

        .modal-title {
            font-family: 'Barlow Condensed', sans-serif;
            font-size: 1.6rem;
            font-weight: 800;
            color: var(--navy);
            margin-bottom: 8px;
        }

        .modal-text {
            color: var(--gray);
            margin-bottom: 24px;
            line-height: 1.5;
        }

        .modal-btn {
            background: var(--green);
            color: var(--navy);
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-family: 'Barlow Condensed', sans-serif;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            width: 100%;
            text-transform: uppercase;
        }

        .modal-btn:hover {
            background: var(--green-dark);
        }

        @keyframes popIn {
            from {
                opacity: 0;
                transform: scale(0.85);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        /* ‚îÄ‚îÄ Footer ‚îÄ‚îÄ */
        .footer {
            text-align: center;
            padding: 30px 20px;
            color: var(--gray);
            font-size: 0.82rem;
            border-top: 1px solid #dde4ed;
            margin-top: 50px;
            width: 100%;
        }

        .footer a {
            color: #3498db;
            text-decoration: none;
        }

        /* ‚îÄ‚îÄ Misc ‚îÄ‚îÄ */
        .section-label {
            font-family: 'Barlow Condensed', sans-serif;
            font-size: 1rem;
            font-weight: 700;
            color: var(--navy-mid);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .section-label::after {
            content: '';
            flex: 1;
            height: 1px;
            background: #e8edf3;
        }

        .history-grid {
            display: grid;
            gap: 12px;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--gray);
        }

        .empty-state .empty-icon {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
    </style>
</head>

<body>
    <!-- Header -->
    <div class="site-header">
        <div>
            <img src="assets/NickNak_logo.svg" alt="NC HS Soccer" class="logo-img" onerror="this.style.display='none'">
        </div>
        <div class="partnership-text">--A Partnership Initiative--<br>The North Carolina HS Coach's Portal</div>
        <div>
            <a href="https://www.trianglerefs.org/"><img src="assets/TSOA_logo.svg" alt="TSOA" class="logo-img"
                    onerror="this.style.display='none'"></a>
        </div>
    </div>

    <div class="page">

        <!-- ‚ïê‚ïê LOGIN VIEW ‚ïê‚ïê -->
        <div id="login-view" class="auth-card">
            <h1>Coach Portal</h1>
            <p class="sub">Enter your email to access your dashboard.</p>

            <div class="form-group">
                <label class="form-label" for="coachEmail">Email Address</label>
                <input type="email" id="coachEmail" class="form-control" placeholder="coach@school.edu"
                    onkeypress="handleEnter(event)">
            </div>

            <button class="btn btn-primary" onclick="login()">Login</button>

            <div id="error-msg" class="error-msg"></div>
            <div id="loading" style="display:none; margin-top:14px; color:var(--gray); font-size:0.9rem;">Verifying...
            </div>

            <p style="margin-top:18px; font-size:0.9rem; color:var(--gray);">
                Need an account? <button class="link-btn" onclick="showRegister()">Request Access</button>
            </p>
        </div>

        <!-- ‚ïê‚ïê REGISTER VIEW ‚ïê‚ïê -->
        <div id="register-view" class="auth-card wide" style="display:none;">
            <h1>Request Access</h1>
            <p class="sub">Submit your details for admin approval.</p>

            <div class="grid-2">
                <div class="form-group">
                    <label class="form-label">First Name</label>
                    <input type="text" id="regFirstName" class="form-control">
                </div>
                <div class="form-group">
                    <label class="form-label">Last Name</label>
                    <input type="text" id="regLastName" class="form-control">
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Email Address</label>
                <input type="email" id="regEmail" class="form-control">
            </div>

            <div class="form-group">
                <label class="form-label">School Affiliation</label>
                <input type="text" id="regSchool" class="form-control" placeholder="Enter High School Name">
            </div>

            <div class="form-group">
                <label class="form-label">Regional Supervisor</label>
                <select id="regSupervisor" class="form-control">
                    <option value="">Select your area's Regional Supervisor...</option>
                    <option value="Ben Wooten - Foothills">Ben Wooten - Foothills</option>
                    <option value="Cliff Clement - Eastern">Cliff Clement - Eastern</option>
                    <option value="Darren Dawson - Eastern Plains">Darren Dawson - Eastern Plains</option>
                    <option value="Eric Usher - Western NC">Eric Usher - Western NC</option>
                    <option value="Ernie Fisher - Southeastern">Ernie Fisher - Southeastern</option>
                    <option value="Mark Buda - Metrolina">Mark Buda - Metrolina</option>
                    <option value="Mark Kadlecik - Triangle">Mark Kadlecik - Triangle</option>
                    <option value="Roger Morgan - Albemarle">Roger Morgan - Albemarle</option>
                    <option value="Roger Morton - Piedmont">Roger Morton - Piedmont</option>
                </select>
                <div class="helper-text">Don't know your supervisor? <a
                        href="https://www.nchsaa.org/regional-supervisors/" target="_blank">Click here</a></div>
            </div>

            <hr class="divider">

            <div class="form-group">
                <label class="form-label">Does your team film/record games?</label>
                <div style="display:flex; gap:20px; margin-top:8px;">
                    <label style="cursor:pointer;"><input type="radio" name="regFilm" value="Yes"
                            onclick="toggleFilmAndPlatforms(true)"> Yes</label>
                    <label style="cursor:pointer;"><input type="radio" name="regFilm" value="No"
                            onclick="toggleFilmAndPlatforms(false)"> No</label>
                </div>
            </div>

            <div id="film-platforms" style="display:none;" class="form-group">
                <label class="form-label">What platform do you use?</label>
                <div class="checkbox-group">
                    <label><input type="checkbox" name="regPlatform" value="NFHS Network"> NFHS Network</label>
                    <label><input type="checkbox" name="regPlatform" value="Veo"> Veo</label>
                    <label><input type="checkbox" name="regPlatform" value="Trace"> Trace</label>
                    <label><input type="checkbox" name="regPlatform" value="HUDL"> HUDL</label>
                    <label><input type="checkbox" name="regPlatform" value="Other" onchange="toggleOtherFilm(this)">
                        Other</label>
                </div>
                <input type="text" id="regPlatformOther" class="form-control" style="display:none; margin-top:10px;"
                    placeholder="Please specify platform...">
            </div>

            <hr class="divider">

            <div class="form-group">
                <label class="form-label">Do you know your team's uniform colors this season?</label>
                <div style="display:flex; gap:20px; margin-top:8px;">
                    <label style="cursor:pointer;"><input type="radio" name="regUniformsKV" value="Yes"
                            onclick="toggleUniforms(true)"> Yes</label>
                    <label style="cursor:pointer;"><input type="radio" name="regUniformsKV" value="No"
                            onclick="toggleUniforms(false)"> No</label>
                </div>
            </div>

            <div id="uniform-details" style="display:none;">
                <div class="section-label">Home Uniforms</div>
                <div class="grid-4">
                    <div class="form-group">
                        <label class="form-label" style="font-size:0.75rem;">Shirt</label>
                        <input type="text" id="regHomeShirt" class="form-control" placeholder="Color">
                    </div>
                    <div class="form-group">
                        <label class="form-label" style="font-size:0.75rem;">Shorts</label>
                        <input type="text" id="regHomeShorts" class="form-control" placeholder="Color">
                    </div>
                    <div class="form-group">
                        <label class="form-label" style="font-size:0.75rem;">Socks</label>
                        <input type="text" id="regHomeSocks" class="form-control" placeholder="Color">
                    </div>
                    <div class="form-group">
                        <label class="form-label" style="font-size:0.75rem;">GK</label>
                        <input type="text" id="regHomeGK" class="form-control" placeholder="Color">
                    </div>
                </div>

                <div class="section-label" style="margin-top:10px;">Away Uniforms</div>
                <div class="grid-4">
                    <div class="form-group">
                        <label class="form-label" style="font-size:0.75rem;">Shirt</label>
                        <input type="text" id="regAwayShirt" class="form-control" placeholder="Color">
                    </div>
                    <div class="form-group">
                        <label class="form-label" style="font-size:0.75rem;">Shorts</label>
                        <input type="text" id="regAwayShorts" class="form-control" placeholder="Color">
                    </div>
                    <div class="form-group">
                        <label class="form-label" style="font-size:0.75rem;">Socks</label>
                        <input type="text" id="regAwaySocks" class="form-control" placeholder="Color">
                    </div>
                    <div class="form-group">
                        <label class="form-label" style="font-size:0.75rem;">GK</label>
                        <input type="text" id="regAwayGK" class="form-control" placeholder="Color">
                    </div>
                </div>
            </div>

            <button class="btn btn-primary" onclick="register()" style="margin-top:16px;">Request Access</button>

            <p style="margin-top:16px; font-size:0.9rem; color:var(--gray);">
                Already have an account? <button class="link-btn" onclick="showLogin()">Login Here</button>
            </p>

            <div id="reg-error-msg" class="error-msg"></div>
            <div id="reg-loading" style="display:none; margin-top:14px; color:var(--gray); font-size:0.9rem;">Submitting
                Request...</div>
        </div>

        <!-- ‚ïê‚ïê DASHBOARD VIEW ‚ïê‚ïê -->
        <div id="dashboard-view">

            <!-- Hero Banner -->
            <div class="dash-hero">
                <div class="hero-left">
                    <div class="hero-greeting">Hi, Coach <span id="welcomeMsg">‚Äî</span>!</div>
                    <div class="hero-school" id="schoolMsg">School Affiliation</div>
                </div>
                <div class="hero-right">
                    <div class="mascot-badge" id="mascotMsg">Go Team!</div>
                    <button class="btn-logout" onclick="logout()">‚èª Logout</button>
                </div>
            </div>

            <!-- Card Grid -->
            <div id="card-grid">

                <!-- Performance Reviews Card -->
                <div class="portal-card">
                    <div class="card-icon">üìã</div>
                    <h3>Performance Reviews</h3>
                    <p>Submit post-game feedback for match officials or view the status of your past submissions.</p>
                    <div class="card-actions">
                        <button class="btn btn-primary btn-sm" onclick="showSubView('review-form-view')">+ New
                            Review</button>
                        <button class="btn btn-ghost btn-sm"
                            onclick="showSubView('review-history-view'); loadPastReviews();">View History</button>
                    </div>
                </div>

                <!-- Clip Discussion Card -->
                <div class="portal-card">
                    <div class="card-icon">üé¨</div>
                    <h3>Clip Discussion</h3>
                    <p>Submit a game clip for our officiating team to review and provide feedback on specific moments.
                    </p>
                    <div class="card-actions">
                        <button class="btn btn-primary btn-sm" onclick="showSubView('clip-form-view')">Submit a
                            Clip</button>
                        <button class="btn btn-ghost btn-sm"
                            onclick="showSubView('clip-history-view'); loadPastClips();">Past Submissions</button>
                    </div>
                </div>

            </div>

            <!-- ‚îÄ‚îÄ Sub-view: New Review Form ‚îÄ‚îÄ -->
            <div id="review-form-view" class="sub-view">
                <div class="sub-view-header">
                    <button class="back-btn" onclick="showCardGrid()">‚Üê Back</button>
                    <h2>Official Performance Review</h2>
                </div>

                <p style="color:var(--gray); margin-bottom:24px; font-size:0.95rem;">Provide honest feedback to help
                    improve the quality of officiating.</p>

                <div class="grid-2">
                    <div class="form-group">
                        <label class="form-label">Game Date</label>
                        <input type="date" id="gameDate" class="form-control">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Level</label>
                        <select id="gameLevel" class="form-control" onchange="toggleLevelRatings()">
                            <option value="">Select Level...</option>
                            <option value="JV">JV</option>
                            <option value="Varsity">Varsity</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Opponent</label>
                    <input type="text" id="opponent" class="form-control" placeholder="Enter school name">
                </div>

                <hr class="divider">

                <!-- ‚ïê‚ïê‚ïê JV Ratings ‚ïê‚ïê‚ïê -->
                <div id="jv-ratings" style="display:none;">

                    <div class="review-section">
                        <div class="review-section-title">üü¶ Home Side Referee</div>
                        <div id="jv-home-ref-rows"></div>
                    </div>

                    <div class="review-section" style="margin-top:24px;">
                        <div class="review-section-title">üüß Away Side Referee</div>
                        <div id="jv-away-ref-rows"></div>
                    </div>

                </div>

                <!-- ‚ïê‚ïê‚ïê Varsity Ratings ‚ïê‚ïê‚ïê -->
                <div id="varsity-ratings" style="display:none;">

                    <div class="review-section">
                        <div class="review-section-title">‚öΩ Referee</div>
                        <div id="v-ref-rows"></div>
                    </div>

                    <div class="review-section" style="margin-top:24px;">
                        <div class="review-section-title">üü¶ Home Side AR</div>
                        <div id="v-home-ar-rows"></div>
                    </div>

                    <div class="review-section" style="margin-top:24px;">
                        <div class="review-section-title">üüß Away Side AR</div>
                        <div id="v-away-ar-rows"></div>
                    </div>

                </div>

                <div style="display:flex; gap:12px; margin-top:28px;">
                    <button class="btn btn-primary" onclick="submitReview()" style="flex:2;">Submit Review</button>
                    <button class="btn btn-ghost" onclick="showCardGrid()" style="flex:1;">Cancel</button>
                </div>
            </div>

            <!-- ‚îÄ‚îÄ Sub-view: Review History ‚îÄ‚îÄ -->
            <div id="review-history-view" class="sub-view">
                <div class="sub-view-header">
                    <button class="back-btn" onclick="showCardGrid()">‚Üê Back</button>
                    <h2>Review History</h2>
                </div>
                <div id="history-content" class="history-grid">
                    <div class="empty-state">
                        <div class="empty-icon">üìã</div>
                        <p>Loading...</p>
                    </div>
                </div>
            </div>

            <!-- ‚îÄ‚îÄ Sub-view: Clip History ‚îÄ‚îÄ -->
            <div id="clip-history-view" class="sub-view">
                <div class="sub-view-header">
                    <button class="back-btn" onclick="showCardGrid()">‚Üê Back</button>
                    <h2>üé¨ Past Clip Submissions</h2>
                </div>
                <div id="clip-history-content" class="history-grid">
                    <div class="empty-state">
                        <div class="empty-icon">‚è≥</div>
                        <p>Loading...</p>
                    </div>
                </div>
            </div>

            <!-- ‚îÄ‚îÄ Sub-view: Clip Discussion Form ‚îÄ‚îÄ -->
            <div id="clip-form-view" class="sub-view">
                <div class="sub-view-header">
                    <button class="back-btn" onclick="showCardGrid()">‚Üê Back</button>
                    <h2>üé¨ Clip Discussion</h2>
                </div>

                <p style="color:var(--gray); margin-bottom:24px; font-size:0.95rem;">Submit a clip for our officiating
                    team to review. We'll provide feedback on the specific moment you'd like discussed.</p>

                <div class="grid-2">
                    <div class="form-group">
                        <label class="form-label">Game Date</label>
                        <input type="date" id="clipDate" class="form-control">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Level</label>
                        <select id="clipLevel" class="form-control">
                            <option value="">Select Level...</option>
                            <option value="JV">JV</option>
                            <option value="Varsity">Varsity</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Opponent</label>
                    <input type="text" id="clipOpponent" class="form-control" placeholder="Enter school name">
                </div>

                <hr class="divider">

                <div class="form-group">
                    <label class="form-label">Where can we find this clip?</label>
                    <textarea id="clipLocation" class="form-control" rows="3"
                        placeholder="e.g. HUDL link, NFHS Network URL, Veo clip link, YouTube link, or describe where to find it (platform + timestamp)..."></textarea>
                    <div class="helper-text">Paste a direct link or describe how to access the clip (platform, game,
                        timestamp).</div>
                </div>

                <div class="form-group">
                    <label class="form-label">What would you like us to look at?</label>
                    <textarea id="clipNotes" class="form-control" rows="3"
                        placeholder="Describe the specific moment or decision you'd like feedback on..."></textarea>
                </div>

                <div id="clip-error" class="error-msg"></div>

                <div style="display:flex; gap:12px; margin-top:24px;">
                    <button class="btn btn-primary" onclick="submitClip()" style="flex:2;">Submit Clip</button>
                    <button class="btn btn-ghost" onclick="showCardGrid()" style="flex:1;">Cancel</button>
                </div>
            </div>

        </div><!-- /dashboard-view -->

        <div class="footer">
            <p><a href="index.html">‚Üê Back to Home</a> &nbsp;|&nbsp; ¬© 2026 NC HS Soccer. All Rights Reserved.</p>
        </div>

    </div><!-- /page -->

    <!-- ‚ïê‚ïê STATUS MODAL ‚ïê‚ïê -->
    <div id="statusModal" class="modal-overlay">
        <div class="modal-card">
            <div id="modalIcon" class="modal-icon">‚è≥</div>
            <div id="modalTitle" class="modal-title">Please Wait</div>
            <div id="modalText" class="modal-text">Processing your request...</div>
            <button id="modalBtn" class="modal-btn" onclick="closeModal()" style="display:none;">OK</button>
        </div>
    </div>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxybcAnWIZ-6s2cBAAKpGRFh4fWrQegDULwY5bb5dfPhaNVWOS_rc0hP-uCHUt3r5td/exec";
        let currentUserEmail = '';
        let currentUserData = { firstName: '', lastName: '', school: '' };
        const ratings = {};

        // ‚îÄ‚îÄ Modal ‚îÄ‚îÄ
        function showModal(title, text, icon, showButton) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalText').textContent = text;
            document.getElementById('modalIcon').textContent = icon;
            document.getElementById('modalBtn').style.display = showButton ? 'block' : 'none';
            document.getElementById('statusModal').style.display = 'flex';
        }
        function closeModal() {
            document.getElementById('statusModal').style.display = 'none';
        }

        // ‚îÄ‚îÄ Navigation ‚îÄ‚îÄ
        function showView(id) {
            ['login-view', 'register-view', 'dashboard-view'].forEach(v => {
                document.getElementById(v).style.display = 'none';
            });
            document.getElementById(id).style.display = (id === 'dashboard-view') ? 'block' : 'flex';
            if (id !== 'dashboard-view') document.getElementById(id).style.display = 'block';
        }

        function showSubView(id) {
            // Hide card grid, show sub-view
            document.getElementById('card-grid').style.display = 'none';
            document.querySelectorAll('.sub-view').forEach(v => v.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function showCardGrid() {
            document.querySelectorAll('.sub-view').forEach(v => v.classList.remove('active'));
            document.getElementById('card-grid').style.display = 'grid';
        }

        function showLogin() {
            showView('login-view');
            document.getElementById('error-msg').style.display = 'none';
        }

        function showRegister() {
            showView('register-view');
            document.getElementById('reg-error-msg').style.display = 'none';
        }

        function handleEnter(e) { if (e.key === 'Enter') login(); }

        // ‚îÄ‚îÄ Login ‚îÄ‚îÄ
        function login() {
            const email = document.getElementById('coachEmail').value.trim();
            const errorDiv = document.getElementById('error-msg');
            const loadingDiv = document.getElementById('loading');

            if (!email) { errorDiv.textContent = 'Please enter an email address.'; errorDiv.style.display = 'block'; return; }

            errorDiv.style.display = 'none';
            loadingDiv.style.display = 'block';

            fetch(`${SCRIPT_URL}?action=coachLogin&email=${encodeURIComponent(email)}`)
                .then(r => r.json())
                .then(data => {
                    loadingDiv.style.display = 'none';
                    if (data.status === 'success') {
                        currentUserEmail = email;
                        showDashboard(data);
                    } else {
                        errorDiv.textContent = data.message || 'Login failed. Please check your email.';
                        errorDiv.style.display = 'block';
                    }
                })
                .catch(err => {
                    loadingDiv.style.display = 'none';
                    errorDiv.textContent = 'Connection error: ' + err.toString();
                    errorDiv.style.display = 'block';
                });
        }

        function showDashboard(data) {
            showView('dashboard-view');
            currentUserData = { firstName: data.firstName || '', lastName: data.lastName || '', school: data.school || '' };
            document.getElementById('welcomeMsg').textContent = data.lastName || data.firstName || 'Coach';
            document.getElementById('schoolMsg').textContent = data.school || '';
            document.getElementById('mascotMsg').textContent = data.mascot ? `Go ${data.mascot}!` : '';
        }

        function logout() { location.reload(); }

        // ‚îÄ‚îÄ Registration ‚îÄ‚îÄ
        function toggleFilmAndPlatforms(isYes) {
            document.getElementById('film-platforms').style.display = isYes ? 'block' : 'none';
        }
        function toggleUniforms(isYes) {
            document.getElementById('uniform-details').style.display = isYes ? 'block' : 'none';
        }
        function toggleOtherFilm(checkbox) {
            document.getElementById('regPlatformOther').style.display = checkbox.checked ? 'block' : 'none';
            if (!checkbox.checked) document.getElementById('regPlatformOther').value = '';
        }

        function register() {
            const firstName = document.getElementById('regFirstName').value.trim();
            const lastName = document.getElementById('regLastName').value.trim();
            const email = document.getElementById('regEmail').value.trim();
            const school = document.getElementById('regSchool').value.trim();
            const supervisor = document.getElementById('regSupervisor').value;
            const errorDiv = document.getElementById('reg-error-msg');

            const filmRadio = document.querySelector('input[name="regFilm"]:checked');
            const film = filmRadio ? filmRadio.value : '';
            let platforms = [];
            if (film === 'Yes') {
                document.querySelectorAll('input[name="regPlatform"]:checked').forEach(cb => {
                    if (cb.value === 'Other') {
                        const t = document.getElementById('regPlatformOther').value.trim();
                        if (t) platforms.push('Other: ' + t);
                    } else { platforms.push(cb.value); }
                });
            }

            const uniformRadio = document.querySelector('input[name="regUniformsKV"]:checked');
            const knowUniforms = uniformRadio ? uniformRadio.value : '';

            errorDiv.style.display = 'none';

            if (!firstName || !lastName || !email || !school || !supervisor) {
                errorDiv.textContent = 'Please fill in all required fields including Supervisor.';
                errorDiv.style.display = 'block'; return;
            }
            if (!film) {
                errorDiv.textContent = 'Please select whether you film games.';
                errorDiv.style.display = 'block'; return;
            }
            if (film === 'Yes' && platforms.length === 0) {
                errorDiv.textContent = 'Please select at least one platform.';
                errorDiv.style.display = 'block'; return;
            }
            if (!knowUniforms) {
                errorDiv.textContent = 'Please select whether you know your uniform colors.';
                errorDiv.style.display = 'block'; return;
            }

            let homeUniform = 'N/A', awayUniform = 'N/A';
            if (knowUniforms === 'Yes') {
                const h1 = document.getElementById('regHomeShirt').value.trim();
                const h2 = document.getElementById('regHomeShorts').value.trim();
                const h3 = document.getElementById('regHomeSocks').value.trim();
                const h4 = document.getElementById('regHomeGK').value.trim();
                const a1 = document.getElementById('regAwayShirt').value.trim();
                const a2 = document.getElementById('regAwayShorts').value.trim();
                const a3 = document.getElementById('regAwaySocks').value.trim();
                const a4 = document.getElementById('regAwayGK').value.trim();
                if (!h1 || !h2 || !h3 || !h4 || !a1 || !a2 || !a3 || !a4) {
                    errorDiv.textContent = 'Please fill in all uniform colors.';
                    errorDiv.style.display = 'block'; return;
                }
                homeUniform = `Home: ${h1}/${h2}/${h3} (GK: ${h4})`;
                awayUniform = `Away: ${a1}/${a2}/${a3} (GK: ${a4})`;
            }

            showModal('Submitting Request...', 'Please wait while we process your registration.', '‚è≥', false);

            const payload = {
                type: 'register', firstName, lastName, email, school, supervisor,
                film, platform: platforms.join(', '),
                homeUniform, awayUniform,
                homeShirt: document.getElementById('regHomeShirt').value.trim(),
                homeShorts: document.getElementById('regHomeShorts').value.trim(),
                homeSocks: document.getElementById('regHomeSocks').value.trim(),
                homeGK: document.getElementById('regHomeGK').value.trim(),
                awayShirt: document.getElementById('regAwayShirt').value.trim(),
                awayShorts: document.getElementById('regAwayShorts').value.trim(),
                awaySocks: document.getElementById('regAwaySocks').value.trim(),
                awayGK: document.getElementById('regAwayGK').value.trim()
            };

            fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(payload) })
                .then(r => r.json())
                .then(data => {
                    if (data.status === 'success') {
                        showModal('Request Submitted!', 'Your account request has been sent. You will receive an email once approved.', '‚úÖ', true);
                        showLogin();
                        document.getElementById('regFirstName').value = '';
                        document.getElementById('regLastName').value = '';
                        document.getElementById('regEmail').value = '';
                        document.getElementById('regSchool').value = '';
                        document.getElementById('regSupervisor').value = '';
                        document.querySelectorAll('input[type="radio"]').forEach(r => r.checked = false);
                        document.querySelectorAll('input[type="checkbox"]').forEach(c => c.checked = false);
                        toggleFilmAndPlatforms(false);
                        toggleUniforms(false);
                    } else {
                        closeModal();
                        errorDiv.textContent = data.message || 'Registration failed.';
                        errorDiv.style.display = 'block';
                    }
                })
                .catch(err => {
                    closeModal();
                    errorDiv.textContent = 'Error: ' + err.toString();
                    errorDiv.style.display = 'block';
                });
        }

        // ‚îÄ‚îÄ Performance Review ‚îÄ‚îÄ

        // Metric definitions
        const JV_REF_METRICS = [
            { key: 'pregame_comm', label: 'Pre-Game Communication' },
            { key: 'appearance', label: 'Appearance' },
            { key: 'fitness', label: 'Fitness / Movement' },
            { key: 'game_mgmt', label: 'Game Management' },
            { key: 'ingame_comm', label: 'In-Game Communication' },
            { key: 'teamwork', label: 'Teamwork' }
        ];
        const V_REF_METRICS = [
            { key: 'pregame_comm', label: 'Pre-Game Communication' },
            { key: 'appearance', label: 'Appearance' },
            { key: 'movement', label: 'Movement / Fitness' },
            { key: 'teamwork', label: 'Teamwork' },
            { key: 'game_mgmt', label: 'Game Management' },
            { key: 'ingame_comm', label: 'In-Game Communication' }
        ];
        const AR_METRICS = [
            { key: 'appearance', label: 'Appearance' },
            { key: 'fitness', label: 'Fitness' },
            { key: 'positioning', label: 'Positioning' },
            { key: 'communication', label: 'Communication' },
            { key: 'teamwork', label: 'Teamwork' }
        ];

        // Build a rating row element; prefix ensures unique metric keys per section
        function buildRatingRow(prefix, metric) {
            const fullKey = prefix + '_' + metric.key;
            const wrapper = document.createElement('div');

            const row = document.createElement('div');
            row.className = 'rating-row';
            row.dataset.metric = fullKey;

            const label = document.createElement('div');
            label.className = 'rating-row-label';
            label.textContent = metric.label;

            const controls = document.createElement('div');
            controls.className = 'rating-row-controls';

            const naBtn = document.createElement('button');
            naBtn.className = 'na-btn';
            naBtn.type = 'button';
            naBtn.textContent = 'N/A';
            naBtn.onclick = () => toggleNA(naBtn, fullKey);

            const starsDiv = document.createElement('div');
            starsDiv.className = 'stars';

            // Low-rating reason box (shown when 1 or 2 stars)
            const reasonBox = document.createElement('div');
            reasonBox.style.cssText = 'display:none; padding: 8px 0 4px 0;';
            const reasonTA = document.createElement('textarea');
            reasonTA.id = fullKey + '_reason';
            reasonTA.className = 'form-control';
            reasonTA.placeholder = 'Please explain this rating...';
            reasonTA.rows = 2;
            reasonTA.style.cssText = 'font-size:0.85rem; resize:vertical; min-height:52px;';
            reasonBox.appendChild(reasonTA);

            for (let i = 1; i <= 5; i++) {
                const s = document.createElement('span');
                s.className = 'star';
                s.textContent = '‚òÖ';
                s.onclick = function () {
                    rate(s, i, fullKey);
                    // Show/hide reason box
                    reasonBox.style.display = i <= 2 ? 'block' : 'none';
                    if (i > 2) reasonTA.value = '';
                };
                starsDiv.appendChild(s);
            }

            controls.appendChild(naBtn);
            controls.appendChild(starsDiv);
            row.appendChild(label);
            row.appendChild(controls);
            wrapper.appendChild(row);
            wrapper.appendChild(reasonBox);
            return wrapper;
        }

        function buildSection(containerId, prefix, metrics) {
            const el = document.getElementById(containerId);
            el.innerHTML = '';
            metrics.forEach(m => el.appendChild(buildRatingRow(prefix, m)));
            // Section-level additional notes
            const notesWrap = document.createElement('div');
            notesWrap.style.cssText = 'margin-top:12px;';
            const notesLabel = document.createElement('div');
            notesLabel.className = 'rating-row-label';
            notesLabel.style.cssText = 'margin-bottom:6px; font-weight:700;';
            notesLabel.textContent = 'Additional Notes (optional)';
            const notesTA = document.createElement('textarea');
            notesTA.id = prefix + '_section_notes';
            notesTA.className = 'form-control';
            notesTA.placeholder = 'Any additional comments about this official...';
            notesTA.rows = 3;
            notesTA.style.cssText = 'font-size:0.875rem; resize:vertical;';
            notesWrap.appendChild(notesLabel);
            notesWrap.appendChild(notesTA);
            el.appendChild(notesWrap);
        }

        function toggleLevelRatings() {
            const level = document.getElementById('gameLevel').value;
            const jv = document.getElementById('jv-ratings');
            const v = document.getElementById('varsity-ratings');

            // Reset ratings
            Object.keys(ratings).forEach(k => delete ratings[k]);

            if (level === 'JV') {
                jv.style.display = 'block';
                v.style.display = 'none';
                buildSection('jv-home-ref-rows', 'jv_home_ref', JV_REF_METRICS);
                buildSection('jv-away-ref-rows', 'jv_away_ref', JV_REF_METRICS);
            } else if (level === 'Varsity') {
                jv.style.display = 'none';
                v.style.display = 'block';
                buildSection('v-ref-rows', 'v_ref', V_REF_METRICS);
                buildSection('v-home-ar-rows', 'v_home_ar', AR_METRICS);
                buildSection('v-away-ar-rows', 'v_away_ar', AR_METRICS);
            } else {
                jv.style.display = 'none';
                v.style.display = 'none';
            }
        }

        function rate(star, value, fullKey) {
            ratings[fullKey] = value;
            // Un-NA the row
            const row = star.closest('.rating-row');
            const naBtn = row.querySelector('.na-btn');
            if (naBtn) naBtn.classList.remove('active');
            row.querySelectorAll('.star').forEach((s, i) => s.classList.toggle('active', i < value));
        }

        function toggleNA(btn, fullKey) {
            btn.classList.toggle('active');
            if (btn.classList.contains('active')) {
                ratings[fullKey] = 'N/A';
                // Clear star highlights
                btn.nextElementSibling.querySelectorAll('.star').forEach(s => s.classList.remove('active'));
            } else {
                delete ratings[fullKey];
            }
        }

        // Collect all keys for a prefix group, including low-rating reasons and section notes
        function collectGroup(prefix, metrics) {
            const result = {};
            metrics.forEach(m => {
                const k = prefix + '_' + m.key;
                result[m.key] = ratings[k] !== undefined ? ratings[k] : null;
                // Collect low-rating reason if present
                const reasonEl = document.getElementById(k + '_reason');
                if (reasonEl && reasonEl.value.trim()) {
                    result[m.key + '_reason'] = reasonEl.value.trim();
                }
            });
            // Section notes
            const notesEl = document.getElementById(prefix + '_section_notes');
            if (notesEl) result['_notes'] = notesEl.value.trim();
            return result;
        }

        // Check that every key in a group has been rated (either 1-5 or 'N/A')
        function groupComplete(prefix, metrics) {
            return metrics.every(m => ratings[prefix + '_' + m.key] !== undefined);
        }

        function submitReview() {
            const date = document.getElementById('gameDate').value;
            const opponent = document.getElementById('opponent').value.trim();
            const level = document.getElementById('gameLevel').value;

            if (!date || !opponent || !level) { alert('Please fill in all game details.'); return; }

            let ratingPayload = {};

            if (level === 'JV') {
                if (!groupComplete('jv_home_ref', JV_REF_METRICS) ||
                    !groupComplete('jv_away_ref', JV_REF_METRICS)) {
                    alert('Please rate all categories for both referees (or mark N/A).'); return;
                }
                ratingPayload = {
                    jv_home_ref: collectGroup('jv_home_ref', JV_REF_METRICS),
                    jv_away_ref: collectGroup('jv_away_ref', JV_REF_METRICS)
                };
            } else if (level === 'Varsity') {
                if (!groupComplete('v_ref', V_REF_METRICS) ||
                    !groupComplete('v_home_ar', AR_METRICS) ||
                    !groupComplete('v_away_ar', AR_METRICS)) {
                    alert('Please rate all categories for all officials (or mark N/A).'); return;
                }
                ratingPayload = {
                    v_ref: collectGroup('v_ref', V_REF_METRICS),
                    v_home_ar: collectGroup('v_home_ar', AR_METRICS),
                    v_away_ar: collectGroup('v_away_ar', AR_METRICS)
                };
            }

            const payload = {
                type: 'review_submission',
                coachEmail: currentUserEmail,
                coachName: `${currentUserData.firstName} ${currentUserData.lastName}`.trim(),
                coachSchool: currentUserData.school,
                date, opponent, level,
                ratings: ratingPayload
            };

            showModal('Submitting Review...', 'Please wait...', '‚è≥', false);

            fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(payload) })
                .then(r => r.json())
                .then(data => {
                    if (data.status === 'success') {
                        showModal('Review Submitted!', 'Thank you for your feedback. We will review it shortly.', '‚úÖ', true);
                        document.getElementById('gameDate').value = '';
                        document.getElementById('opponent').value = '';
                        document.getElementById('gameLevel').value = '';
                        toggleLevelRatings();
                        showCardGrid();
                    } else {
                        closeModal();
                        alert('Submission failed: ' + data.message);
                    }
                })
                .catch(err => { closeModal(); alert('Error: ' + err.toString()); });
        }


        // ‚îÄ‚îÄ Review History ‚îÄ‚îÄ
        function loadPastReviews() {
            const historyDiv = document.getElementById('history-content');
            historyDiv.innerHTML = '<div class="empty-state"><div class="empty-icon">‚è≥</div><p>Loading...</p></div>';

            if (!currentUserEmail) {
                historyDiv.innerHTML = '<div class="empty-state"><p style="color:red;">Session lost. Please logout and login again.</p></div>';
                return;
            }

            fetch(`${SCRIPT_URL}?action=getPastReviews&email=${encodeURIComponent(currentUserEmail)}`)
                .then(r => r.json())
                .then(data => {
                    historyDiv.innerHTML = '';
                    if (data.status === 'success' && data.reviews.length > 0) {
                        data.reviews.forEach((r, idx) => {
                            const date = r.date ? new Date(r.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) : 'N/A';
                            const reviewed = r.reviewed;
                            const statusClass = reviewed ? 'status-reviewed' : 'status-pending';
                            const statusText = reviewed ? '‚úì Reviewed' : 'Pending';
                            const borderClass = reviewed ? 'reviewed' : 'pending';

                            // Render a value: star string or 'N/A' or '‚Äî'
                            const display = (val) => {
                                if (val === 'N/A' || val === null || val === undefined || val === '') return '<span style="color:#aaa;font-size:0.8rem;">N/A</span>';
                                const n = parseInt(val);
                                return `<span class="star-display">${'‚òÖ'.repeat(Math.min(5, n))}${'‚òÜ'.repeat(Math.max(0, 5 - n))}</span>`;
                            };

                            // Build a mini section table
                            const sectionHtml = (title, secObj, keys) => {
                                if (!secObj) return '';
                                let h = `<div style="margin-top:12px;">
                                    <div style="font-size:0.72rem;font-weight:800;color:var(--navy);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:8px;">${title}</div>
                                    <div class="detail-grid">`;
                                keys.forEach(({ key, label }) => {
                                    h += `<div class="detail-cell"><div class="dc-label">${label}</div><div class="dc-value">${display(secObj[key])}</div></div>`;
                                });
                                h += '</div></div>';
                                return h;
                            };

                            const JV_KEYS = [{ key: 'pregame_comm', label: 'Pre-Game Comm' }, { key: 'appearance', label: 'Appearance' }, { key: 'fitness', label: 'Fitness/Movement' }, { key: 'game_mgmt', label: 'Game Mgmt' }, { key: 'ingame_comm', label: 'In-Game Comm' }, { key: 'teamwork', label: 'Teamwork' }];
                            const VREF_KEYS = [{ key: 'pregame_comm', label: 'Pre-Game Comm' }, { key: 'appearance', label: 'Appearance' }, { key: 'movement', label: 'Movement/Fitness' }, { key: 'teamwork', label: 'Teamwork' }, { key: 'game_mgmt', label: 'Game Mgmt' }, { key: 'ingame_comm', label: 'In-Game Comm' }];
                            const AR_KEYS = [{ key: 'appearance', label: 'Appearance' }, { key: 'fitness', label: 'Fitness' }, { key: 'positioning', label: 'Positioning' }, { key: 'communication', label: 'Communication' }, { key: 'teamwork', label: 'Teamwork' }];

                            let detailsHtml = `<div class="detail-grid"><div class="detail-cell"><div class="dc-label">Level</div><div class="dc-value">${r.level || '‚Äî'}</div></div></div>`;

                            const rt = r.ratings || {};
                            if (r.level === 'JV') {
                                detailsHtml += sectionHtml('üü¶ Home Side Referee', rt.jv_home_ref, JV_KEYS);
                                detailsHtml += sectionHtml('üüß Away Side Referee', rt.jv_away_ref, JV_KEYS);
                            } else {
                                detailsHtml += sectionHtml('‚öΩ Referee', rt.v_ref, VREF_KEYS);
                                detailsHtml += sectionHtml('üü¶ Home Side AR', rt.v_home_ar, AR_KEYS);
                                detailsHtml += sectionHtml('üüß Away Side AR', rt.v_away_ar, AR_KEYS);
                            }

                            const item = document.createElement('div');
                            item.className = `history-item ${borderClass}`;
                            item.id = `review-item-${idx}`;
                            item.innerHTML = `
                                <div class="history-item-header" onclick="toggleHistoryItem('review-item-${idx}')">
                                    <div class="hi-left">
                                        <strong>vs. ${r.opponent || 'Unknown'}</strong>
                                        <span>${date} ¬∑ ${r.level || ''}</span>
                                    </div>
                                    <div class="hi-right">
                                        <span class="status-badge ${statusClass}">${statusText}</span>
                                        <span class="expand-icon">‚ñº</span>
                                    </div>
                                </div>
                                <div class="history-item-body">${detailsHtml}</div>
                            `;
                            historyDiv.appendChild(item);
                        });
                    } else {
                        historyDiv.innerHTML = '<div class="empty-state"><div class="empty-icon">üìã</div><p>No reviews submitted yet.</p></div>';
                    }
                })
                .catch(() => {
                    historyDiv.innerHTML = '<div class="empty-state"><p style="color:red;">Error loading history.</p></div>';
                });
        }

        function toggleHistoryItem(id) {
            const el = document.getElementById(id);
            if (el) el.classList.toggle('open');
        }

        // ‚îÄ‚îÄ Clip History ‚îÄ‚îÄ
        function loadPastClips() {
            const historyDiv = document.getElementById('clip-history-content');
            historyDiv.innerHTML = '<div class="empty-state"><div class="empty-icon">‚è≥</div><p>Loading...</p></div>';

            if (!currentUserEmail) {
                historyDiv.innerHTML = '<div class="empty-state"><p style="color:red;">Session lost. Please logout and login again.</p></div>';
                return;
            }

            fetch(`${SCRIPT_URL}?action=getPastClips&email=${encodeURIComponent(currentUserEmail)}`)
                .then(r => r.json())
                .then(data => {
                    historyDiv.innerHTML = '';
                    if (data.status === 'success' && data.clips.length > 0) {
                        data.clips.forEach((c, idx) => {
                            const date = c.date ? new Date(c.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) : 'N/A';
                            const status = c.status || 'Submitted';
                            const statusKey = status.toLowerCase().replace(/\s+/g, '-');
                            const statusClass = statusKey === 'reviewed' ? 'status-reviewed' : statusKey === 'received' ? 'status-received' : 'status-submitted';
                            const borderClass = statusKey === 'reviewed' ? 'reviewed' : 'pending';
                            const hasAdminNotes = c.adminNotes && c.adminNotes.trim().length > 0;

                            const item = document.createElement('div');
                            item.className = `history-item ${borderClass}`;
                            item.id = `clip-item-${idx}`;

                            const discussionSection = hasAdminNotes ? `
                                <button class="discussion-btn" onclick="toggleDiscussion('clip-disc-${idx}', event)">üí¨ See Referee Discussion</button>
                                <div class="discussion-panel" id="clip-disc-${idx}">
                                    <div class="dp-label">Referee Discussion Notes</div>
                                    <p>${c.adminNotes}</p>
                                </div>` : '';

                            item.innerHTML = `
                                <div class="history-item-header" onclick="toggleHistoryItem('clip-item-${idx}')">
                                    <div class="hi-left">
                                        <strong>vs. ${c.opponent || 'Unknown'}</strong>
                                        <span>${date} ¬∑ ${c.level || ''}</span>
                                    </div>
                                    <div class="hi-right">
                                        <span class="status-badge ${statusClass}">${status}</span>
                                        <span class="expand-icon">‚ñº</span>
                                    </div>
                                </div>
                                <div class="history-item-body">
                                    <div class="detail-grid">
                                        <div class="detail-cell" style="grid-column:1/-1">
                                            <div class="dc-label">Clip Location</div>
                                            <div class="dc-value" style="font-size:0.85rem; font-weight:500; word-break:break-all;">${c.clipLocation || '‚Äî'}</div>
                                        </div>
                                        <div class="detail-cell" style="grid-column:1/-1">
                                            <div class="dc-label">Your Notes</div>
                                            <div class="dc-value" style="font-size:0.85rem; font-weight:500;">${c.notes || '‚Äî'}</div>
                                        </div>
                                    </div>
                                    ${discussionSection}
                                </div>
                            `;
                            historyDiv.appendChild(item);
                        });
                    } else {
                        historyDiv.innerHTML = '<div class="empty-state"><div class="empty-icon">üé¨</div><p>No clip submissions yet.</p></div>';
                    }
                })
                .catch(() => {
                    historyDiv.innerHTML = '<div class="empty-state"><p style="color:red;">Error loading clip submissions.</p></div>';
                });
        }

        function toggleDiscussion(id, event) {
            event.stopPropagation(); // don't collapse the row
            const el = document.getElementById(id);
            if (el) el.classList.toggle('open');
        }

        // ‚îÄ‚îÄ Clip Discussion ‚îÄ‚îÄ
        function submitClip() {
            const date = document.getElementById('clipDate').value;
            const level = document.getElementById('clipLevel').value;
            const opponent = document.getElementById('clipOpponent').value.trim();
            const location = document.getElementById('clipLocation').value.trim();
            const notes = document.getElementById('clipNotes').value.trim();
            const errDiv = document.getElementById('clip-error');

            errDiv.style.display = 'none';

            if (!date || !level || !opponent || !location) {
                errDiv.textContent = 'Please fill in all required fields (Date, Level, Opponent, and Clip Location).';
                errDiv.style.display = 'block'; return;
            }

            showModal('Submitting Clip...', 'Please wait...', '‚è≥', false);

            const payload = {
                type: 'clip_submission',
                coachEmail: currentUserEmail,
                coachName: `${currentUserData.firstName} ${currentUserData.lastName}`.trim(),
                coachSchool: currentUserData.school,
                date, level, opponent,
                clipLocation: location,
                notes
            };

            fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(payload) })
                .then(r => r.json())
                .then(data => {
                    if (data.status === 'success') {
                        showModal('Clip Submitted!', 'We received your clip and will provide feedback soon.', 'üé¨', true);
                        document.getElementById('clipDate').value = '';
                        document.getElementById('clipLevel').value = '';
                        document.getElementById('clipOpponent').value = '';
                        document.getElementById('clipLocation').value = '';
                        document.getElementById('clipNotes').value = '';
                        showCardGrid();
                    } else {
                        closeModal();
                        errDiv.textContent = data.message || 'Submission failed.';
                        errDiv.style.display = 'block';
                    }
                })
                .catch(err => {
                    closeModal();
                    errDiv.textContent = 'Error: ' + err.toString();
                    errDiv.style.display = 'block';
                });
        }
    </script>
</body>

</html>